<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="mysql," />





  <link rel="alternate" href="/atom.xml" title="是五月呀！" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。 即要达到这么一种效果：对于任意两个并发的事务T1和T2，在事务T1看来，T2要么在T1开始之前就已经结束，要么在T1结束之后才开始，这样每个事务都感觉不到有其他事务在并发地执行。">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="事务隔离性">
<meta property="og:url" content="https://damon4u.github.io/blog/2018/08/事务隔离性.html">
<meta property="og:site_name" content="是五月呀！">
<meta property="og:description" content="隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。 即要达到这么一种效果：对于任意两个并发的事务T1和T2，在事务T1看来，T2要么在T1开始之前就已经结束，要么在T1结束之后才开始，这样每个事务都感觉不到有其他事务在并发地执行。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-08-14T13:48:18.070Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="事务隔离性">
<meta name="twitter:description" content="隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。 即要达到这么一种效果：对于任意两个并发的事务T1和T2，在事务T1看来，T2要么在T1开始之前就已经结束，要么在T1结束之后才开始，这样每个事务都感觉不到有其他事务在并发地执行。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://damon4u.github.io/blog/2018/08/事务隔离性.html"/>





  <title> 事务隔离性 | 是五月呀！ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta custom-logo">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">是五月呀！</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description"></h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://damon4u.github.io/blog/2018/08/事务隔离性.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="五月y">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar2.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="是五月呀！">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="是五月呀！" src="/images/avatar2.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                事务隔离性
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-14T16:41:50+08:00">
                2018-08-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          


         <span class="post-time">
         <span class="post-meta-divider">|</span>
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">字数统计:</span>
           <span class="post-count">2,091(字)</span>

         </span>

         <span class="post-time">
         <span class="post-meta-divider">|</span>
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">阅读时长:</span>
           <span class="post-count">9(分)</span>
         </span>

          

          




        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。</p>
<p>即要达到这么一种效果：对于任意两个并发的事务T1和T2，在事务T1看来，T2要么在T1开始之前就已经结束，要么在T1结束之后才开始，这样每个事务都感觉不到有其他事务在并发地执行。</p>
<a id="more"></a>
<h3 id="1-四种隔离级别"><a href="#1-四种隔离级别" class="headerlink" title="1. 四种隔离级别"></a>1. 四种隔离级别</h3><p>MySQL/InnoDB提供SQL标准所描述的所有四个事务隔离级别：</p>
<ul>
<li>未提交读(Read Uncommitted)：允许脏读，也就是可能读取到其他会话中未提交事务修改的数据</li>
<li>提交读(Read Committed)：只能读取到已经提交的数据。Oracle等多数数据库默认都是该级别 (不重复读)</li>
<li>可重复读(Repeated Read)：可重复读。在同一个事务内的查询都是事务开始时刻一致的，<strong>InnoDB默认级别</strong>。在SQL标准中，该隔离级别消除了不可重复读，但是还存在幻象读</li>
<li>串行读(Serializable)：完全串行化的读，每次读都需要获得表级共享锁，读写相互都会阻塞</li>
</ul>
<p>按照SQL:1992 事务隔离级别，InnoDB默认是可重复读的（REPEATABLE READ）。</p>
<h3 id="2-设置和查看mysql的隔离级别"><a href="#2-设置和查看mysql的隔离级别" class="headerlink" title="2. 设置和查看mysql的隔离级别"></a>2. 设置和查看mysql的隔离级别</h3><p>可以在命令行用–transaction-isolation选项，或在选项文件里，为所有连接设置默认隔离级别。</p>
<p>例如，可以在my.inf文件的[mysqld]节里类似如下设置该选项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">transaction-isolation = &#123;READ-UNCOMMITTED | READ-COMMITTED | REPEATABLE-READ | SERIALIZABLE&#125;</div></pre></td></tr></table></figure></p>
<p>用户可以用SET TRANSACTION语句改变单个会话或者所有新进连接的隔离级别。它的语法如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> [<span class="keyword">SESSION</span> | <span class="keyword">GLOBAL</span>] <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> &#123;<span class="keyword">READ</span> UNCOMMITTED | <span class="keyword">READ</span> COMMITTED | REPEATABLE <span class="keyword">READ</span> | <span class="keyword">SERIALIZABLE</span>&#125;</div></pre></td></tr></table></figure></p>
<p>注意：默认的行为（不带session和global）是为下一个（未开始）事务设置隔离级别。如果你使用GLOBAL关键字，语句在全局对从那点开始创建的所有新连接（除了不存在的连接）设置默认事务级别。你需要SUPER权限来做这个。使用SESSION 关键字为将来在当前连接上执行的事务设置默认事务级别。 任何客户端都能自由改变会话隔离级别（甚至在事务的中间），或者为下一个事务设置隔离级别。</p>
<p>可以用下列语句查询全局和会话事务隔离级别：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> @@global.tx_isolation;</div><div class="line"><span class="keyword">SELECT</span> @@session.tx_isolation;</div><div class="line"><span class="keyword">SELECT</span> @@tx_isolation;</div></pre></td></tr></table></figure></p>
<h3 id="3-事务隔离性相关的问题"><a href="#3-事务隔离性相关的问题" class="headerlink" title="3. 事务隔离性相关的问题"></a>3. 事务隔离性相关的问题</h3><h4 id="3-1-脏读"><a href="#3-1-脏读" class="headerlink" title="3.1 脏读"></a>3.1 脏读</h4><p>脏读是指在一个事务处理过程里读取了另一个未提交的事务中的数据。<br>当一个事务正在多次修改某个数据，而在这个事务中这多次的修改都还未提交，这时一个并发的事务来访问该数据，就会造成两个事务得到的数据不一致。<br>session 1:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select @@global.tx_isolation;</div><div class="line">+<span class="comment">-----------------------+</span></div><div class="line">| @@global.tx_isolation |</div><div class="line">+<span class="comment">-----------------------+</span></div><div class="line">| REPEATABLE-READ       |</div><div class="line">+<span class="comment">-----------------------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">select</span> @@session.tx_isolation;</div><div class="line">+<span class="comment">-----------------------+</span></div><div class="line">| @@session.tx_isolation |</div><div class="line">+<span class="comment">-----------------------+</span></div><div class="line">| REPEATABLE-READ       |</div><div class="line">+<span class="comment">-----------------------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">start</span> <span class="keyword">transaction</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; insert into ttd values(1);</div><div class="line">Query OK, 1 row affected (0.05 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from ttd;</div><div class="line">+<span class="comment">------+</span></div><div class="line">| id   |</div><div class="line">+<span class="comment">------+</span></div><div class="line">|    1 |</div><div class="line">+<span class="comment">------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure></p>
<p>session 2:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select @@session.tx_isolation;</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| @@session.tx_isolation |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| REPEATABLE-READ        |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">select</span> @@global.tx_isolation;</div><div class="line">+<span class="comment">-----------------------+</span></div><div class="line">| @@global.tx_isolation |</div><div class="line">+<span class="comment">-----------------------+</span></div><div class="line">| REPEATABLE-READ   |        <span class="comment">--------该隔离级别下(除了 read uncommitted)</span></div><div class="line">+<span class="comment">-----------------------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">select</span> * <span class="keyword">from</span> ttd;</div><div class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)         <span class="comment">--------不会出现脏读</span></div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">set</span> <span class="keyword">session</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">read</span> uncommitted;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select @@session.tx_isolation;</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| @@session.tx_isolation |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| READ-UNCOMMITTED       |   <span class="comment">--------该隔离级别下</span></div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">select</span> * <span class="keyword">from</span> ttd;</div><div class="line">+<span class="comment">------+</span></div><div class="line">| id   |</div><div class="line">+<span class="comment">------+</span></div><div class="line">|    1 |                     <span class="comment">--------出现脏读</span></div><div class="line"></div><div class="line">+<span class="comment">------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure></p>
<p>结论:session 2 在READ-UNCOMMITTED 下读取到session 1 中未提交事务修改的数据.</p>
<h4 id="3-2-不可重复读"><a href="#3-2-不可重复读" class="headerlink" title="3.2 不可重复读"></a>3.2 不可重复读</h4><p>是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样就发生了在一个事务内两次读到的数据是不一样的，因此称为是不可重复读。<br>不可重复读和脏读的区别是，脏读是某一事务读取了另一个事务未提交的脏数据，而不可重复读则是读取了前一事务提交的数据。<br>session 1:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select @@session.tx_isolation;</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| @@session.tx_isolation |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| READ-COMMITTED         |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">start</span> <span class="keyword">transaction</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from ttd;</div><div class="line">+<span class="comment">------+</span></div><div class="line">| id   |</div><div class="line">+<span class="comment">------+</span></div><div class="line">|    1 |</div><div class="line">+<span class="comment">------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure></p>
<p>session 2 :<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select @@session.tx_isolation;</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| @@session.tx_isolation |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| REPEATABLE-READ        |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">start</span> <span class="keyword">transaction</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from ttd;</div><div class="line">+<span class="comment">------+</span></div><div class="line">| id   |</div><div class="line">+<span class="comment">------+</span></div><div class="line">|    1 |</div><div class="line">+<span class="comment">------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">insert</span> <span class="keyword">into</span> ttd <span class="keyword">values</span>(<span class="number">2</span>);  <span class="comment">------也可以更新数据</span></div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from ttd;</div><div class="line">+<span class="comment">------+</span></div><div class="line">| id   |</div><div class="line">+<span class="comment">------+</span></div><div class="line">|    1 |</div><div class="line">|    2 |</div><div class="line">+<span class="comment">------+</span></div><div class="line">rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">commit</span>;</div><div class="line">Query OK, 0 rows affected (0.02 sec)</div></pre></td></tr></table></figure></p>
<p>session 2 提交后,查看session 1 的结果;</p>
<p>session 1:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from ttd;</div><div class="line">+<span class="comment">------+</span></div><div class="line">| id   |</div><div class="line">+<span class="comment">------+</span></div><div class="line">|    1 |                          <span class="comment">--------和第一次的结果不一样,READ-COMMITTED 级别出现了不重复读</span></div><div class="line">|    2 |</div><div class="line">+<span class="comment">------+</span></div><div class="line">rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure></p>
<h4 id="3-3-可重复读"><a href="#3-3-可重复读" class="headerlink" title="3.3 可重复读"></a>3.3 可重复读</h4><p>session 1:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select @@session.tx_isolation;</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| @@session.tx_isolation |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| REPEATABLE-READ        |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">start</span> <span class="keyword">transaction</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from ttd;</div><div class="line">+<span class="comment">------+</span></div><div class="line">| id   |</div><div class="line">+<span class="comment">------+</span></div><div class="line">|    1 |</div><div class="line">|    2 |</div><div class="line">+<span class="comment">------+</span></div><div class="line">rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure></p>
<p>session 2 :<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select @@session.tx_isolation;</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| @@session.tx_isolation |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">| REPEATABLE-READ        |</div><div class="line">+<span class="comment">------------------------+</span></div><div class="line">row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; <span class="keyword">start</span> <span class="keyword">transaction</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; insert into ttd values(3);</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; commit;</div><div class="line">Query OK, 0 rows affected (0.03 sec)</div></pre></td></tr></table></figure></p>
<p>session 2 提交后,查看session 1 的结果;</p>
<p>session 1:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from ttd;</div><div class="line">+<span class="comment">------+</span></div><div class="line">| id   |</div><div class="line">+<span class="comment">------+</span></div><div class="line">|    1 |    <span class="comment">--------和第一次的结果一样,REPEATABLE-READ级别没出现重复读</span></div><div class="line">|    2 |</div><div class="line">+<span class="comment">------+</span></div><div class="line">rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">(<span class="keyword">commit</span> <span class="keyword">session</span> <span class="number">1</span> 之后 再<span class="keyword">select</span> * <span class="keyword">from</span> ttd 可以看到<span class="keyword">session</span> <span class="number">2</span> 插入的数据<span class="number">3</span>)</div></pre></td></tr></table></figure></p>
<h4 id="3-4-幻读"><a href="#3-4-幻读" class="headerlink" title="3.4 幻读"></a>3.4 幻读</h4><p>第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象发生了幻觉一样。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt;CREATE TABLE `t_bitfly` (</div><div class="line">`id` bigint(20) NOT NULL default '0',</div><div class="line">`value` varchar(32) default NULL,</div><div class="line">PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB</div><div class="line"></div><div class="line">mysql&gt; select @@global.tx_isolation, @@tx_isolation;</div><div class="line">+<span class="comment">-----------------------+-----------------+</span></div><div class="line">| @@global.tx_isolation | @@tx_isolation  |</div><div class="line">+<span class="comment">-----------------------+-----------------+</span></div><div class="line">| REPEATABLE-READ       | REPEATABLE-READ |</div><div class="line">+<span class="comment">-----------------------+-----------------+</span></div></pre></td></tr></table></figure>
<p>实验一：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">t Session A                   Session B</div><div class="line">|</div><div class="line">| <span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;          <span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</div><div class="line">|</div><div class="line">| <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_bitfly;</div><div class="line">| empty <span class="keyword">set</span></div><div class="line">|                             <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_bitfly</div><div class="line">|                             <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'a'</span>);</div><div class="line">|</div><div class="line">| <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_bitfly;</div><div class="line">| empty <span class="keyword">set</span></div><div class="line">|                             <span class="keyword">COMMIT</span>;</div><div class="line">|</div><div class="line">| <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_bitfly;</div><div class="line">| empty <span class="keyword">set</span></div><div class="line">|</div><div class="line">| <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_bitfly <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'a'</span>);</div><div class="line">| ERROR 1062 (23000):</div><div class="line">| Duplicate entry '1' for key 1</div><div class="line">v (shit, 刚刚明明告诉我没有这条记录的)</div></pre></td></tr></table></figure></p>
<p>如此就出现了幻读，以为表里没有数据，其实数据已经存在了，傻乎乎的提交后，才发现数据冲突了。</p>
<p>实验二：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">t Session A                  Session B</div><div class="line">|</div><div class="line">| <span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;         <span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</div><div class="line">|</div><div class="line">| <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_bitfly;</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">| | id   | value |</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">| |    1 | a     |</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">|                            <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_bitfly</div><div class="line">|                            <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'b'</span>);</div><div class="line">|</div><div class="line">| <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_bitfly;</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">| | id   | value |</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">| |    1 | a     |</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">|                            <span class="keyword">COMMIT</span>;</div><div class="line">|</div><div class="line">| <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_bitfly;</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">| | id   | value |</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">| |    1 | a     |</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">|</div><div class="line">| <span class="keyword">UPDATE</span> t_bitfly <span class="keyword">SET</span> <span class="keyword">value</span>=<span class="string">'z'</span>;</div><div class="line">| Rows matched: 2  Changed: 2  Warnings: 0</div><div class="line">| (怎么多出来一行)</div><div class="line">|</div><div class="line">| <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_bitfly;</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">| | id   | value |</div><div class="line">| +<span class="comment">------+-------+</span></div><div class="line">| |    1 | z     |</div><div class="line">| |    2 | z     |</div><div class="line">| +<span class="comment">------+-------+</span></div></pre></td></tr></table></figure></p>
<p>本事务中第一次读取出一行，做了一次更新后，另一个事务里提交的数据就出现了。也可以看做是一种幻读。<br><strong>当隔离级别是可重复读，且禁用innodb_locks_unsafe_for_binlog的情况下，在搜索和扫描index的时候使用的next-key locks可以避免幻读。</strong></p>
<h3 id="4-生产环境遇到的问题"><a href="#4-生产环境遇到的问题" class="headerlink" title="4. 生产环境遇到的问题"></a>4. 生产环境遇到的问题</h3><h4 id="4-1-事务未提交导致数据读取失败"><a href="#4-1-事务未提交导致数据读取失败" class="headerlink" title="4.1 事务未提交导致数据读取失败"></a>4.1 事务未提交导致数据读取失败</h4><p>背景：项目做了读写分离，事务标注的方法会使用主库进行写操作。项目中将缓存管理抽离出来，例如UserManager，其中使用单独的读库配置来加载数据到缓存。<br>在用户注册逻辑中，最外层有事务注解：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String userName)</span> </span>&#123;</div><div class="line">  <span class="comment">// 1. 保存到数据库中</span></div><div class="line">  userDao.save(userName);</div><div class="line">  <span class="comment">// 2. 预热缓存，并从缓存中读取数据，这里读取到的user未空</span></div><div class="line">  User user = userManager.get(userName);</div><div class="line">  <span class="comment">// 3. 使用user，报错NPE</span></div><div class="line">  user.getUserName();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>方法使用事务注解，将使用主库进行数据写操作。当事务还没有被提交时，userManager尝试读取从库中的数据到缓存，是读取不到的。</p>

      
    </div>

    <div>
      
        

      
    </div>
  
        <div class="post-tags">
          
            <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
          
        </div>
      


    <footer class="post-footer">

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2018/08/貂蝉.html" rel="next" title="貂蝉">
                <i class="fa fa-chevron-left"></i> 貂蝉
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2018/08/maven版本控制插件.html" rel="prev" title="maven版本控制插件">
                maven版本控制插件 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar2.jpg"
               alt="五月y" />
          <p class="site-author-name" itemprop="name">五月y</p>
          <p class="site-description motion-element" itemprop="description">Hello 五月y!</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">43</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/damon4u" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/damon4u" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/damon4u" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-battery-3"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-四种隔离级别"><span class="nav-number">1.</span> <span class="nav-text">1. 四种隔离级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-设置和查看mysql的隔离级别"><span class="nav-number">2.</span> <span class="nav-text">2. 设置和查看mysql的隔离级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-事务隔离性相关的问题"><span class="nav-number">3.</span> <span class="nav-text">3. 事务隔离性相关的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-脏读"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 脏读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-不可重复读"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 不可重复读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-可重复读"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 可重复读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-幻读"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 幻读</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-生产环境遇到的问题"><span class="nav-number">4.</span> <span class="nav-text">4. 生产环境遇到的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-事务未提交导致数据读取失败"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 事务未提交导致数据读取失败</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">五月y</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>
</div>





        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>

  
  <script type="text/javascript" src="/vendors/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


  <!-- 页面点击小红心 -->
  <!-- <script type="text/javascript" src="/js/src/love.js"></script>
  -->
  <!-- 动态线条背景 http://shenzekun.cn/hexo%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0%E5%8A%A8%E6%80%81%E8%83%8C%E6%99%AF.html -->
  <!--
    <script type="text/javascript" color="0,0,0" opacity='0.9' zIndex="-2" count="50" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
  -->
</body>
</html>
