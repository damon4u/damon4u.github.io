<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="spring,java," />





  <link rel="alternate" href="/atom.xml" title="是五月呀！" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="1. 初衷作为云音乐的死忠用户，在大量版权丢失的情况下，依然坚守阵地，除了对UI的喜欢，还有就是歌曲下面精彩的评论信息了。翻过很多热评后，就想把这些数据抓取下来。有了数据，就可以做数据分析。">
<meta name="keywords" content="spring,java">
<meta property="og:type" content="article">
<meta property="og:title" content="云音乐抓取">
<meta property="og:url" content="https://damon4u.github.io/blog/2018/09/云音乐抓取.html">
<meta property="og:site_name" content="是五月呀！">
<meta property="og:description" content="1. 初衷作为云音乐的死忠用户，在大量版权丢失的情况下，依然坚守阵地，除了对UI的喜欢，还有就是歌曲下面精彩的评论信息了。翻过很多热评后，就想把这些数据抓取下来。有了数据，就可以做数据分析。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-09-27T13:12:14.992Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="云音乐抓取">
<meta name="twitter:description" content="1. 初衷作为云音乐的死忠用户，在大量版权丢失的情况下，依然坚守阵地，除了对UI的喜欢，还有就是歌曲下面精彩的评论信息了。翻过很多热评后，就想把这些数据抓取下来。有了数据，就可以做数据分析。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://damon4u.github.io/blog/2018/09/云音乐抓取.html"/>





  <title> 云音乐抓取 | 是五月呀！ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta custom-logo">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">是五月呀！</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description"></h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://damon4u.github.io/blog/2018/09/云音乐抓取.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="五月y">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar2.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="是五月呀！">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="是五月呀！" src="/images/avatar2.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                云音乐抓取
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-21T16:41:50+08:00">
                2018-09-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          


         <span class="post-time">
         <span class="post-meta-divider">|</span>
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">字数统计:</span>
           <span class="post-count">4,001(字)</span>

         </span>

         <span class="post-time">
         <span class="post-meta-divider">|</span>
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">阅读时长:</span>
           <span class="post-count">19(分)</span>
         </span>

          

          




        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="1-初衷"><a href="#1-初衷" class="headerlink" title="1. 初衷"></a>1. 初衷</h3><p>作为云音乐的死忠用户，在大量版权丢失的情况下，依然坚守阵地，除了对UI的喜欢，还有就是歌曲下面精彩的评论信息了。<br>翻过很多热评后，就想把这些数据抓取下来。有了数据，就可以做数据分析。</p>
<a id="more"></a>
<h3 id="2-探索抓取方案"><a href="#2-探索抓取方案" class="headerlink" title="2.探索抓取方案"></a>2.探索抓取方案</h3><p>我感兴趣的数据包括歌曲信息、用户信息和评论信息。<br>在web端搜索一首歌曲，例如女友喜欢的《umbrella》：<a href="http://music.163.com/song?id=21563094" target="_blank" rel="external">http://music.163.com/song?id=21563094</a><br>打开开发者选项，抓一下这个接口的返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">    &lt;head&gt;</div><div class="line">        &lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">        &lt;meta name=&quot;baidu-site-verification&quot; content=&quot;cNhJHKEzsD&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;qc:admins&quot; content=&quot;27354635321361636375&quot; /&gt;</div><div class="line">        &lt;link rel=&quot;canonical&quot; href=&quot;https://music.163.com/song?id=21563094&quot;&gt;</div><div class="line">        &lt;meta name=&quot;applicable-device&quot; content=&quot;pc&quot;&gt;</div><div class="line">        &lt;link rel=&quot;alternate&quot; media=&quot;only screen and (max-width: 640px)&quot; href=&quot;https://music.163.com/m/song?id=21563094&quot;&gt;</div><div class="line">        &lt;meta name=&quot;mobile-agent&quot; content=&quot;format=html5;url=https://music.163.com/m/song?id=21563094&quot;&gt;</div><div class="line">        &lt;title&gt;Umbrella - Rihanna/Jay-Z - 单曲 - 网易云音乐&lt;/title&gt;</div><div class="line">        &lt;meta name=&quot;keywords&quot; content=&quot;Umbrella，Good Girl Gone Bad: Reloaded，Rihanna，Jay-Z&quot; /&gt;</div><div class="line">        &lt;meta name=&quot;description&quot; content=&quot;歌手：Rihanna，Jay-Z。所属专辑：Good Girl Gone Bad: Reloaded。&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;og:title&quot; content=&quot;Umbrella - Rihanna/Jay-Z - 单曲 - 网易云音乐&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;og:type&quot; content=&quot;music.song&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;og:image&quot; content=&quot;http://p1.music.126.net/cSVFVXAwbx-UITEYuW2OCQ==/18923694625892133.jpg&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;og:url&quot; content=&quot;https://music.163.com/song?id=21563094&quot; /&gt;</div><div class="line">        &lt;script type=&quot;application/ld+json&quot;&gt;</div><div class="line">&#123;</div><div class="line">&quot;@context&quot;: &quot;https://ziyuan.baidu.com/contexts/cambrian.jsonld&quot;,</div><div class="line">&quot;@id&quot;: &quot;http://music.163.com/song?id=21563094&quot;,</div><div class="line">&quot;appid&quot;: &quot;1582028769404989&quot;,</div><div class="line">&quot;title&quot;: &quot;Umbrella&quot;,</div><div class="line">&quot;images&quot;: [&quot;http://p1.music.126.net/cSVFVXAwbx-UITEYuW2OCQ==/18923694625892133.jpg&quot;],</div><div class="line">&quot;description&quot;: &quot;歌手：Rihanna，Jay-Z。所属专辑：Good Girl Gone Bad: Reloaded。&quot;,</div><div class="line">&quot;pubDate&quot;: &quot;2008-06-01T00:00:00&quot;</div><div class="line">&#125;</div><div class="line">&lt;!-- ... --&gt;</div></pre></td></tr></table></figure></p>
<p>这个静态页面包含了我们需要的歌曲信息：歌曲名称，歌手名称，简单描述，封面等。</p>
<p>过滤一下<code>comment</code>关键字，可以抓到评论接口：<br><a href="http://music.163.com/weapi/v1/resource/comments/R_SO_4_21563094?csrf_token=" target="_blank" rel="external">http://music.163.com/weapi/v1/resource/comments/R_SO_4_21563094?csrf_token=</a><br>观察下这个请求url，发现是<br><a href="http://music.163.com/weapi/v1/resource/comments/R_SO_4_{songId}?csrf_token=" target="_blank" rel="external">http://music.163.com/weapi/v1/resource/comments/R_SO_4_{songId}?csrf_token=</a><br>的规则。<br>但是直接发POST请求拿不到数据，说明这个接口做了权限校验。<br>继续分析这个接口的请求参数，发现Form Data中带了两个参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">params: Tt0vzJun80fPMcJdTIQZjECkfD19yB+85n1n/yHPlpMyRMftbmFja0AccgQjzjJwVBCs/2P8Rv3G2twaIXyxcHHTPinf+r+W3My26Ig+7u4+MFHlt2da1t1mEqXDQFDLRMgQGBrHJ3SQwyL82t+FTpjoVRGVlIKUqT5+k/w9oFoPpCyLzICLhbdK+dHANH6g</div><div class="line">encSecKey: 465fd8f7c29de467d6396e88b8b77d42971cb85134f8da7622925823019ab6774dc4b1cf6da9d39c063cb492e01349ae5801946700bc981b83cd5cddf66229ce794b63b8be99b7e47a88f415f412c6a5bf561a84b4cefb63b9571e05209e024b1e2dea08cbf9d299d11770682fc1f17117c612e0d113a26175f88b2a661bfc32</div></pre></td></tr></table></figure></p>
<p>我们也加上两个表单参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -X POST \</div><div class="line">  &apos;http://music.163.com/weapi/v1/resource/comments/R_SO_4_21563094/?csrf_token=&apos; \</div><div class="line">  -H &apos;Content-Type: application/x-www-form-urlencoded&apos; \</div><div class="line">  -d &apos;params=idbuC%2BeyC4tyaC8O0b17iPmu76ES3ExK4xUyvEcqLUc4ky04AGkMkKd8Agp1Z46Vh3TMCZUc4aqHdMaQ7MyYj2jzr2v3irkRTalDwLf5Hu4%2B3FrujioedL5Crw8a2G9rcV%2BjdUm7JkZbZ6ubRTl4QlRT2OjNj7DjcBj%2B5nKgH6Z2rGQzoL8XO5HAVED4uRBB&amp;encSecKey=a889c30bc037e06c3cb96d2f694bdec265cda483db3b551d72c9c30d2eb5ee7fac6848cb295fcde522ba0b0ed709ca5f28638353016bad5b4224a76517f2776a8d1bea8e2a9318625b41c73e2aece423e0846bcd54093032287185b1f618fe39163f8df49939abac3f5ae8ebcea87cda6e921b9ba41e0ed33f492b1624a48a92&apos;</div></pre></td></tr></table></figure></p>
<p>返回结果结构如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"isMusician"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">"userId"</span>: <span class="number">-1</span>,</div><div class="line">    <span class="attr">"topComments"</span>: [],</div><div class="line">    <span class="attr">"moreHot"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"hotComments"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"user"</span>: &#123;</div><div class="line">                <span class="attr">"locationInfo"</span>: <span class="literal">null</span>,</div><div class="line">                <span class="attr">"vipRights"</span>: &#123;</div><div class="line">                    <span class="attr">"musicPackage"</span>: &#123;</div><div class="line">                        <span class="attr">"vipCode"</span>: <span class="number">200</span>,</div><div class="line">                        <span class="attr">"rights"</span>: <span class="literal">true</span></div><div class="line">                    &#125;</div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"userId"</span>: <span class="number">51494587</span>,</div><div class="line">                <span class="attr">"nickname"</span>: <span class="string">"FireBurning_JASON"</span>,</div><div class="line">                <span class="attr">"expertTags"</span>: <span class="literal">null</span>,</div><div class="line">                <span class="attr">"userType"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"authStatus"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"remarkName"</span>: <span class="literal">null</span>,</div><div class="line">                <span class="attr">"avatarUrl"</span>: <span class="string">"http://p1.music.126.net/8c28fFk1Yqml-CCulWzioA==/7806532557388357.jpg"</span>,</div><div class="line">                <span class="attr">"experts"</span>: <span class="literal">null</span>,</div><div class="line">                <span class="attr">"vipType"</span>: <span class="number">10</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"beReplied"</span>: [],</div><div class="line">            <span class="attr">"pendantData"</span>: <span class="literal">null</span>,</div><div class="line">            <span class="attr">"expressionUrl"</span>: <span class="literal">null</span>,</div><div class="line">            <span class="attr">"time"</span>: <span class="number">1424242903947</span>,</div><div class="line">            <span class="attr">"liked"</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">"likedCount"</span>: <span class="number">14377</span>,</div><div class="line">            <span class="attr">"commentId"</span>: <span class="number">11007152</span>,</div><div class="line">            <span class="attr">"content"</span>: <span class="string">"应该说这首歌才是rir的巅峰吧，然后就一直在巅峰"</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="attr">"total"</span>: <span class="number">6935</span>,</div><div class="line">    <span class="attr">"more"</span>: <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个接口就包含我感兴趣的热门评论信息和用户信息。<br>对于简单抓取，这两个接口已经满足我的需求。如果想抓取全部评论，包含分页数据，那么需要分析云音乐的加密算法，其实在混淆后的JS中都有，有专门的文章分析，这里不做过多解释。</p>
<h3 id="3-代理IP池"><a href="#3-代理IP池" class="headerlink" title="3. 代理IP池"></a>3. 代理IP池</h3><p>有了接口，就可以写代码发送http请求遍历songId进行数据抓取了。<br>但是云音乐做了防刷处理，抓取几万条数据后，开始接口报错，被封了IP。<br>于是想要维护一个代理IP池，每次抓取时从池子中拿一个代理IP进行接口调用，防止IP封禁。</p>
<h4 id="3-1-代理IP"><a href="#3-1-代理IP" class="headerlink" title="3.1 代理IP"></a>3.1 代理IP</h4><p>来源：可以从淘宝上面买，可以从免费网站抓取。<br>分类：根据匿名程度，可以分为高匿，普通和透明。高匿的代理ip可以屏蔽掉真实IP，目标服务器完全不能感觉到代理IP的存在；普通代理ip能隐藏真实IP，但是目标服务器能感受到代理IP的存在；透明代理IP不能隐藏真实IP。</p>
<h4 id="3-2-免费代理IP池"><a href="#3-2-免费代理IP池" class="headerlink" title="3.2 免费代理IP池"></a>3.2 免费代理IP池</h4><p>搜索一下代理IP，能找到大量网站提供一些免费代理IP，质量参差不齐，站越大，用的人越多，质量越差。<br>于是搭建免费代理IP池包含两个步骤：<br>（1）从免费代理IP网站抓取代理IP列表<br>（2）验证代理IP可用性<br>不同的代理IP网站抓取和解析的过程也不尽相同，但是不难。<br>验证过程就是使用抓取来的代理IP访问常用网站或者目标网站，如果可用则保留，不可用则丢弃。</p>
<h3 id="4-实现"><a href="#4-实现" class="headerlink" title="4. 实现"></a>4. 实现</h3><h4 id="4-1-配置文件读取"><a href="#4-1-配置文件读取" class="headerlink" title="4.1 配置文件读取"></a>4.1 配置文件读取</h4><p>项目中使用三个自定义配置参数：请求代理IP列表超时时间，代理IP验证超时时间和真正请求歌曲信息接口超时时间。<br><code>application.yml</code>中配置如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">app:</span></div><div class="line"><span class="attr">  http:</span></div><div class="line"><span class="attr">    proxyLoadTimeout:</span> <span class="number">10</span></div><div class="line"><span class="attr">    proxyValidateTimeout:</span> <span class="number">8</span></div><div class="line"><span class="attr">    songLoadTimeout:</span> <span class="number">15</span></div></pre></td></tr></table></figure></p>
<p>这里使用<code>ConfigurationProperties</code>注解读取<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Description:</span></div><div class="line"><span class="comment"> * http配置参数</span></div><div class="line"><span class="comment"> * 修改此类需要maven重新编译，yml里面才能有提示</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> damon4u</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@ConfigurationProperties</span>(<span class="string">"app.http"</span>)</div><div class="line"><span class="meta">@Data</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyLoadTimeout;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyValidateTimeout;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> songLoadTimeout;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为了能够在yml配置文件中提示自定义参数，需要引入<code>spring-boot-configuration-processor</code>:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意每次修改<code>HttpConfig</code>都需要重新maven编译，yml里面才能有提示。</p>
<h4 id="4-2-使用普通http请求获取动态IP"><a href="#4-2-使用普通http请求获取动态IP" class="headerlink" title="4.2 使用普通http请求获取动态IP"></a>4.2 使用普通http请求获取动态IP</h4><p>网络请求层使用OKHttp + Retrofit2框架。<br>Retrofit2本身是对OKHttp网络请求工具的封装实现，可以方便进行各类HTTP方法请求，对请求参数和返回值进行类型转换。<br>首先引入maven依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- retrofit start --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>retrofit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>converter-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>converter-scalars<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- retrofit end --&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>retrofit</code>是核心包，<code>converter-jackson</code>和<code>converter-scalars</code>是两个返回值类型转换器，分别对json和普通类型（如string）的返回值进行转换。</p>
<p>获取动态IP的接口为：<code>https://raw.githubusercontent.com/stamparm/aux/master/fetch-some-list.txt</code><br>返回结果为：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"proto"</span>: <span class="string">"http"</span>,</div><div class="line">    <span class="attr">"ip"</span>: <span class="string">"176.62.180.209"</span>,</div><div class="line">    <span class="attr">"country"</span>: <span class="string">"Russian Federation"</span>,</div><div class="line">    <span class="attr">"anonymity"</span>: <span class="string">"high"</span>,</div><div class="line">    <span class="attr">"type"</span>: <span class="string">"elite"</span>,</div><div class="line">    <span class="attr">"port"</span>: <span class="number">63909</span></div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>对于代理IP，统一封装成一个 <code>Proxy</code>实体类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Data</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 主键id</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ip地址或者域名</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String ip;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 端口号</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 协议http、https、socks4等</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String proto;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span><span class="params">(String ip, <span class="keyword">int</span> port, String proto)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ip = ip;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">this</span>.proto = proto.toLowerCase();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> proto + <span class="string">"://"</span> + ip + <span class="string">":"</span> + port;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先我们封装一个请求client接口，专门负责发起<code>https://raw.githubusercontent.com/</code>域名下的请求，当然，这里我们只有一个普通的GET请求。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitProxyClient</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取代理IP列表</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@GET</span>(<span class="string">"/stamparm/aux/master/fetch-some-list.txt"</span>)</div><div class="line">    Call&lt;List&lt;Proxy&gt;&gt; loadProxy();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>之后，需要想Spring容器注入bean：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@Data</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * 网络配置参数</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpConfig httpConfig;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpClientFactory</span><span class="params">(HttpConfig httpConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.httpConfig = httpConfig;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">okHttpClient</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">                .addInterceptor(<span class="keyword">new</span> HttpHeaderInterceptor())</div><div class="line">                .connectTimeout(httpConfig.getProxyLoadTimeout(), TimeUnit.SECONDS)</div><div class="line">                .readTimeout(httpConfig.getProxyLoadTimeout(), TimeUnit.SECONDS).build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> GitProxyClient <span class="title">gitProxyClient</span><span class="params">()</span> </span>&#123;</div><div class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">        <span class="comment">//设置输入时忽略在JSON字符串中存在但Java对象实际没有的属性</span></div><div class="line">        mapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                .addConverterFactory(JacksonConverterFactory.create(mapper))</div><div class="line">                .baseUrl(<span class="string">"https://raw.githubusercontent.com/"</span>)</div><div class="line">                .client(okHttpClient())</div><div class="line">                .build().create(GitProxyClient.class);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>HttpClientFactory</code>先注册一个<code>OkHttpClient</code>bean，设置了超时时间和拦截器，这个请求并不需要设置代理IP。<br>其中<code>HttpHeaderInterceptor</code>很简单，只是添加一些公共头信息，包括一个随机UA：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpHeaderInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        Request request = chain.request();</div><div class="line">        Request.Builder builder = request.newBuilder();</div><div class="line">        builder.addHeader(<span class="string">"User-Agent"</span>, UAPool.getUA()); <span class="comment">// 写死一个UA池子，每次随机拿一个，这里就不贴了</span></div><div class="line">        builder.addHeader(<span class="string">"Connection"</span>, <span class="string">"keep-alive"</span>);</div><div class="line">        <span class="keyword">return</span> chain.proceed(builder.build());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>之后注册一个<code>GitProxyClient</code>bean，定制了Jackson反序列化时使用的<code>ObjectMapper</code>，设置了该client的基础域名。<br>接下来就可以使用gitProxyClient发起请求获取动态IP列表了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyLoader</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> GitProxyClient gitProxyClient;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadFromGit</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// 请求</span></div><div class="line">        Response&lt;List&lt;Proxy&gt;&gt; response = gitProxyClient.loadProxy().execute();</div><div class="line">        List&lt;Proxy&gt; proxyList = response.body();</div><div class="line">        <span class="comment">// 过滤</span></div><div class="line">        filterProxy(proxyList);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-3-过滤抓取来的代理IP"><a href="#4-3-过滤抓取来的代理IP" class="headerlink" title="4.3 过滤抓取来的代理IP"></a>4.3 过滤抓取来的代理IP</h4><p>从网上抓取来的代理IP一般质量都不高，所以需要进行过滤。<br>常用的方法就是尝试使用代理IP去访问一个常用网站，如百度等，如果在短时间内正常返回则认为可用。<br>开始我也采用了这种方式，访问百度，但是发现可能会出现一种情况，就是百度可以访问，但是访问云音乐接口却出现错误。<br>既然如此，不如一步到位，过滤时就访问歌曲信息接口，如果能正常获取歌曲信息，那么认为代理可用。</p>
<p>先给出获取歌曲信息的Client：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MusicClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取歌曲信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> songId 歌曲id</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 页面html</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@GET</span>(<span class="string">"song"</span>)</div><div class="line">    <span class="meta">@Headers</span>(<span class="string">"Referer: http://music.163.com/"</span>)</div><div class="line">    <span class="function">Call&lt;String&gt; <span class="title">songInfo</span><span class="params">(@Query(<span class="string">"id"</span>)</span> <span class="keyword">long</span> songId)</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取评论信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> songId    歌曲id</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> params    加密params</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> encSecKey 加密encSecKey</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 评论接口返回体</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@POST</span>(<span class="string">"weapi/v1/resource/comments/R_SO_4_&#123;songId&#125;/?csrf_token=d2c9e86c94efabcc4b5a1a6d757d417e"</span>)</div><div class="line">    <span class="meta">@FormUrlEncoded</span></div><div class="line">    <span class="meta">@Headers</span>(<span class="string">"Referer: http://music.163.com/"</span>)</div><div class="line">    <span class="function">Call&lt;CommentResponseBody&gt; <span class="title">comment</span><span class="params">(@Path(<span class="string">"songId"</span>)</span> Long songId,</span></div><div class="line"><span class="function">                                      @<span class="title">Field</span><span class="params">(<span class="string">"params"</span>)</span> String params,</span></div><div class="line"><span class="function">                                      @<span class="title">Field</span><span class="params">(<span class="string">"encSecKey"</span>)</span> String encSecKey)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来需要一个定制OkHttp，添加代理IP，这里创建一个工厂：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpProxyClientFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MusicClient <span class="title">musicClient</span><span class="params">(Proxy proxy, <span class="keyword">int</span> timeoutInSecond)</span> </span>&#123;</div><div class="line">        OkHttpClient.Builder builder = <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">                .connectTimeout(timeoutInSecond, TimeUnit.SECONDS)</div><div class="line">                .readTimeout(timeoutInSecond, TimeUnit.SECONDS)</div><div class="line">                .addInterceptor(<span class="keyword">new</span> HttpHeaderInterceptor());</div><div class="line">        addProxy(proxy, builder);</div><div class="line">        OkHttpClient okHttpClient = builder.build();</div><div class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">        <span class="comment">//设置输入时忽略在JSON字符串中存在但Java对象实际没有的属性</span></div><div class="line">        mapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);</div><div class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                .addConverterFactory(ScalarsConverterFactory.create())</div><div class="line">                .addConverterFactory(JacksonConverterFactory.create(mapper))</div><div class="line">                .baseUrl(<span class="string">"http://music.163.com/"</span>)</div><div class="line">                .client(okHttpClient)</div><div class="line">                .build();</div><div class="line">        <span class="keyword">return</span> retrofit.create(MusicClient.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 设置代理</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addProxy</span><span class="params">(Proxy proxy, OkHttpClient.Builder builder)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (proxy != <span class="keyword">null</span>) &#123;</div><div class="line">            String schemeName = proxy.getProto();</div><div class="line">            java.net.Proxy.Type type = java.net.Proxy.Type.HTTP;</div><div class="line">            <span class="keyword">if</span> (schemeName.startsWith(<span class="string">"socks"</span>)) &#123;</div><div class="line">                type = java.net.Proxy.Type.SOCKS;</div><div class="line">            &#125;</div><div class="line">            builder.proxy(<span class="keyword">new</span> java.net.Proxy(type, <span class="keyword">new</span> InetSocketAddress(proxy.getIp(), proxy.getPort())));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于每次请求的代理IP都不同，不能直接注入到bean，而是使用工厂方法，每次请求都重新构造一个<code>OkHttpClient</code>，然后生成<code>MusicClient</code>。<br>注意在添加converterFactory时，先添加<code>ScalarsConverterFactory</code>，再<code>JacksonConverterFactory</code>，原因在doc中：</p>
<blockquote>
<p>Because Jackson is so flexible in the types it supports, this converter assumes that it can handle all types. If you are mixing JSON serialization with something else (such as protocol buffers), you must add this instance last to allow the other converters a chance to see their types.</p>
</blockquote>
<p>接下来就可以使用代理IP请求歌曲信息了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Pattern NAME_PATTERN = Pattern.compile(<span class="string">"&lt;title&gt;(.*) - 网易云音乐&lt;/title&gt;"</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Pattern DESCRIPTION_PATTERN = Pattern.compile(<span class="string">"&lt;meta name=\"description\" content=\"(.*)\" /&gt;"</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Pattern IMAGE_PATTERN = Pattern.compile(<span class="string">"&lt;meta property=\"og:image\" content=\"(.*)\" /&gt;"</span>);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取歌曲信息</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> songId 歌曲id</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> 如果找到，返回：歌曲名称 - 歌手名称；否则返回null</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> Song <span class="title">getSongInfo</span><span class="params">(<span class="keyword">long</span> songId, Proxy proxy, <span class="keyword">int</span> timeoutInSecond)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Response&lt;String&gt; response = HttpProxyClientFactory.musicClient(proxy, timeoutInSecond)</div><div class="line">            .songInfo(songId).execute();</div><div class="line">    Preconditions.checkNotNull(response);</div><div class="line">    String songInfo = response.body();</div><div class="line">    Preconditions.checkArgument(StringUtils.isNotBlank(songInfo));</div><div class="line">    Matcher nameMatcher = NAME_PATTERN.matcher(songInfo);</div><div class="line">    Matcher descriptionMatcher = DESCRIPTION_PATTERN.matcher(songInfo);</div><div class="line">    Matcher imageMatcher = IMAGE_PATTERN.matcher(songInfo);</div><div class="line">    String name = <span class="string">""</span>;</div><div class="line">    String description = <span class="string">""</span>;</div><div class="line">    String image = <span class="string">""</span>;</div><div class="line">    <span class="keyword">if</span> (nameMatcher.find()) &#123;</div><div class="line">        name = nameMatcher.group(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (descriptionMatcher.find()) &#123;</div><div class="line">        description = descriptionMatcher.group(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (imageMatcher.find()) &#123;</div><div class="line">        image = imageMatcher.group(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(name)) &#123;</div><div class="line">        Song song = <span class="keyword">new</span> Song();</div><div class="line">        song.setSongId(songId);</div><div class="line">        song.setName(name);</div><div class="line">        song.setDescription(description);</div><div class="line">        song.setImage(image);</div><div class="line">        song.setCreateTime(<span class="keyword">new</span> Date());</div><div class="line">        logger.info(<span class="string">"song=&#123;&#125;"</span>, song);</div><div class="line">        <span class="keyword">return</span> song;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>剩下的过滤工作也就简单了，对于爬去来的代理IP列表，使用多个线程去过滤一下就好了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">filterProxy</span><span class="params">(List&lt;Proxy&gt; proxyList)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(proxyList)) &#123;</div><div class="line">        <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(proxyList.size());</div><div class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">5</span>);</div><div class="line">        proxyList.forEach(proxy -&gt; executorService.execute(<span class="keyword">new</span> FilterJob(proxy, latch)));</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            latch.await();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            LOGGER.error(e.getMessage());</div><div class="line">        &#125;</div><div class="line">        executorService.shutdownNow();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterJob</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Proxy proxy;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> CountDownLatch latch;</div><div class="line"></div><div class="line">    FilterJob(Proxy proxy, CountDownLatch latch) &#123;</div><div class="line">        <span class="keyword">this</span>.proxy = proxy;</div><div class="line">        <span class="keyword">this</span>.latch = latch;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 先只要http类型的</span></div><div class="line">            <span class="keyword">if</span> (proxy.getProto().startsWith(<span class="string">"http"</span>)</div><div class="line">                    &amp;&amp; commentLoader.getSongInfo(<span class="number">209996</span>, proxy, httpConfig.getProxyValidateTimeout()) != <span class="keyword">null</span>) &#123;</div><div class="line">                LOGGER.info(<span class="string">"================&gt; &#123;&#125;"</span>, proxy);</div><div class="line">                proxyDao.save(<span class="keyword">new</span> Proxy(proxy.getIp(), proxy.getPort(), proxy.getProto()));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(e.getMessage());</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            latch.countDown();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-4-定时抓取"><a href="#4-4-定时抓取" class="headerlink" title="4.4 定时抓取"></a>4.4 定时抓取</h4><p>上面我们实现了一次代理IP抓取，而抓取来的IP也会失效，所以我们需要定时抓取，更新代理IP池。<br>定时任务可以使用Spring的Schedule注解实现，也可以使用quartz，这里使用quartz。<br>引入依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>application.yml</code>添加配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  quartz:</span></div><div class="line"><span class="attr">    properties:</span></div><div class="line"><span class="attr">      org:</span></div><div class="line"><span class="attr">        quartz:</span></div><div class="line"><span class="attr">          scheduler:</span></div><div class="line"><span class="attr">            instanceName:</span> <span class="string">proxyScheduler</span></div><div class="line"><span class="attr">          threadPool:</span></div><div class="line"><span class="attr">            class:</span> <span class="string">org.quartz.simpl.SimpleThreadPool</span></div><div class="line"><span class="attr">            threadCount:</span> <span class="number">10</span></div><div class="line"><span class="attr">            threadPriority:</span> <span class="number">5</span></div><div class="line"><span class="attr">    job-store-type:</span> <span class="string">MEMORY</span></div></pre></td></tr></table></figure></p>
<p>这里使用简单的内存存储job，也可以使用数据库，配置项会麻烦些。<br>然后创建一个定时任务job，继承<code>QuartzJobBean</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyLoadJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ProxyLoadJob.class);</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> ProxyLoader proxyLoader;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext jobExecutionContext)</span> </span>&#123;</div><div class="line">        LOGGER.info(<span class="string">"ProxyLoadJob start."</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            proxyLoader.loadProxy();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(e.getMessage());</div><div class="line">        &#125;</div><div class="line">        LOGGER.info(<span class="string">"ProxyLoadJob end."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>有了任务，还要将它调度起来，我想20分钟跑一次：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobScheduler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JOB_NAME_PROXY_LOAD = <span class="string">"proxyLoadJob"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_NAME_PROXY = <span class="string">"proxyLoadGroup"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">proxyJob</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> JobBuilder.newJob(ProxyLoadJob.class)</div><div class="line">                .withIdentity(JOB_NAME_PROXY_LOAD, GROUP_NAME_PROXY)</div><div class="line">                .storeDurably()</div><div class="line">                .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">proxyJobTrigger</span><span class="params">()</span> </span>&#123;</div><div class="line">        CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(<span class="string">"0 0/20 * * * ?"</span>);</div><div class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">                .withSchedule(scheduleBuilder)</div><div class="line">                .withIdentity(JOB_NAME_PROXY_LOAD, GROUP_NAME_PROXY)</div><div class="line">                .forJob(proxyJob())</div><div class="line">                .build();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们先注册一个<code>JobDetail</code>，需要一个名字和分组，然后设置为durably，即没有trigger指向时，也保留。<br>接下来注册一个trigger去触发上面的job，设置cron表达式，绑定job即可。</p>
<h4 id="4-5-定时删除失效IP"><a href="#4-5-定时删除失效IP" class="headerlink" title="4.5 定时删除失效IP"></a>4.5 定时删除失效IP</h4><p>上面我们实现了定时抓取新代理IP的功能，接下来还需要定时从库中删除失效的代理IP，不能光等到使用时再删除。<br>方法是从库中读取所有代理IP（如果代理IP量很大，可以分页处理），然后启动多个任务去校验代理IP有效性，将无效的删除：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateFromDb</span><span class="params">()</span> </span>&#123;</div><div class="line">      List&lt;Proxy&gt; allProxy = proxyDao.getAllProxy();</div><div class="line">      <span class="keyword">if</span> (CollectionUtils.isNotEmpty(allProxy)) &#123;</div><div class="line">          <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(allProxy.size());</div><div class="line">          ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">5</span>);</div><div class="line">          allProxy.forEach(proxy -&gt; executorService.execute(<span class="keyword">new</span> ValidateJob(proxy, latch)));</div><div class="line">          <span class="keyword">for</span> (Proxy proxy : allProxy) &#123;</div><div class="line">              executorService.execute(<span class="keyword">new</span> ValidateJob(proxy, latch));</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              latch.await();</div><div class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">              LOGGER.error(e.getMessage());</div><div class="line">          &#125;</div><div class="line">          executorService.shutdownNow();</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ValidateJob</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">private</span> Proxy proxy;</div><div class="line"></div><div class="line">      <span class="keyword">private</span> CountDownLatch latch;</div><div class="line"></div><div class="line">      ValidateJob(Proxy proxy, CountDownLatch latch) &#123;</div><div class="line">          <span class="keyword">this</span>.proxy = proxy;</div><div class="line">          <span class="keyword">this</span>.latch = latch;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              <span class="keyword">if</span> (commentLoader.getSongInfo(<span class="number">209996</span>, proxy, httpConfig.getProxyValidateTimeout()) == <span class="keyword">null</span>) &#123;</div><div class="line">                  proxyDao.delete(proxy.getId());</div><div class="line">                  LOGGER.error(<span class="string">"disable proxy=&#123;&#125;"</span>, proxy);</div><div class="line">              &#125;</div><div class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">              LOGGER.error(e.getMessage());</div><div class="line">          &#125; <span class="keyword">finally</span> &#123;</div><div class="line">              latch.countDown();</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>同样需要一个定时任务，15分钟执行一次即可，代码与上面抓取代理任务类似。</p>
<h4 id="4-6-使用代理IP获取歌曲信息"><a href="#4-6-使用代理IP获取歌曲信息" class="headerlink" title="4.6 使用代理IP获取歌曲信息"></a>4.6 使用代理IP获取歌曲信息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentLoader</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(CommentLoader.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Pattern NAME_PATTERN = Pattern.compile(<span class="string">"&lt;title&gt;(.*) - 网易云音乐&lt;/title&gt;"</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Pattern DESCRIPTION_PATTERN = Pattern.compile(<span class="string">"&lt;meta name=\"description\" content=\"(.*)\" /&gt;"</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Pattern IMAGE_PATTERN = Pattern.compile(<span class="string">"&lt;meta property=\"og:image\" content=\"(.*)\" /&gt;"</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> SongDao songDao;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> UserDao userDao;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> CommentDao commentDao;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> ProxyDao proxyDao;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> HttpConfig httpConfig;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取歌曲和评论信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> start 歌曲id起始</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> end 歌曲id结束</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadSongs</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> songId = start; songId &lt;= end; songId++) &#123;</div><div class="line">            Proxy proxy = getRandomProxy();</div><div class="line">            Song songInfo = getSongInfo(songId, proxy, httpConfig.getSongLoadTimeout());</div><div class="line">            <span class="keyword">if</span> (songInfo == <span class="keyword">null</span>) &#123; <span class="comment">// 重试一次</span></div><div class="line">                proxyDao.delete(proxy.getId());</div><div class="line">                proxy = getRandomProxy();</div><div class="line">                songInfo = getSongInfo(songId, proxy, httpConfig.getSongLoadTimeout());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (songInfo == <span class="keyword">null</span>) &#123; <span class="comment">// 重试一次</span></div><div class="line">                proxyDao.delete(proxy.getId());</div><div class="line">                proxy = getRandomProxy();</div><div class="line">                songInfo = getSongInfo(songId, proxy, httpConfig.getSongLoadTimeout());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (songInfo == <span class="keyword">null</span>) &#123;</div><div class="line">                proxyDao.delete(proxy.getId());</div><div class="line">                logger.error(<span class="string">"songInfo is null. songId=&#123;&#125;"</span>, songId);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (songInfo != <span class="keyword">null</span>) &#123;</div><div class="line">                loadCommentInfo(songInfo, proxy);</div><div class="line">            &#125;</div><div class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">50</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取歌曲信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> songId 歌曲id</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 如果找到，返回：歌曲名称 - 歌手名称；否则返回null</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Song <span class="title">getSongInfo</span><span class="params">(<span class="keyword">long</span> songId, Proxy proxy, <span class="keyword">int</span> timeoutInSecond)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Response&lt;String&gt; response = HttpProxyClientFactory.musicClient(proxy, timeoutInSecond)</div><div class="line">                .songInfo(songId).execute();</div><div class="line">        Preconditions.checkNotNull(response);</div><div class="line">        String songInfo = response.body();</div><div class="line">        Preconditions.checkArgument(StringUtils.isNotBlank(songInfo));</div><div class="line">        Matcher nameMatcher = NAME_PATTERN.matcher(songInfo);</div><div class="line">        Matcher descriptionMatcher = DESCRIPTION_PATTERN.matcher(songInfo);</div><div class="line">        Matcher imageMatcher = IMAGE_PATTERN.matcher(songInfo);</div><div class="line">        String name = <span class="string">""</span>;</div><div class="line">        String description = <span class="string">""</span>;</div><div class="line">        String image = <span class="string">""</span>;</div><div class="line">        <span class="keyword">if</span> (nameMatcher.find()) &#123;</div><div class="line">            name = nameMatcher.group(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (descriptionMatcher.find()) &#123;</div><div class="line">            description = descriptionMatcher.group(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (imageMatcher.find()) &#123;</div><div class="line">            image = imageMatcher.group(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(name)) &#123;</div><div class="line">            Song song = <span class="keyword">new</span> Song();</div><div class="line">            song.setSongId(songId);</div><div class="line">            song.setName(name);</div><div class="line">            song.setDescription(description);</div><div class="line">            song.setImage(image);</div><div class="line">            song.setCreateTime(<span class="keyword">new</span> Date());</div><div class="line">            logger.info(<span class="string">"song=&#123;&#125;"</span>, song);</div><div class="line">            <span class="keyword">return</span> song;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取歌曲评论</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> song  歌曲信息</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> proxy</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadCommentInfo</span><span class="params">(Song song, Proxy proxy)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Long songId = song.getSongId();</div><div class="line">        String params = <span class="string">"flQdEgSsTmFkRagRN2ceHMwk6lYVIMro5auxLK/JywlqdjeNvEtiWDhReFI+QymePGPLvPnIuVi3dfsDuqEJW204VdwvX+gr3uiRBeSFuOm1VUSJ1HqOc+nJCh0j6WGUbWuJC5GaHTEE4gcpWXX36P4Eu4djoQBzoqdsMbCwoolb2/WrYw/N2hehuwBHO4Oz"</span>;</div><div class="line">        String encSecKey = <span class="string">"0263b1cd3b0a9b621a819b73e588e1cc5709349b21164dc45ab760e79858bb712986ea064dbfc41669e527b767f02da7511ac862cbc54ea7d164fc65e0359962273616e68e694453fb6820fa36dd9915b2b0f60dadb0a6022b2187b9ee011b35d82a1c0ed8ba0dceb877299eca944e80b1e74139f0191adf71ca536af7d7ec25"</span>;</div><div class="line">        Response&lt;CommentResponseBody&gt; response = HttpProxyClientFactory.musicClient(proxy, httpConfig.getSongLoadTimeout()).comment(songId, params, encSecKey).execute();</div><div class="line">        <span class="keyword">long</span> commentCount = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">            CommentResponseBody commentResponseBody = response.body();</div><div class="line">            <span class="keyword">if</span> (commentResponseBody != <span class="keyword">null</span>) &#123;</div><div class="line">                commentCount = commentResponseBody.getTotal();</div><div class="line">                List&lt;CommentResponse&gt; hotComments = commentResponseBody.getHotComments();</div><div class="line">                <span class="keyword">if</span> (CollectionUtils.isNotEmpty(hotComments)) &#123;</div><div class="line">                    <span class="keyword">for</span> (CommentResponse commentResponse : hotComments) &#123;</div><div class="line">                        Long userId = <span class="number">0L</span>;</div><div class="line">                        User user = commentResponse.getUser();</div><div class="line">                        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</div><div class="line">                            userId = user.getUserId();</div><div class="line">                            userDao.save(user);</div><div class="line">                        &#125;</div><div class="line">                        Long beRepliedUserId = <span class="number">0L</span>;</div><div class="line">                        String beRepliedContent = <span class="string">""</span>;</div><div class="line">                        List&lt;CommentReplied&gt; beRepliedList = commentResponse.getBeReplied();</div><div class="line">                        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(beRepliedList)) &#123;</div><div class="line">                            CommentReplied commentReplied = beRepliedList.get(<span class="number">0</span>);</div><div class="line">                            User repliedUser = commentReplied.getUser();</div><div class="line">                            <span class="keyword">if</span> (repliedUser != <span class="keyword">null</span>) &#123;</div><div class="line">                                beRepliedUserId = repliedUser.getUserId();</div><div class="line">                                userDao.save(repliedUser);</div><div class="line">                            &#125;</div><div class="line">                            beRepliedContent = commentReplied.getContent();</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (commentCount &gt; <span class="number">1000</span>) &#123;</div><div class="line">                            <span class="comment">// 总评论数少于1000的歌曲就扔掉了</span></div><div class="line">                            Comment comment = <span class="keyword">new</span> Comment();</div><div class="line">                            comment.setCommentId(commentResponse.getCommentId());</div><div class="line">                            comment.setSongId(songId);</div><div class="line">                            comment.setLikedCount(commentResponse.getLikedCount());</div><div class="line">                            comment.setContent(commentResponse.getContent());</div><div class="line">                            comment.setUserId(userId);</div><div class="line">                            comment.setBeRepliedUserId(beRepliedUserId);</div><div class="line">                            comment.setBeRepliedContent(beRepliedContent);</div><div class="line">                            comment.setCommentTime(<span class="keyword">new</span> Date(commentResponse.getTime()));</div><div class="line">                            comment.setCreateTime(<span class="keyword">new</span> Date());</div><div class="line">                            commentDao.save(comment);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        song.setCommentCount(commentCount);</div><div class="line">        songDao.save(song);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 查询一个随机代理</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> Proxy <span class="title">getRandomProxy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = proxyDao.count();</div><div class="line">        <span class="keyword">return</span> proxyDao.getByIndex(ThreadLocalRandom.current().nextInt(count));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>
  
        <div class="post-tags">
          
            <a href="/tags/spring/" rel="tag"><i class="fa fa-tag"></i> spring</a>
          
            <a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> java</a>
          
        </div>
      


    <footer class="post-footer">

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2018/09/BigDecimal精度.html" rel="next" title="BigDecimal精度">
                <i class="fa fa-chevron-left"></i> BigDecimal精度
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2018/09/包装类.html" rel="prev" title="java包装类">
                java包装类 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar2.jpg"
               alt="五月y" />
          <p class="site-author-name" itemprop="name">五月y</p>
          <p class="site-description motion-element" itemprop="description">Hello 五月y!</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">44</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/damon4u" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/damon4u" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/damon4u" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-battery-3"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-初衷"><span class="nav-number">1.</span> <span class="nav-text">1. 初衷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-探索抓取方案"><span class="nav-number">2.</span> <span class="nav-text">2.探索抓取方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-代理IP池"><span class="nav-number">3.</span> <span class="nav-text">3. 代理IP池</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-代理IP"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 代理IP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-免费代理IP池"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 免费代理IP池</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-实现"><span class="nav-number">4.</span> <span class="nav-text">4. 实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-配置文件读取"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 配置文件读取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-使用普通http请求获取动态IP"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 使用普通http请求获取动态IP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-过滤抓取来的代理IP"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 过滤抓取来的代理IP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-定时抓取"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 定时抓取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-定时删除失效IP"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 定时删除失效IP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-6-使用代理IP获取歌曲信息"><span class="nav-number">4.6.</span> <span class="nav-text">4.6 使用代理IP获取歌曲信息</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">五月y</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>
</div>





        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>

  
  <script type="text/javascript" src="/vendors/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


  <!-- 页面点击小红心 -->
  <!-- <script type="text/javascript" src="/js/src/love.js"></script>
  -->
  <!-- 动态线条背景 http://shenzekun.cn/hexo%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0%E5%8A%A8%E6%80%81%E8%83%8C%E6%99%AF.html -->
  <!--
    <script type="text/javascript" color="0,0,0" opacity='0.9' zIndex="-2" count="50" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
  -->
</body>
</html>
