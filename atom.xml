<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>是五月呀！</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://damon4u.github.io/"/>
  <updated>2018-10-12T14:31:38.247Z</updated>
  <id>https://damon4u.github.io/</id>
  
  <author>
    <name>五月y</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>IDEA插件开发（六）依赖Dependencies</title>
    <link href="https://damon4u.github.io//blog/2018/10/IDEA%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%EF%BC%88%E5%85%AD%EF%BC%89%E4%BE%9D%E8%B5%96Dependencies.html"/>
    <id>https://damon4u.github.io//blog/2018/10/IDEA插件开发（六）依赖Dependencies.html</id>
    <published>2018-10-12T09:41:50.000Z</published>
    <updated>2018-10-12T14:31:38.247Z</updated>
    
    <content type="html"><![CDATA[<p>你的插件可能会依赖其他插件，内置的、第三方的或者你自己的。为了引入这些依赖，需要执行如下步骤：</p><ul><li>如果插件时内置的，那么启动沙箱环境，在里面安装插件。</li><li>在 <strong>IntelliJ Platform SDK</strong> 中添加插件的jar包。打开 <strong>Project Structure</strong> 对话框，选择使用的SDK，点击加号选择要添加的插件jar包。如果是内置插件，那么插件jar包在主安装目录下的<code>plugins/&lt;pluginname&gt;</code>或者<code>plugins/&lt;pluginname&gt;/lib</code>目录下。如果是非内置插件，那么插件jar包在<code>Sandbox Home</code>指定的目录下的<code>config/plugins/&lt;pluginname&gt;</code>或者<code>config/plugins/&lt;pluginname&gt;/lib</code>内。</li><li>添加<code>&lt;depends&gt;</code>标签到<code>plugin.xml</code>中，将插件的ID作为标签值。如果不知道插件的ID，可以到指定插件的<code>plugin.xml</code>中查看。</li></ul><a id="more"></a><p>例如，我们的插件依赖<code>com.intellij.database</code>插件，那么我们需要将jar引入：<br><img src="/images/idea-plugin16.png" alt=""></p><p>然后在<code>plugin.xml</code>中声明：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">depends</span> <span class="attr">optional</span>=<span class="string">"true"</span>&gt;</span>com.intellij.database<span class="tag">&lt;/<span class="name">depends</span>&gt;</span></div></pre></td></tr></table></figure></p><p><code>optional</code>代表如果此插件没有安装，那么可以用，不过可能影响部分功能。</p><p>参考资料：<br><a href="https://www.jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_services.html" target="_blank" rel="external">Plugin Services</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;你的插件可能会依赖其他插件，内置的、第三方的或者你自己的。为了引入这些依赖，需要执行如下步骤：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果插件时内置的，那么启动沙箱环境，在里面安装插件。&lt;/li&gt;
&lt;li&gt;在 &lt;strong&gt;IntelliJ Platform SDK&lt;/strong&gt; 中添加插件的jar包。打开 &lt;strong&gt;Project Structure&lt;/strong&gt; 对话框，选择使用的SDK，点击加号选择要添加的插件jar包。如果是内置插件，那么插件jar包在主安装目录下的&lt;code&gt;plugins/&amp;lt;pluginname&amp;gt;&lt;/code&gt;或者&lt;code&gt;plugins/&amp;lt;pluginname&amp;gt;/lib&lt;/code&gt;目录下。如果是非内置插件，那么插件jar包在&lt;code&gt;Sandbox Home&lt;/code&gt;指定的目录下的&lt;code&gt;config/plugins/&amp;lt;pluginname&amp;gt;&lt;/code&gt;或者&lt;code&gt;config/plugins/&amp;lt;pluginname&amp;gt;/lib&lt;/code&gt;内。&lt;/li&gt;
&lt;li&gt;添加&lt;code&gt;&amp;lt;depends&amp;gt;&lt;/code&gt;标签到&lt;code&gt;plugin.xml&lt;/code&gt;中，将插件的ID作为标签值。如果不知道插件的ID，可以到指定插件的&lt;code&gt;plugin.xml&lt;/code&gt;中查看。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="idea" scheme="https://damon4u.github.io/categories/idea/"/>
    
      <category term="java" scheme="https://damon4u.github.io/categories/idea/java/"/>
    
    
      <category term="idea" scheme="https://damon4u.github.io/tags/idea/"/>
    
  </entry>
  
  <entry>
    <title>IDEA插件开发（五）Service</title>
    <link href="https://damon4u.github.io//blog/2018/10/IDEA%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%94%EF%BC%89Service.html"/>
    <id>https://damon4u.github.io//blog/2018/10/IDEA插件开发（五）Service.html</id>
    <published>2018-10-12T08:41:50.000Z</published>
    <updated>2018-10-12T14:31:38.246Z</updated>
    
    <content type="html"><![CDATA[<p>IDEA平台提供<code>service</code>的概念。一个<code>Service</code>组件是单例的，使用<code>ServiceManager</code>的<code>getService</code>方法获取。<br><code>Service</code>可以是一个类，也可以是一个接口，但如果是接口，必须有实现类。</p><a id="more"></a><p>有三种类型的service：</p><ul><li>application级别</li><li>project级别</li><li>module级别</li></ul><p>与<code>Action</code>类似新建类时，可以选择模板来创建<code>Service</code>。</p><p>注册：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">extensions</span> <span class="attr">defaultExtensionNs</span>=<span class="string">"com.intellij"</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- Declare the application level service --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">applicationService</span> <span class="attr">serviceInterface</span>=<span class="string">"Mypackage.MyApplicationService"</span> <span class="attr">serviceImplementation</span>=<span class="string">"Mypackage.MyApplicationServiceImpl"</span> /&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">&lt;!-- Declare the project level service --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">projectService</span> <span class="attr">serviceInterface</span>=<span class="string">"Mypackage.MyProjectService"</span> <span class="attr">serviceImplementation</span>=<span class="string">"Mypackage.MyProjectServiceImpl"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></div></pre></td></tr></table></figure></p><p>如果不指定<code>serviceInterface</code>，那么跟<code>serviceImplementation</code>一样。<br>获取：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">MyApplicationService applicationService = ServiceManager.getService(MyApplicationService.class);</div><div class="line"></div><div class="line">MyProjectService projectService = ServiceManager.getService(project, MyProjectService.class);</div><div class="line"></div><div class="line">MyModuleService moduleService = ModuleServiceManager.getService(<span class="keyword">module</span>, MyModuleService.class);</div></pre></td></tr></table></figure></p><p>参考资料：<br><a href="https://www.jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_services.html" target="_blank" rel="external">Plugin Services</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;IDEA平台提供&lt;code&gt;service&lt;/code&gt;的概念。一个&lt;code&gt;Service&lt;/code&gt;组件是单例的，使用&lt;code&gt;ServiceManager&lt;/code&gt;的&lt;code&gt;getService&lt;/code&gt;方法获取。&lt;br&gt;&lt;code&gt;Service&lt;/code&gt;可以是一个类，也可以是一个接口，但如果是接口，必须有实现类。&lt;/p&gt;
    
    </summary>
    
      <category term="idea" scheme="https://damon4u.github.io/categories/idea/"/>
    
      <category term="java" scheme="https://damon4u.github.io/categories/idea/java/"/>
    
    
      <category term="idea" scheme="https://damon4u.github.io/tags/idea/"/>
    
  </entry>
  
  <entry>
    <title>IDEA插件开发（四）配置持久化</title>
    <link href="https://damon4u.github.io//blog/2018/10/IDEA%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%EF%BC%88%E5%9B%9B%EF%BC%89%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%8C%96.html"/>
    <id>https://damon4u.github.io//blog/2018/10/IDEA插件开发（四）配置持久化.html</id>
    <published>2018-10-11T10:41:50.000Z</published>
    <updated>2018-10-12T14:31:38.246Z</updated>
    
    <content type="html"><![CDATA[<p>很多插件都需要提供用户配置参数的入口，这里以<code>free-mybatis-plugin</code>插件为例，我们想要用户配置方法匹配模版，例如dao层中<code>insert</code>，<code>add</code>等关键字开头的方法在mapper中生成<code>insert</code>语句。</p><a id="more"></a><h3 id="创建GUI配置窗口"><a href="#创建GUI配置窗口" class="headerlink" title="创建GUI配置窗口"></a>创建GUI配置窗口</h3><p>IDEA中可以直接创建一个GUI窗口：</p><p><img src="/images/idea-plugin12.png" alt=""></p><p>弹出创建窗口：</p><p><img src="/images/idea-plugin13.png" alt=""></p><p>名字自定，layout默认使用GridLayoutManager即可。<br>然后就可以拖拽编辑UI界面了。<br>第一次用会觉得超级难用！在排版的时候，如果想新加一行或者一列，拖拽组件到原来行的边缘，释放后会自动新增加一行。</p><p><img src="/images/idea-plugin14.png" alt=""></p><p>给需要取值的组件填写<code>filed name</code>属性，这样在生成的类中会包含对应的成员变量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisSettingForm</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> JTextField insertPatternTextField;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> JTextField deletePatternTextField;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> JTextField updatePatternTextField;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> JTextField selectPatternTextField;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> JPanel mainPanel;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> JComboBox modelComboBox;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="添加配置项"><a href="#添加配置项" class="headerlink" title="添加配置项"></a>添加配置项</h3><p>创建完GUI窗口后，需要在IDEA配置窗口中添加入口，那就需要实现<code>SearchableConfigurable</code>接口，并注册到<code>plugin.xml</code>中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisConfigurable</span> <span class="keyword">implements</span> <span class="title">SearchableConfigurable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 保存全局配置，</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> MybatisSetting mybatisSetting;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * GUI配置窗口</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> MybatisSettingForm mybatisSettingForm;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String separator = <span class="string">";"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Splitter splitter = Splitter.on(separator).omitEmptyStrings().trimResults();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Joiner joiner = Joiner.on(separator);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MybatisConfigurable</span><span class="params">()</span> </span>&#123;</div><div class="line">        mybatisSetting = MybatisSetting.getInstance();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 返回唯一id</span></div><div class="line"><span class="comment">     * 这个id要与xml中的id（如果指定）一致</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Mybatis"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 用户在setting对话框搜索时，启用的动作</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> option</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Runnable <span class="title">enableSearch</span><span class="params">(String option)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 配置项名称</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Nls</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDisplayName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> getId();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 帮助文档中的名称</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHelpTopic</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> getId();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 创建GUI组件</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JComponent <span class="title">createComponent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mybatisSettingForm) &#123;</div><div class="line">            <span class="keyword">this</span>.mybatisSettingForm = <span class="keyword">new</span> MybatisSettingForm();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mybatisSettingForm.mainPanel;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 判断配置内容有没有修改</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isModified</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mybatisSetting.getStatementGenerateModel().getIdentifier() != mybatisSettingForm.modelComboBox.getSelectedIndex()</div><div class="line">                || !joiner.join(INSERT_GENERATOR.getPatterns()).equals(mybatisSettingForm.insertPatternTextField.getText())</div><div class="line">                || !joiner.join(DELETE_GENERATOR.getPatterns()).equals(mybatisSettingForm.deletePatternTextField.getText())</div><div class="line">                || !joiner.join(UPDATE_GENERATOR.getPatterns()).equals(mybatisSettingForm.updatePatternTextField.getText())</div><div class="line">                || !joiner.join(SELECT_GENERATOR.getPatterns()).equals(mybatisSettingForm.selectPatternTextField.getText());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 用户修改配置后点击确认</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> ConfigurationException</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">()</span> <span class="keyword">throws</span> ConfigurationException </span>&#123;</div><div class="line">        mybatisSetting.setStatementGenerateModel(GenerateModel.getInstance(mybatisSettingForm.modelComboBox.getSelectedIndex()));</div><div class="line">        INSERT_GENERATOR.setPatterns(Sets.newHashSet(splitter.split(mybatisSettingForm.insertPatternTextField.getText())));</div><div class="line">        DELETE_GENERATOR.setPatterns(Sets.newHashSet(splitter.split(mybatisSettingForm.deletePatternTextField.getText())));</div><div class="line">        UPDATE_GENERATOR.setPatterns(Sets.newHashSet(splitter.split(mybatisSettingForm.updatePatternTextField.getText())));</div><div class="line">        SELECT_GENERATOR.setPatterns(Sets.newHashSet(splitter.split(mybatisSettingForm.selectPatternTextField.getText())));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 重置配置</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</div><div class="line">        mybatisSettingForm.modelComboBox.setSelectedIndex(mybatisSetting.getStatementGenerateModel().getIdentifier());</div><div class="line">        mybatisSettingForm.insertPatternTextField.setText(joiner.join(INSERT_GENERATOR.getPatterns()));</div><div class="line">        mybatisSettingForm.deletePatternTextField.setText(joiner.join(DELETE_GENERATOR.getPatterns()));</div><div class="line">        mybatisSettingForm.updatePatternTextField.setText(joiner.join(UPDATE_GENERATOR.getPatterns()));</div><div class="line">        mybatisSettingForm.selectPatternTextField.setText(joiner.join(SELECT_GENERATOR.getPatterns()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 销毁GUI组件</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disposeUIResources</span><span class="params">()</span> </span>&#123;</div><div class="line">        mybatisSettingForm.mainPanel = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>之后在<code>plugin.xml</code>中注册：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">extensions</span> <span class="attr">defaultExtensionNs</span>=<span class="string">"com.intellij"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 插件配置窗口 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">applicationConfigurable</span> <span class="attr">instance</span>=<span class="string">"com.mybatis.setting.MybatisConfigurable"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!-- applicationService 这个是插件配置文件的持久化 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">applicationService</span> <span class="attr">serviceInterface</span>=<span class="string">"com.xxx.mybatis.setting.MybatisSetting"</span></span></div><div class="line"><span class="tag">                        <span class="attr">serviceImplementation</span>=<span class="string">"com.xxx.mybatis.setting.MybatisSetting"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></div></pre></td></tr></table></figure></p><p>这样就可以在IDEA setting窗口中见到我们的配置项了：<br><img src="/images/idea-plugin15.png" alt=""></p><h3 id="持久化配置"><a href="#持久化配置" class="headerlink" title="持久化配置"></a>持久化配置</h3><p>上面我们说了如何让用户修改插件配置，那当IDEA重启时，我们想让配置持久化到文件中，可以实现<code>PersistentStateComponent</code>接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@State</span>(</div><div class="line">        name = <span class="string">"MybatisSettings"</span>,</div><div class="line">        storages = <span class="meta">@Storage</span>(<span class="string">"mybatis.xml"</span>))</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisSetting</span> <span class="keyword">implements</span> <span class="title">PersistentStateComponent</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> GenerateModel statementGenerateModel;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Gson gson = <span class="keyword">new</span> Gson();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Type gsonTypeToken = <span class="keyword">new</span> TypeToken&lt;Set&lt;String&gt;&gt;() &#123;</div><div class="line">    &#125;.getType();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MybatisSetting</span><span class="params">()</span> </span>&#123;</div><div class="line">        statementGenerateModel = GenerateModel.START_WITH_MODEL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MybatisSetting <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ServiceManager.getService(MybatisSetting.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * IDEA关闭时，将内存中配置持久化到xml中</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Element <span class="title">getState</span><span class="params">()</span> </span>&#123;</div><div class="line">        Element element = <span class="keyword">new</span> Element(<span class="string">"MybatisSettings"</span>);</div><div class="line">        element.setAttribute(INSERT_GENERATOR.getId(), gson.toJson(INSERT_GENERATOR.getPatterns()));</div><div class="line">        element.setAttribute(DELETE_GENERATOR.getId(), gson.toJson(DELETE_GENERATOR.getPatterns()));</div><div class="line">        element.setAttribute(UPDATE_GENERATOR.getId(), gson.toJson(UPDATE_GENERATOR.getPatterns()));</div><div class="line">        element.setAttribute(SELECT_GENERATOR.getId(), gson.toJson(SELECT_GENERATOR.getPatterns()));</div><div class="line">        element.setAttribute(<span class="string">"statementGenerateModel"</span>, String.valueOf(statementGenerateModel.getIdentifier()));</div><div class="line">        <span class="keyword">return</span> element;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * IDEA打开时，从xml中读取配置</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> state</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadState</span><span class="params">(Element state)</span> </span>&#123;</div><div class="line">        loadState(state, INSERT_GENERATOR);</div><div class="line">        loadState(state, DELETE_GENERATOR);</div><div class="line">        loadState(state, UPDATE_GENERATOR);</div><div class="line">        loadState(state, SELECT_GENERATOR);</div><div class="line">        statementGenerateModel = GenerateModel.getInstance(state.getAttributeValue(<span class="string">"statementGenerateModel"</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadState</span><span class="params">(Element state, StatementGenerator generator)</span> </span>&#123;</div><div class="line">        String attribute = state.getAttributeValue(generator.getId());</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != attribute) &#123;</div><div class="line">            generator.setPatterns((Set&lt;String&gt;) gson.fromJson(attribute, gsonTypeToken));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> GenerateModel <span class="title">getStatementGenerateModel</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> statementGenerateModel;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatementGenerateModel</span><span class="params">(GenerateModel statementGenerateModel)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.statementGenerateModel = statementGenerateModel;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>其中<code>@State</code>注解指明了xml中根元素的名字和xml文件名称。<br>配置文件储存位置：<code>/Library/Caches/IntelliJIdea2018.2/plugins-sandbox/config/options/mybatis.xml</code><br>即在沙箱目录下的<code>/config/options/mybatis.xml</code>中。<br>当然，如果插件正式发布安装后，会保存到正式库目录中。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;很多插件都需要提供用户配置参数的入口，这里以&lt;code&gt;free-mybatis-plugin&lt;/code&gt;插件为例，我们想要用户配置方法匹配模版，例如dao层中&lt;code&gt;insert&lt;/code&gt;，&lt;code&gt;add&lt;/code&gt;等关键字开头的方法在mapper中生成&lt;code&gt;insert&lt;/code&gt;语句。&lt;/p&gt;
    
    </summary>
    
      <category term="idea" scheme="https://damon4u.github.io/categories/idea/"/>
    
      <category term="java" scheme="https://damon4u.github.io/categories/idea/java/"/>
    
    
      <category term="idea" scheme="https://damon4u.github.io/tags/idea/"/>
    
  </entry>
  
  <entry>
    <title>IDEA插件开发（三）扩展点</title>
    <link href="https://damon4u.github.io//blog/2018/10/IDEA%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%89%EF%BC%89%E6%89%A9%E5%B1%95%E7%82%B9.html"/>
    <id>https://damon4u.github.io//blog/2018/10/IDEA插件开发（三）扩展点.html</id>
    <published>2018-10-11T08:41:50.000Z</published>
    <updated>2018-10-12T14:31:38.245Z</updated>
    
    <content type="html"><![CDATA[<p>IDEA提供扩展点的概念，这样我们可以跟其他插件或者IDEA本身交互，例如对IDEA功能进行扩展。</p><a id="more"></a><h3 id="扩展点Extension-points"><a href="#扩展点Extension-points" class="headerlink" title="扩展点Extension points"></a>扩展点Extension points</h3><p>如果希望你的插件可以被其他插件扩展功能，那么可以在插件中声明<code>extension points</code>。每个扩展点定义一个可以访问它的类或者接口。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">extensionPoints</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">extensionPoint</span> <span class="attr">name</span>=<span class="string">"MyExtensionPoint1"</span> <span class="attr">beanClass</span>=<span class="string">"MyPlugin.MyBeanClass1"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">extensionPoint</span> <span class="attr">name</span>=<span class="string">"MyExtensionPoint2"</span> <span class="attr">interface</span>=<span class="string">"MyPlugin.MyInterface"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">extensionPoints</span>&gt;</span></div></pre></td></tr></table></figure></p><ul><li><code>interface</code>属性设置一个接口，扩展时需要实现此接口</li><li><code>beanClass</code>属性设置一个bean类，包含使用<code>@Attribute</code>注解标注的属性。</li></ul><p>例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanClass1</span> <span class="keyword">extends</span> <span class="title">AbstractExtensionPointBean</span> </span>&#123;</div><div class="line">  <span class="meta">@Attribute</span>(<span class="string">"key"</span>)</div><div class="line">  <span class="keyword">public</span> String key;</div><div class="line"></div><div class="line">  <span class="meta">@Attribute</span>(<span class="string">"implementationClass"</span>)</div><div class="line">  <span class="keyword">public</span> String implementationClass;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> key;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getClass</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> implementationClass;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>如果要扩展它，需要包含<code>key</code>和<code>implementationClass</code>属性。（见下文）</p><h3 id="扩展Extensions"><a href="#扩展Extensions" class="headerlink" title="扩展Extensions"></a>扩展Extensions</h3><p>如果希望扩展别的插件或者IDEA的功能，那么可以声明<code>extensions</code>。<br>在注册<code>extensions</code>元素时，需要设置<code>defaultExtensionNs</code>属性为如下两个值之一：</p><ul><li><code>com.intellij</code>：扩展IDEA功能</li><li><code>{ID of a plugin}</code>：扩展其他插件的功能</li></ul><p>例如，我们要扩展IDEA的<code>appStarter</code>和<code>applicationConfigurable</code>扩展点，还有上面我们声明的<code>MyExtensionPoint1</code>扩展点：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Declare extensions to access extension points in the IntelliJ Platform.</span></div><div class="line"><span class="comment">     These extension points have been declared using the "interface" attribute.</span></div><div class="line"><span class="comment">--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">extensions</span> <span class="attr">defaultExtensionNs</span>=<span class="string">"com.intellij"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">appStarter</span> <span class="attr">implementation</span>=<span class="string">"MyTestPackage.MyTestExtension1"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">applicationConfigurable</span> <span class="attr">implementation</span>=<span class="string">"MyTestPackage.MyTestExtension2"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- Declare extensions to access extension points in a custom plugin</span></div><div class="line"><span class="comment">     The MyExtensionPoint1 extension point has been declared using *beanClass* attribute.</span></div><div class="line"><span class="comment">--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">extensions</span> <span class="attr">defaultExtensionNs</span>=<span class="string">"MyPluginID"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">MyExtensionPoint1</span> <span class="attr">key</span>=<span class="string">"keyValue"</span> <span class="attr">implementationClass</span>=<span class="string">"MyTestPackage.MyClassImpl"</span>&gt;</span><span class="tag">&lt;/<span class="name">MyExtensionPoint1</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></div></pre></td></tr></table></figure></p><h3 id="IDEA扩展点列表"><a href="#IDEA扩展点列表" class="headerlink" title="IDEA扩展点列表"></a>IDEA扩展点列表</h3><ul><li><a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-d00d8b4ae3ed33097972b8a4286b336bf4ffcfab/platform/platform-resources/src/META-INF/LangExtensionPoints.xml" target="_blank" rel="external">LangExtensionPoints.xml</a></li><li><a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-d00d8b4ae3ed33097972b8a4286b336bf4ffcfab/platform/platform-resources/src/META-INF/PlatformExtensionPoints.xml" target="_blank" rel="external">PlatformExtensionPoints.xml</a></li><li><a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-d00d8b4ae3ed33097972b8a4286b336bf4ffcfab/platform/platform-resources/src/META-INF/VcsExtensionPoints.xml" target="_blank" rel="external">VcsExtensionPoints.xml</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;IDEA提供扩展点的概念，这样我们可以跟其他插件或者IDEA本身交互，例如对IDEA功能进行扩展。&lt;/p&gt;
    
    </summary>
    
      <category term="idea" scheme="https://damon4u.github.io/categories/idea/"/>
    
      <category term="java" scheme="https://damon4u.github.io/categories/idea/java/"/>
    
    
      <category term="idea" scheme="https://damon4u.github.io/tags/idea/"/>
    
  </entry>
  
  <entry>
    <title>IDEA插件开发（二）DOM操作XML文件</title>
    <link href="https://damon4u.github.io//blog/2018/10/IDEA%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89DOM%E6%93%8D%E4%BD%9CXML%E6%96%87%E4%BB%B6.html"/>
    <id>https://damon4u.github.io//blog/2018/10/IDEA插件开发（二）DOM操作XML文件.html</id>
    <published>2018-10-10T08:41:50.000Z</published>
    <updated>2018-10-12T14:31:38.245Z</updated>
    
    <content type="html"><![CDATA[<h3 id="传统XML读写操作的弊端"><a href="#传统XML读写操作的弊端" class="headerlink" title="传统XML读写操作的弊端"></a>传统XML读写操作的弊端</h3><p>假如我们有一个xml文件如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">foo</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bar</span>&gt;</span>42<span class="tag">&lt;/<span class="name">bar</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bar</span>&gt;</span>239<span class="tag">&lt;/<span class="name">bar</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">foo</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></div></pre></td></tr></table></figure></p><p>我们想读取第二个bar元素的值239，我们可能会直接这样写：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">file.getDocument().getRootTag().findFirstSubTag(<span class="string">"foo"</span>).</div><div class="line">findSubTags(<span class="string">"bar"</span>)[<span class="number">1</span>].getValue().getTrimmedText()</div></pre></td></tr></table></figure></p><p>但这样是很危险的，因为任何一个元素都可能产生空指针。所以需要这样写：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">XmlFile file = ...;</div><div class="line"><span class="keyword">final</span> XmlDocument document = file.getDocument();</div><div class="line"><span class="keyword">if</span> (document != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">final</span> XmlTag rootTag = document.getRootTag();</div><div class="line">    <span class="keyword">if</span> (rootTag != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> XmlTag foo = rootTag.findFirstSubTag(<span class="string">"foo"</span>);</div><div class="line">        <span class="keyword">if</span> (foo != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> XmlTag[] bars = foo.findSubTags(<span class="string">"bar"</span>);</div><div class="line">            <span class="keyword">if</span> (bars.length &gt; <span class="number">1</span>) &#123;</div><div class="line">                String s = bars[<span class="number">1</span>].getValue().getTrimmedText();</div><div class="line">                <span class="comment">// do something</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>这样的写法看起来很臃肿，有一种更好的方案是使用DOM。</p><a id="more"></a><h3 id="使用DOM操作XML"><a href="#使用DOM操作XML" class="headerlink" title="使用DOM操作XML"></a>使用DOM操作XML</h3><p>用 <strong>Document Object Model</strong> (DOM) 来改写上面的写法。<br>首先需要继承<code>DomElement</code>，为每一个xml元素创建接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Root</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">intellij</span>.<span class="title">util</span>.<span class="title">xml</span>.<span class="title">DomElement</span> </span>&#123;</div><div class="line">    <span class="function">Foo <span class="title">getFoo</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Foo</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">intellij</span>.<span class="title">util</span>.<span class="title">xml</span>.<span class="title">DomElement</span> </span>&#123;</div><div class="line">    <span class="function">List&lt;Bar&gt; <span class="title">getBars</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Bar</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">intellij</span>.<span class="title">util</span>.<span class="title">xml</span>.<span class="title">DomElement</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">getValue</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>接下来需要继承<code>DomFileDescription</code>，构造函数中传入根元素名字和根元素接口，并注册到扩展点<code>com.intellij.dom.fileDescription</code>中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDescription</span> <span class="keyword">extends</span> <span class="title">DomFileDescription</span>&lt;<span class="title">Root</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDescription</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Root.class, <span class="string">"root"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>注册：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">extensions</span> <span class="attr">defaultExtensionNs</span>=<span class="string">"com.intellij"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dom.fileDescription</span> <span class="attr">implementation</span>=<span class="string">"MyDescription"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></div></pre></td></tr></table></figure></p><p>接下来就可以只用<code>DomManager</code>获取元素了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DomManager manager = DomManager.getDomManager(project);</div><div class="line">Root root = manager.getFileElement(file).getRootElement();</div><div class="line">List&lt;Bar&gt; bars = root.getFoo().getBars();</div><div class="line"><span class="keyword">if</span> (bars.size() &gt; <span class="number">1</span>) &#123;</div><div class="line">    String s = bars.get(<span class="number">1</span>).getValue();</div><div class="line">    <span class="comment">// do something</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>有时候我们想要从项目的xml文件中找到某个<code>DomElement</code>进行操作，可以使用<code>DomService</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &lt;T extends DomElement&gt; <span class="function">Collection&lt;T&gt; <span class="title">findDomElements</span><span class="params">(@NotNull Project project, Class&lt;T&gt; clazz)</span> </span>&#123;</div><div class="line">    GlobalSearchScope scope = GlobalSearchScope.allScope(project);</div><div class="line">    List&lt;DomFileElement&lt;T&gt;&gt; elements = DomService.getInstance().getFileElements(clazz, project, scope);</div><div class="line">    <span class="keyword">return</span> Collections2.transform(elements, DomFileElement::getRootElement);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>参考资料：<br><a href="https://www.jetbrains.org/intellij/sdk/docs/reference_guide/frameworks_and_external_apis/xml_dom_api.html" target="_blank" rel="external">XML DOM API</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;传统XML读写操作的弊端&quot;&gt;&lt;a href=&quot;#传统XML读写操作的弊端&quot; class=&quot;headerlink&quot; title=&quot;传统XML读写操作的弊端&quot;&gt;&lt;/a&gt;传统XML读写操作的弊端&lt;/h3&gt;&lt;p&gt;假如我们有一个xml文件如下：&lt;br&gt;&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;root&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;foo&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;bar&lt;/span&gt;&amp;gt;&lt;/span&gt;42&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;bar&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;bar&lt;/span&gt;&amp;gt;&lt;/span&gt;239&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;bar&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;foo&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;root&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们想读取第二个bar元素的值239，我们可能会直接这样写：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;file.getDocument().getRootTag().findFirstSubTag(&lt;span class=&quot;string&quot;&gt;&quot;foo&quot;&lt;/span&gt;).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;findSubTags(&lt;span class=&quot;string&quot;&gt;&quot;bar&quot;&lt;/span&gt;)[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;].getValue().getTrimmedText()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但这样是很危险的，因为任何一个元素都可能产生空指针。所以需要这样写：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;XmlFile file = ...;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; XmlDocument document = file.getDocument();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (document != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; XmlTag rootTag = document.getRootTag();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (rootTag != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; XmlTag foo = rootTag.findFirstSubTag(&lt;span class=&quot;string&quot;&gt;&quot;foo&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (foo != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; XmlTag[] bars = foo.findSubTags(&lt;span class=&quot;string&quot;&gt;&quot;bar&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (bars.length &amp;gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                String s = bars[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;].getValue().getTrimmedText();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// do something&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这样的写法看起来很臃肿，有一种更好的方案是使用DOM。&lt;/p&gt;
    
    </summary>
    
      <category term="idea" scheme="https://damon4u.github.io/categories/idea/"/>
    
      <category term="java" scheme="https://damon4u.github.io/categories/idea/java/"/>
    
    
      <category term="idea" scheme="https://damon4u.github.io/tags/idea/"/>
    
  </entry>
  
  <entry>
    <title>IDEA插件开发（一）环境搭建与第一个工程</title>
    <link href="https://damon4u.github.io//blog/2018/10/IDEA%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B8%8E%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%B7%A5%E7%A8%8B.html"/>
    <id>https://damon4u.github.io//blog/2018/10/IDEA插件开发（一）环境搭建与第一个工程.html</id>
    <published>2018-10-09T08:41:50.000Z</published>
    <updated>2018-10-12T14:31:38.264Z</updated>
    
    <content type="html"><![CDATA[<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>官方推荐使用社区版IDEA开发插件，因为方便调试核心代码。</p><blockquote><p>You may use IntelliJ IDEA Ultimate as an alternative, but debugging the core code will only work with the Community Edition.</p></blockquote><p>我下载的版本是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">IntelliJ IDEA 2018.2.4 (Community Edition)</div><div class="line">Build #IC-182.4505.22, built on September 18, 2018</div></pre></td></tr></table></figure></p><p>那么在<a href="https://github.com/JetBrains/intellij-community/tree/182.4505" target="_blank" rel="external">IntelliJ IDEA Community Edition</a> 下载对应版本的源码，解压后为<code>intellij-community-182.4505</code>。<br><a id="more"></a><br>首先需要创建一个IntelliJ Platform SDK。<br>打开项目配置窗口，<strong>File | Project Structure</strong>，选择SDKs，点击添加按钮，选择IntelliJ Platform Plugin SDK：<br><img src="/images/idea-plugin1.png" alt=""><br>默认使用弹出的IDEA社区版根目录即可，点击打开：<br><img src="/images/idea-plugin2.png" alt=""><br>然后会让选择JDK版本，使用1.8：<br><img src="/images/idea-plugin3.png" alt=""><br>最后给SDK配置源码路径，选择Sourcepath，点击加号添加，选择刚才下载解压的intellij-community-182.4505文件夹，添加全部源码：<br><img src="/images/idea-plugin4.png" alt=""></p><p>这样，开发IDEA插件的SDK环境就创建好了，注意其中有个路径是Sandbox Home，即沙箱位置：/Users/damon4u/Library/Caches/IdeaIC2018.2/plugins-sandbox<br>我们在运行插件时，IDEA会再运行一个沙箱环境IDEA，因为IDEA本身也就是一个java环境，这个路径会存放沙箱环境的配置数据，如果发现调试过程中出现类似缓存现象，新特性不生效，那么可以手动删除这里的数据。</p><h3 id="第一个工程"><a href="#第一个工程" class="headerlink" title="第一个工程"></a>第一个工程</h3><p>创建工程时选择IntelliJ Platform Plugin：<br><img src="/images/idea-plugin5.png" alt=""><br>新创建的工程结构如下：<br><img src="/images/idea-plugin6.png" alt=""><br>src目录下放置源文件，plugin.xml用来注册组件。</p><p>下面创建一个官方给的简单例子，在菜单栏添加一个选项，点击后弹出一个窗口。<br>首先需要创建一个Action，继承<code>AnAction</code>类。通过实现<code>actionPerformed</code>方法实现功能。<br>右键创建一个Action：<br><img src="/images/idea-plugin7.png" alt=""><br>然后输入信息：<br><img src="/images/idea-plugin8.png" alt=""></p><ul><li>Action ID：Action的唯一ID，推荐使用<code>PluginName.ID</code>。</li><li>Class Name：创建的Action类的名字。</li><li>Name：标题栏中选项文案。</li><li>Description：可选，IDEA状态栏的提示文案。</li><li>Add to Group：Groups是Action要放到哪个组里，比如主菜单栏<code>MainMenu</code>，Window下拉菜单栏<code>WindowMenu</code>等。Actions和Anchor配合使用，可以选择放在下拉菜单中的开始，最后，或者某个已有选项的前面或者后面。</li><li>Keyboard Shortcuts：配置快捷键。</li></ul><p>IDEA帮我们创建了一个<code>SayHelloAction</code>，我们需要实现<code>actionPerformed</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SayHelloAction</span> <span class="keyword">extends</span> <span class="title">AnAction</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(AnActionEvent e)</span> </span>&#123;</div><div class="line">        <span class="comment">// alter to say hello.</span></div><div class="line">        Messages.showMessageDialog(<span class="string">"Hello!"</span>, <span class="string">"Information"</span>, Messages.getInformationIcon());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>IDEA已经帮我们把创建的Action注册到<code>plugin.xml</code>中：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">actions</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- Add your actions here --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">action</span> <span class="attr">id</span>=<span class="string">"DemoPlugin.SayHello"</span> <span class="attr">class</span>=<span class="string">"com.damon4u.idea.action.SayHelloAction"</span> <span class="attr">text</span>=<span class="string">"Say Hello!"</span></span></div><div class="line"><span class="tag">          <span class="attr">description</span>=<span class="string">"A demo plugin to say hello."</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">add-to-group</span> <span class="attr">group-id</span>=<span class="string">"WindowMenu"</span> <span class="attr">anchor</span>=<span class="string">"first"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">action</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">actions</span>&gt;</span></div></pre></td></tr></table></figure></p><p>这样第一个工程就写完了。点击运行按钮，启动沙箱环境。<br>在Window下拉菜单中点击我们的Say Hello选项，弹出提示框就算成功了。<br><img src="/images/idea-plugin11.png" alt=""></p><h3 id="关于Mac沙箱环境菜单栏触发问题"><a href="#关于Mac沙箱环境菜单栏触发问题" class="headerlink" title="关于Mac沙箱环境菜单栏触发问题"></a>关于Mac沙箱环境菜单栏触发问题</h3><p>在Mac Mini（macOS High Sierra 10.13.6）运行插件时，点击菜单栏并没有反应，但是在MacBook Pro上运行时就没问题。<br>试着换了一下触发位置，比如绑定到generate弹窗中：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">add-to-group</span> <span class="attr">group-id</span>=<span class="string">"GenerateGroup"</span> <span class="attr">anchor</span>=<span class="string">"first"</span>/&gt;</span></div></pre></td></tr></table></figure></p><p>也可以触发。<br>后来发现，沙盒环境下自带的菜单栏点击都没有反应。。。后来在<a href="https://intellij-support.jetbrains.com/hc/en-us/community/posts/360000005390-Action-is-not-triggered-from-main-menu" target="_blank" rel="external">Action is not triggered from main menu</a> 中找到了答案。<br>在运行沙箱环境时，添加参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-Dapple.laf.useScreenMenuBar=false</div></pre></td></tr></table></figure></p><p><img src="/images/idea-plugin9.png" alt=""><br>这个参数是为了让Mac下的Java桌面程序的菜单栏不放到系统顶部，而是在应用自身顶部：<br><img src="/images/idea-plugin10.png" alt=""></p><h3 id="打包插件"><a href="#打包插件" class="headerlink" title="打包插件"></a>打包插件</h3><p>插件开发好后，可以将它打包成jar包或者zip包（包含依赖类库），供别人使用。<br>选择 <strong>Build | Prepare Plugin Module <module name=""> for Deployment</module></strong>.<br>这样就会打包出一个jar包。<br>在插件中选择安装本地插件，就能使用了。</p><p>参考资料<br><a href="https://www.jetbrains.org/intellij/sdk/docs/basics/getting_started.html" target="_blank" rel="external">官方文档Creating Your First Plugin</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;环境搭建&quot;&gt;&lt;a href=&quot;#环境搭建&quot; class=&quot;headerlink&quot; title=&quot;环境搭建&quot;&gt;&lt;/a&gt;环境搭建&lt;/h3&gt;&lt;p&gt;官方推荐使用社区版IDEA开发插件，因为方便调试核心代码。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;You may use IntelliJ IDEA Ultimate as an alternative, but debugging the core code will only work with the Community Edition.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我下载的版本是&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;IntelliJ IDEA 2018.2.4 (Community Edition)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Build #IC-182.4505.22, built on September 18, 2018&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;那么在&lt;a href=&quot;https://github.com/JetBrains/intellij-community/tree/182.4505&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;IntelliJ IDEA Community Edition&lt;/a&gt; 下载对应版本的源码，解压后为&lt;code&gt;intellij-community-182.4505&lt;/code&gt;。&lt;br&gt;
    
    </summary>
    
      <category term="idea" scheme="https://damon4u.github.io/categories/idea/"/>
    
      <category term="java" scheme="https://damon4u.github.io/categories/idea/java/"/>
    
    
      <category term="idea" scheme="https://damon4u.github.io/tags/idea/"/>
    
  </entry>
  
  <entry>
    <title>lambda表达式</title>
    <link href="https://damon4u.github.io//blog/2018/09/lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%92%8C%E6%B5%81%E6%93%8D%E4%BD%9C.html"/>
    <id>https://damon4u.github.io//blog/2018/09/lambda表达式和流操作.html</id>
    <published>2018-09-29T08:41:50.000Z</published>
    <updated>2018-09-29T04:47:14.822Z</updated>
    
    <content type="html"><![CDATA[<h3 id="什么是λ表达式"><a href="#什么是λ表达式" class="headerlink" title="什么是λ表达式"></a>什么是λ表达式</h3><p>λ表达式本质上是一个匿名方法。让我们来看下面这个例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> x + y;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>转成λ表达式后是这个样子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(<span class="keyword">int</span> x, <span class="keyword">int</span> y) -&gt; x + y;</div></pre></td></tr></table></figure></p><p>参数类型也可以省略，Java编译器会根据上下文推断出来：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//返回两数之和</span></div><div class="line">(x, y) -&gt; x + y;</div></pre></td></tr></table></figure></p><p>或者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//显式指明返回值</span></div><div class="line">(x, y) -&gt; &#123; <span class="keyword">return</span> x + y; &#125;</div></pre></td></tr></table></figure></p><p>可见λ表达式有三部分组成：参数列表，箭头(<code>-&gt;</code>)，以及一个表达式或语句块。<br>下面这个例子里的λ表达式没有参数，也没有返回值（相当于一个方法接受0个参数，返回<code>void</code>，其实就是<code>Runnable</code>里<code>run</code>方法的一个实现）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">() -&gt; &#123; System.out.println(<span class="string">"Hello Lambda!"</span>); &#125;</div></pre></td></tr></table></figure></p><p>如果只有一个参数且可以被Java推断出类型，那么参数列表的括号也可以省略：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">c -&gt; &#123; <span class="keyword">return</span> c.size(); &#125;</div></pre></td></tr></table></figure></p><a id="more"></a><h3 id="λ表达式的类型（它是Object吗？）"><a href="#λ表达式的类型（它是Object吗？）" class="headerlink" title="λ表达式的类型（它是Object吗？）"></a>λ表达式的类型（它是Object吗？）</h3><p>λ表达式可以被当做是一个<code>Object</code>(注意措辞)。λ表达式的类型，叫做“目标类型(<code>target type</code>)”。λ表达式的目标类型是“函数接口(<code>functional interface</code>)”，这是JDK8新引入的概念。<br>它的定义是：一个接口，如果 <strong>只有一个</strong> 显式声明的抽象方法，那么它就是一个函数接口。 一般用<code>@FunctionalInterface</code>标注出来(也可以不标)。举例如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123; <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>; &#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callable</span>&lt;<span class="title">V</span>&gt; </span>&#123; <span class="function">V <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>; &#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ActionListener</span> </span>&#123; <span class="function"><span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span></span>; &#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparator</span>&lt;<span class="title">T</span>&gt; </span>&#123; <span class="function"><span class="keyword">int</span> <span class="title">compare</span><span class="params">(T o1, T o2)</span></span>; <span class="function"><span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span></span>; &#125;</div></pre></td></tr></table></figure></p><p>注意最后这个<code>Comparator</code>接口。它里面声明了两个方法，貌似不符合函数接口的定义，但它的确是函数接口。这是因为<code>equals</code>方法是<code>Object</code>的，所有的接口都会声明<code>Object</code>的<code>public</code>方法——虽然大多是隐式的。<br>所以，<code>Comparator</code>显式的声明了<code>equals</code>不影响它依然是个函数接口。你可以用一个λ表达式为一个函数接口赋值：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Runnable r1 = () -&gt; &#123;System.out.println(<span class="string">"Hello Lambda!"</span>);&#125;;</div></pre></td></tr></table></figure></p><p>然后再赋值给一个<code>Object</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Object obj = r1;</div></pre></td></tr></table></figure></p><p>但却不能这样干：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ERROR! Object is not a functional interface!</span></div><div class="line">Object obj = () -&gt; &#123;System.out.println(<span class="string">"Hello Lambda!"</span>);&#125;;</div></pre></td></tr></table></figure></p><p>必须显式的转型成一个函数接口才可以：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// correct</span></div><div class="line">Object o = (Runnable) () -&gt; &#123; System.out.println(<span class="string">"hi"</span>); &#125;;</div></pre></td></tr></table></figure></p><p>一个λ表达式只有在转型成一个函数接口后才能被当做<code>Object</code>使用。所以下面这句也不能编译：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//错误! 目标类型不明</span></div><div class="line">System.out.println( () -&gt; &#123;&#125; );</div></pre></td></tr></table></figure></p><p>必须先转型:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 正确</span></div><div class="line">System.out.println( (Runnable)() -&gt; &#123;&#125; );</div></pre></td></tr></table></figure></p><p>假设你自己写了一个函数接口，长的跟<code>Runnable</code>一模一样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyRunnable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>那么<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Runnable r1 =    () -&gt; &#123;System.out.println(<span class="string">"Hello Lambda!"</span>);&#125;;</div><div class="line">MyRunnable2 r2 = () -&gt; &#123;System.out.println(<span class="string">"Hello Lambda!"</span>);&#125;;</div></pre></td></tr></table></figure></p><p>都是正确的写法。这说明一个λ表达式可以有多个目标类型（函数接口），只要函数匹配成功即可。但需注意一个λ表达式必须至少有一个目标类型。JDK预定义了很多函数接口以避免用户重复定义。<br>最典型的是<code>Function</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Function</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span>&#123;  </div><div class="line">    <span class="function">R <span class="title">apply</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>这个接口代表一个函数，接受一个<code>T</code>类型的参数，并返回一个<code>R</code>类型的返回值。另一个预定义函数接口叫做<code>Consumer</code>，跟<code>Function</code>的唯一不同是它没有返回值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Consumer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">accept</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>还有一个<code>Predicate</code>，用来判断某项条件是否满足。经常用来进行筛滤操作：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Predicate</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">test</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>综上所述，一个λ表达式其实就是定义了一个匿名方法，只不过这个方法必须符合至少一个函数接口。</p><h3 id="λ表达式的使用"><a href="#λ表达式的使用" class="headerlink" title="λ表达式的使用"></a>λ表达式的使用</h3><p>λ表达式用在何处<br><strong>λ表达式主要用于替换以前广泛使用的内部匿名类，各种回调，比如事件响应器、传入<code>Thread</code>类的<code>Runnable</code>等。</strong><br>看下面的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Thread oldSchool = <span class="keyword">new</span> Thread( <span class="keyword">new</span> Runnable () &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"This is from an anonymous class."</span>);</div><div class="line">    &#125;</div><div class="line">&#125; );</div><div class="line">Thread gaoDuanDaQiShangDangCi = <span class="keyword">new</span> Thread( () -&gt; &#123;</div><div class="line">    System.out.println(<span class="string">"This is from an anonymous method (lambda exp)."</span>);</div><div class="line">&#125; );</div></pre></td></tr></table></figure></p><p>注意第二个线程里的λ表达式，你并不需要显式地把它转成一个<code>Runnable</code>，因为Java能根据上下文自动推断出来：一个<code>Thread</code>的构造函数接受一个<code>Runnable</code>参数，而传入的λ表达式正好符合其<code>run()</code>函数，所以Java编译器推断它为<code>Runnable</code>。</p><p>从形式上看，λ表达式只是为你节省了几行代码。但将λ表达式引入Java的动机并不仅仅为此。Java8有一个短期目标和一个长期目标。短期目标是：配合“集合类批处理操作”的内部迭代和并行处理(下面将要讲到); 长期目标是将Java向函数式编程语言这个方向引导(并不是要完全变成一门函数式编程语言，只是让它有更多的函数式编程语言的特性)，也正是由于这个原因，Oracle并没有简单地使用内部类去实现λ表达式，而是使用了一种更动态、更灵活、易于将来扩展和改变的策略(<code>invokedynamic</code>)。</p><p>λ表达式与集合类批处理操作(或者叫块操作)<br>集合类的批处理操作是Java8的另一个重要特性，它与λ表达式的配合使用乃是Java8的最主要特性。集合类的批处理操作API的目的是实现集合类的”内部迭代”，并期望充分利用现代多核CPU进行并行计算。</p><p>Java8之前集合类的迭代(<code>Iteration</code>)都是外部的，即客户代码。而内部迭代意味着改由Java类库来进行迭代，而不是客户代码。例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 外部迭代</span></div><div class="line"><span class="keyword">for</span>(Object o: list) &#123;</div><div class="line">    System.out.println(o);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>可以写成：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//forEach函数实现内部迭代</span></div><div class="line">list.forEach(o -&gt; &#123;System.out.println(o);&#125;);</div></pre></td></tr></table></figure></p><p>集合类(包括<code>List</code>)现在都有一个<code>forEach</code>方法，对元素进行迭代(遍历)，所以我们不需要再写<code>for循环</code>了。<code>forEach</code>方法接受一个函数接口<code>Consumer</code>做参数，所以可以使用λ表达式。</p><p>这种内部迭代方法广泛存在于各种语言，如C++的STL算法库、Python、ruby、Scala等。</p><p>Java8为集合类引入了另一个重要概念：流(<code>stream</code>)。一个流通常以一个集合类实例为其数据源，然后在其上定义各种操作。流的API设计使用了管道(<code>pipelines</code>)模式。对流的一次操作会返回另一个流。如同IO的API或者<code>StringBuffer</code>的<code>append</code>方法那样，从而多个不同的操作可以在一个语句里串起来。看下面的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">List&lt;Shape&gt; shapes = ...</div><div class="line">shapes.stream()</div><div class="line">  .filter(s -&gt; s.getColor() == BLUE)</div><div class="line">  .forEach(s -&gt; s.setColor(RED));</div></pre></td></tr></table></figure></p><p>首先调用<code>stream</code>方法，以集合类对象shapes里面的元素为数据源，生成一个流。然后在这个流上调用<code>filter</code>方法，挑出蓝色的，返回另一个流。最后调用<code>forEach</code>方法将这些蓝色的物体喷成红色。(<code>forEach</code>方法不再返回流，而是一个终端方法，类似于<code>StringBuffer</code>在调用若干<code>append</code>之后的那个<code>toString</code>)</p><p><code>filter</code>方法的参数是<code>Predicate</code>类型，<code>forEach</code>方法的参数是<code>Consumer</code>类型，它们都是函数接口，所以可以使用λ表达式。</p><p>还有一个方法叫<code>parallelStream()</code>，顾名思义它和<code>stream()</code>一样，只不过指明要并行处理，以期充分利用现代CPU的多核特性。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 或shapes.stream().parallel()</span></div><div class="line">shapes.parallelStream();</div></pre></td></tr></table></figure></p><p>来看更多的例子。下面是典型的大数据处理方法，<code>Filter-Map-Reduce</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//给出一个String类型的数组，找出其中所有不重复的素数</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">distinctPrimary</span><span class="params">(String... numbers)</span> </span>&#123;</div><div class="line">    List&lt;String&gt; l = Arrays.asList(numbers);</div><div class="line">    List&lt;Integer&gt; r = l.stream()</div><div class="line">            .map(e -&gt; <span class="keyword">new</span> Integer(e))</div><div class="line">            .filter(e -&gt; Primes.isPrime(e))</div><div class="line">            .distinct()</div><div class="line">            .collect(Collectors.toList());</div><div class="line">    System.out.println(<span class="string">"distinctPrimary result is: "</span> + r);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>第一步: 传入一系列<code>String</code>(假设都是合法的数字)，转成一个<code>List</code>，然后调用<code>stream()</code>方法生成流。</li><li>第二步: 调用流的<code>map</code>方法把每个元素由<code>String</code>转成<code>Integer</code>，得到一个新的流。<code>map</code>方法接受一个<code>Function</code>类型的参数，上面介绍了，<code>Function</code>是个函数接口，所以这里用λ表达式。</li><li>第三步: 调用流的<code>filter</code>方法，过滤那些不是素数的数字，并得到一个新流。<code>filter</code>方法接受一个<code>Predicate</code>类型的参数，上面介绍了，<code>Predicate</code>是个函数接口，所以这里用λ表达式。</li><li>第四步: 调用流的<code>distinct</code>方法，去掉重复，并得到一个新流。这本质上是另一个<code>filter</code>操作。</li><li>第五步: 用<code>collect</code>方法将最终结果收集到一个<code>List</code>里面去。<code>collect</code>方法接受一个<code>Collector</code>类型的参数，这个参数指明如何收集最终结果。在这个例子中，结果简单地收集到一个<code>List</code>中。我们也可以用<code>Collectors.toMap(e-&gt;e, e-&gt;e)</code>把结果收集到一个<code>Map</code>中，它的意思是：把结果收到一个<code>Map</code>，用这些素数自身既作为键又作为值。<code>toMap</code>方法接受两个<code>Function</code>类型的参数，分别用以生成键和值，<code>Function</code>是个函数接口，所以这里都用λ表达式。</li></ul><p>你可能会觉得在这个例子里，<code>List l</code>被迭代了好多次，<code>map</code>，<code>filter</code>，<code>distinct</code>都分别是一次循环，效率会不好。实际并非如此。这些返回另一个<code>Stream</code>的方法都是“懒(<code>lazy</code>)”的，而最后返回最终结果的<code>collect</code>方法则是“急(<code>eager</code>)”的。在遇到<code>eager</code>方法之前，<code>lazy</code>的方法不会执行。</p><p>当遇到<code>eager</code>方法时，前面的<code>lazy</code>方法才会被依次执行。而且是管道贯通式执行。这意味着每一个元素依次通过这些管道。例如有个元素“3”，首先它被<code>map</code>成整数型3；然后通过<code>filter</code>，发现是素数，被保留下来；又通过<code>distinct</code>，如果已经有一个3了，那么就直接丢弃，如果还没有则保留。这样，3个操作其实只经过了一次循环。</p><p>除<code>collect</code>外其它的<code>eager</code>操作还有<code>forEach</code>，<code>toArray</code>，<code>reduce</code>等。</p><p>下面来看一下也许是最常用的收集器方法，<code>groupingBy</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//给出一个String类型的数组，找出其中各个素数，并统计其出现次数</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">primaryOccurrence</span><span class="params">(String... numbers)</span> </span>&#123;</div><div class="line">    List&lt;String&gt; l = Arrays.asList(numbers);</div><div class="line">    Map&lt;Integer, Integer&gt; r = l.stream()</div><div class="line">        .map(e -&gt; <span class="keyword">new</span> Integer(e))</div><div class="line">        .filter(e -&gt; Primes.isPrime(e))</div><div class="line">        .collect( Collectors.groupingBy(p-&gt;p, Collectors.summingInt(p-&gt;<span class="number">1</span>)) );</div><div class="line">    System.out.println(<span class="string">"primaryOccurrence result is: "</span> + r);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>注意这一行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Collectors.groupingBy(p-&gt;p, Collectors.summingInt(p-&gt;<span class="number">1</span>))</div></pre></td></tr></table></figure></p><p>它的意思是：把结果收集到一个<code>Map</code>中，用统计到的各个素数自身作为键，其出现次数作为值。</p><p>下面是一个<code>reduce</code>的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//给出一个String类型的数组，求其中所有不重复素数的和</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">distinctPrimarySum</span><span class="params">(String... numbers)</span> </span>&#123;</div><div class="line">    List&lt;String&gt; l = Arrays.asList(numbers);</div><div class="line">    <span class="keyword">int</span> sum = l.stream()</div><div class="line">        .map(e -&gt; <span class="keyword">new</span> Integer(e))</div><div class="line">        .filter(e -&gt; Primes.isPrime(e))</div><div class="line">        .distinct()</div><div class="line">        .reduce(<span class="number">0</span>, (x,y) -&gt; x+y); <span class="comment">// equivalent to .sum()</span></div><div class="line">    System.out.println(<span class="string">"distinctPrimarySum result is: "</span> + sum);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><code>reduce</code>方法用来产生单一的一个最终结果。</p><p>流有很多预定义的<code>reduce</code>操作，如<code>sum()</code>，<code>max()</code>，<code>min()</code>等。</p><p>再举个现实世界里的栗子比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 统计年龄在25-35岁的男女人数、比例</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boysAndGirls</span><span class="params">(List&lt;Person&gt; persons)</span> </span>&#123;</div><div class="line">    Map&lt;Integer, Integer&gt; result = persons.parallelStream().filter(p -&gt; p.getAge()&gt;=<span class="number">25</span> &amp;&amp; p.getAge()&lt;=<span class="number">35</span>).</div><div class="line">        collect(</div><div class="line">            Collectors.groupingBy(p-&gt;p.getSex(), Collectors.summingInt(p-&gt;<span class="number">1</span>))</div><div class="line">    );</div><div class="line">    System.out.print(<span class="string">"boysAndGirls result is "</span> + result);</div><div class="line">    System.out.println(<span class="string">", ratio (male : female) is "</span> + (<span class="keyword">float</span>)result.get(Person.MALE)/result.get(Person.FEMALE));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>λ表达式的更多用法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 嵌套的λ表达式</span></div><div class="line">Callable&lt;Runnable&gt; c1 = () -&gt; () -&gt; &#123; System.out.println(<span class="string">"Nested lambda"</span>); &#125;;</div><div class="line">c1.call().run();</div><div class="line"><span class="comment">// 用在条件表达式中</span></div><div class="line">Callable&lt;Integer&gt; c2 = <span class="keyword">true</span> ? (() -&gt; <span class="number">42</span>) : (() -&gt; <span class="number">24</span>);</div><div class="line">System.out.println(c2.call());</div><div class="line"><span class="comment">// 定义一个递归函数，注意须用this限定</span></div><div class="line"><span class="keyword">protected</span> UnaryOperator&lt;Integer&gt; factorial = i -&gt; i == <span class="number">0</span> ? <span class="number">1</span> : i * <span class="keyword">this</span>.factorial.apply( i - <span class="number">1</span> );</div><div class="line">System.out.println(factorial.apply(<span class="number">3</span>));</div></pre></td></tr></table></figure></p><p>在Java中，随声明随调用的方式是不行的，比如下面这样，声明了一个λ表达式<code>(x, y) -&gt; x + y</code>，同时企图通过传入实参<code>(2, 3)</code>来调用它：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> five = ( (x, y) -&gt; x + y ) (<span class="number">2</span>, <span class="number">3</span>); <span class="comment">// ERROR! try to call a lambda in-place</span></div></pre></td></tr></table></figure></p><p>这在C++中是可以的，但Java中不行。Java的λ表达式只能用作赋值、传参、返回值等。</p><h3 id="其它相关概念"><a href="#其它相关概念" class="headerlink" title="其它相关概念"></a>其它相关概念</h3><h4 id="捕获-Capture"><a href="#捕获-Capture" class="headerlink" title="捕获(Capture)"></a>捕获(Capture)</h4><p>捕获的概念在于解决在λ表达式中我们可以使用哪些外部变量(即除了它自己的参数和内部定义的本地变量)的问题。</p><p>与内部类非常相似，但有不同点。不同点在于内部类总是持有一个其外部类对象的引用。而λ表达式呢，除非在它内部用到了其外部类（包围类）对象的方法或者成员，否则它就不持有这个对象的引用。</p><p>在Java8以前，如果要在内部类访问外部对象的一个本地变量，那么这个变量必须声明为<code>final</code>才行。在Java8中，这种限制被去掉了，代之以一个新的概念，<code>effectively final</code>。它的意思是你可以声明为<code>final</code>，也可以不声明<code>final</code>但是按照<code>final</code>来用，也就是一次赋值永不改变。换句话说，保证它加上<code>final</code>前缀后不会出编译错误。</p><p>在Java8中，内部类和λ表达式都可以访问<code>effectively final</code>的本地变量。λ表达式的例子如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//包围类的成员变量</span></div><div class="line"><span class="keyword">int</span> tmp1 = <span class="number">1</span>;</div><div class="line"><span class="comment">//包围类的静态成员变量</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> tmp2 = <span class="number">2</span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCapture</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// 没有声明为final，但是effectively final的本地变量</span></div><div class="line">    <span class="keyword">int</span> tmp3 = <span class="number">3</span>;</div><div class="line">    <span class="comment">// 声明为final的本地变量</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> tmp4 = <span class="number">4</span>;</div><div class="line">    <span class="comment">// 普通本地变量</span></div><div class="line">    <span class="keyword">int</span> tmp5 = <span class="number">5</span>;</div><div class="line">    Function&lt;Integer, Integer&gt; f1 = i -&gt; i + tmp1;</div><div class="line">    Function&lt;Integer, Integer&gt; f2 = i -&gt; i + tmp2;</div><div class="line">    Function&lt;Integer, Integer&gt; f3 = i -&gt; i + tmp3;</div><div class="line">    Function&lt;Integer, Integer&gt; f4 = i -&gt; i + tmp4;</div><div class="line">    Function&lt;Integer, Integer&gt; f5 = i -&gt; &#123;</div><div class="line">        <span class="comment">// 编译错！对tmp5赋值导致它不是effectively final的</span></div><div class="line">        tmp5  += i;</div><div class="line">        <span class="keyword">return</span> tmp5;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// 编译错！对tmp5赋值导致它不是effectively final的</span></div><div class="line">    tmp5 = <span class="number">9</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>Java要求本地变量<code>final</code>或者<code>effectively final</code>的原因是多线程并发问题。内部类、λ表达式都有可能在不同的线程中执行，允许多个线程同时修改一个本地变量不符合Java的设计理念。</p><h4 id="方法引用-Method-reference"><a href="#方法引用-Method-reference" class="headerlink" title="方法引用(Method reference)"></a>方法引用(Method reference)</h4><p>任何一个λ表达式都可以代表某个函数接口的唯一方法的匿名描述符。我们也可以使用某个类的某个具体方法来代表这个描述符，叫做方法引用。 例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Integer::parseInt <span class="comment">//静态方法引用</span></div><div class="line">System.out::print <span class="comment">//实例方法引用</span></div><div class="line">Person::<span class="keyword">new</span>       <span class="comment">//构造器引用</span></div></pre></td></tr></table></figure></p><p>下面是一组例子，教你使用方法引用代替λ表达式：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// c1 与 c2 是一样的（静态方法引用）</span></div><div class="line">Comparator&lt;Integer&gt; c2 = (x, y) -&gt; Integer.compare(x, y);</div><div class="line">Comparator&lt;Integer&gt; c1 = Integer::compare;</div><div class="line"><span class="comment">// 下面两句是一样的（实例方法引用1）</span></div><div class="line">persons.forEach(e -&gt; System.out.println(e));</div><div class="line">persons.forEach(System.out::println);</div><div class="line"><span class="comment">// 下面两句是一样的（实例方法引用2）</span></div><div class="line">persons.forEach(person -&gt; person.eat());</div><div class="line">persons.forEach(Person::eat);</div><div class="line"><span class="comment">// 下面两句是一样的（构造器引用）</span></div><div class="line">strList.stream().map(s -&gt; <span class="keyword">new</span> Integer(s));</div><div class="line">strList.stream().map(Integer::<span class="keyword">new</span>);</div></pre></td></tr></table></figure></p><p>使用方法引用，你的程序会变得更短些。现在distinctPrimarySum方法可以改写如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">distinctPrimarySum</span><span class="params">(String... numbers)</span> </span>&#123;</div><div class="line">    List&lt;String&gt; l = Arrays.asList(numbers);</div><div class="line">    <span class="keyword">int</span> sum = l.stream().map(Integer::<span class="keyword">new</span>).filter(Primes::isPrime).distinct().sum();</div><div class="line">    System.out.println(<span class="string">"distinctPrimarySum result is: "</span> + sum);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="默认方法-Default-method"><a href="#默认方法-Default-method" class="headerlink" title="默认方法(Default method)"></a>默认方法(Default method)</h4><p>Java8中，接口声明里可以有方法实现了，叫做默认方法。在此之前，接口里的方法全部是抽象方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">m1</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">m2</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello default method!"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>这实际上混淆了接口和抽象类，但一个类仍然可以实现多个接口，而只能继承一个抽象类。</p><p>这么做的原因是：由于<code>Collection</code>库需要为批处理操作添加新的方法，如<code>forEach()</code>，<code>stream()</code>等，但是不能修改现有的<code>Collection</code>接口——如果那样做的话所有的实现类都要进行修改，包括很多客户自制的实现类。所以只好使用这种妥协的办法。</p><p>如此一来，我们就面临一种类似多继承的问题。如果类<code>Sub</code>继承了两个接口，<code>Base1</code>和<code>Base2</code>，而这两个接口恰好具有完全相同的两个默认方法，那么就会产生冲突。这时<code>Sub</code>类就必须通过重载来显式指明自己要使用哪一个接口的实现（或者提供自己的实现）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sub</span> <span class="keyword">implements</span> <span class="title">Base1</span>, <span class="title">Base2</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;</div><div class="line">        Base1.<span class="keyword">super</span>.hello(); <span class="comment">//使用Base1的实现</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>除了默认方法，Java8的接口也可以有静态方法的实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterf</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">m1</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">m2</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello default method!"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">m3</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello static method in Interface!"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="生成器函数-Generator-function"><a href="#生成器函数-Generator-function" class="headerlink" title="生成器函数(Generator function)"></a>生成器函数(Generator function)</h4><p>有时候一个流的数据源不一定是一个已存在的集合对象，也可能是个“生成器函数”。一个生成器函数会产生一系列元素，供给一个流。 <code>Stream.generate(Supplier s)</code>就是一个生成器函数。其中参数<code>Supplier</code>是一个函数接口，里面有唯一的抽象方法<code>get()</code>。</p><p>下面这个例子生成并打印5个随机数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Stream.generate(Math::random).limit(<span class="number">5</span>).forEach(System.out::println);</div></pre></td></tr></table></figure></p><p>注意这个<code>limit(5)</code>，如果没有这个调用，那么这条语句会永远地执行下去。也就是说这个生成器是无穷的。这种调用叫做终结操作，或者短路(<code>short-circuiting</code>)操作。</p><p>参考资料<br>OpenJdk: <a href="http://openjdk.java.net/projects/lambda/" target="_blank" rel="external">http://openjdk.java.net/projects/lambda/</a><br>ORACLE: <a href="http://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html" target="_blank" rel="external">http://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html</a><br>原文转载自：<a href="http://blog.csdn.net/ioriogami/article/details/12782141/" target="_blank" rel="external">http://blog.csdn.net/ioriogami/article/details/12782141/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;什么是λ表达式&quot;&gt;&lt;a href=&quot;#什么是λ表达式&quot; class=&quot;headerlink&quot; title=&quot;什么是λ表达式&quot;&gt;&lt;/a&gt;什么是λ表达式&lt;/h3&gt;&lt;p&gt;λ表达式本质上是一个匿名方法。让我们来看下面这个例子：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; x, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; y)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; x + y;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;转成λ表达式后是这个样子：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; x, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; y) -&amp;gt; x + y;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;参数类型也可以省略，Java编译器会根据上下文推断出来：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//返回两数之和&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;(x, y) -&amp;gt; x + y;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;或者&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//显式指明返回值&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;(x, y) -&amp;gt; &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; x + y; &amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可见λ表达式有三部分组成：参数列表，箭头(&lt;code&gt;-&amp;gt;&lt;/code&gt;)，以及一个表达式或语句块。&lt;br&gt;下面这个例子里的λ表达式没有参数，也没有返回值（相当于一个方法接受0个参数，返回&lt;code&gt;void&lt;/code&gt;，其实就是&lt;code&gt;Runnable&lt;/code&gt;里&lt;code&gt;run&lt;/code&gt;方法的一个实现）：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;() -&amp;gt; &amp;#123; System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Hello Lambda!&quot;&lt;/span&gt;); &amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果只有一个参数且可以被Java推断出类型，那么参数列表的括号也可以省略：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;c -&amp;gt; &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; c.size(); &amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="https://damon4u.github.io/categories/java/"/>
    
    
      <category term="java" scheme="https://damon4u.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>java包装类</title>
    <link href="https://damon4u.github.io//blog/2018/09/%E5%8C%85%E8%A3%85%E7%B1%BB.html"/>
    <id>https://damon4u.github.io//blog/2018/09/包装类.html</id>
    <published>2018-09-27T08:41:50.000Z</published>
    <updated>2018-09-27T12:57:24.632Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-自动装箱与自动拆箱"><a href="#1-自动装箱与自动拆箱" class="headerlink" title="1. 自动装箱与自动拆箱"></a>1. 自动装箱与自动拆箱</h3><p>那我们来分析<code>Integer i = 5;</code>的过程；<br>在jdk1.5以前，这样的代码是错误的，必须要通过<code>Integer i = new Integer(5);</code>这样的语句实现；<br>而在jdk1.5以后，Java提供了自动装箱的功能，只需<code>Integer i = 5;</code>这样的语句就能实现基本数据类型传给其包装类，JVM为我们执行了<code>Integer i = Integer.valueOf(5);</code>。</p><p>相对应的，把基本数据从对应包装类中取出的过程就是拆箱，如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Integer i = 5；</div><div class="line">int j = i; // 这样的过程就是自动拆箱</div></pre></td></tr></table></figure></p><p>源码方面，装箱过程是通过调用包装器的<code>valueOf</code>方法实现的，而拆箱过程是通过调用包装器的<code>xxxValue</code>方法实现的。（xxx代表对应的基本数据类型）</p><a id="more"></a><h3 id="2-比较大小"><a href="#2-比较大小" class="headerlink" title="2. 比较大小"></a>2. 比较大小</h3><h4 id="2-1-整型"><a href="#2-1-整型" class="headerlink" title="2.1 整型"></a>2.1 整型</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInteger</span><span class="params">()</span> </span>&#123;</div><div class="line">    Integer n1 = <span class="number">1</span>;</div><div class="line">    Integer n2 = <span class="number">1</span>;</div><div class="line">    Integer n3 = <span class="number">200</span>;</div><div class="line">    Integer n4 = <span class="number">200</span>;</div><div class="line">    assertTrue(n1 == n2);</div><div class="line">    assertTrue(n1.equals(n2));</div><div class="line">    assertFalse(n3 == n4);</div><div class="line">    assertTrue(n3.equals(n4));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>对于Integer，需要注意它的<code>valueOf</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* This method will always cache values in the range -128 to 127, inclusive, and may cache other values outside of this range.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)</div><div class="line">        <span class="keyword">return</span> IntegerCache.cache[i + (-IntegerCache.low)];</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Integer(i);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>这里引入了<code>IntegerCache</code>，缓存-128到127之间的常用数值，注意，范围外的数值也有可能被缓存。<br>即在通过valueOf方法创建Integer对象的时候，如果数值在[-128,127]之间，便返回指向IntegerCache.cache中已经存在的对象的引用；否则创建一个新的Integer对象。<br>上面代码中，n1和n2的数值都为1，在缓存范围内，所以引用了同一个对象。</p><p>类似的，Byte、Character、Short、Integer、Long这几个整型包装类都会缓存[-128,127]之间的数值。</p><h4 id="2-2-浮点型"><a href="#2-2-浮点型" class="headerlink" title="2.2 浮点型"></a>2.2 浮点型</h4><p>与整型不同，浮点型包装类Float和Double的valueOf并不会缓存常用值，而是直接新建对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Double <span class="title">valueOf</span><span class="params">(<span class="keyword">double</span> d)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Double(d);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="2-3-布尔型"><a href="#2-3-布尔型" class="headerlink" title="2.3 布尔型"></a>2.3 布尔型</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBoolean</span><span class="params">()</span> </span>&#123;</div><div class="line">    Boolean b1 = <span class="keyword">true</span>;</div><div class="line">    Boolean b2 = <span class="keyword">true</span>;</div><div class="line">    Boolean b3 = <span class="keyword">false</span>;</div><div class="line">    Boolean b4 = <span class="keyword">false</span>;</div><div class="line">    assertTrue(b1 == b2);</div><div class="line">    assertTrue(b3 == b4);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>接下来看布尔类型包装类Boolean的valueOf方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Boolean TRUE = <span class="keyword">new</span> Boolean(<span class="keyword">true</span>);</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Boolean FALSE = <span class="keyword">new</span> Boolean(<span class="keyword">false</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title">valueOf</span><span class="params">(<span class="keyword">boolean</span> b)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (b ? TRUE : FALSE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>可以看出来，布尔类型的自动装箱会返回两个静态常量值中的一个。</p><h4 id="2-4-类型转换"><a href="#2-4-类型转换" class="headerlink" title="2.4 类型转换"></a>2.4 类型转换</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCompute</span><span class="params">()</span> </span>&#123;</div><div class="line">    Integer a = <span class="number">1</span>;</div><div class="line">    Integer b = <span class="number">2</span>;</div><div class="line">    Integer c = <span class="number">3</span>;</div><div class="line">    Long g = <span class="number">3L</span>;</div><div class="line">    Long h = <span class="number">2L</span>;</div><div class="line">    assertTrue(c == (a + b));     <span class="comment">// (1)</span></div><div class="line">    assertTrue(c.equals(a + b));  <span class="comment">// (2)</span></div><div class="line">    assertTrue(g == (a + b));     <span class="comment">// (3)</span></div><div class="line">    assertFalse(g.equals(a + b)); <span class="comment">// (4)</span></div><div class="line">    assertTrue(g.equals(a + h));  <span class="comment">// (5)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>a + b 运算符操作，先进行拆箱，计算得到int型的3，然后在进行封箱操作，传入equals方法。</p><p>这里面需要注意的是：</p><ul><li>当 “==” 运算符的两个操作数都是包装器类型的引用，则是比较指向的是否是同一个对象，而如果其中有一个操作数是表达式（即包含算术运算）则比较的是数值（即会触发自动拆箱的过程）。</li><li>对于包装器类型，equals方法并不会进行类型转换。</li></ul><p>重点看（3）（4）（5）。<br>（1）和（3）由于 a+b 包含了算术运算，因此会触发自动拆箱过程（会调用intValue方法），因此它们比较的是数值是否相等。<br>（2）（4）（5）对于c.equals(a+b)会先触发自动拆箱过程，再触发自动装箱过程，也就是说a+b，会先各自调用intValue方法，得到了加法运算后的数值之后，便调用Integer.valueOf方法，再进行equals比较。如果数值是int类型的，装箱过程调用的是Integer.valueOf；如果是long类型的，装箱调用的Long.valueOf方法。不同类型进行equals方法比较肯定不相等。</p><h3 id="3-空指针"><a href="#3-空指针" class="headerlink" title="3. 空指针"></a>3. 空指针</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>(expected = NullPointerException.class)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testNPE</span><span class="params">()</span> </span>&#123;</div><div class="line">    Integer a = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (a &gt; <span class="number">0</span>) &#123; <span class="comment">// NPE</span></div><div class="line">        System.out.println(a);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在执行<code>a &gt; 0</code>时，需要对a进行拆箱操作，也就是调用a的intValue方法，而a为空，则抛出NPE。<br>因此，对于包装类，需要先进行判空检验。</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-自动装箱与自动拆箱&quot;&gt;&lt;a href=&quot;#1-自动装箱与自动拆箱&quot; class=&quot;headerlink&quot; title=&quot;1. 自动装箱与自动拆箱&quot;&gt;&lt;/a&gt;1. 自动装箱与自动拆箱&lt;/h3&gt;&lt;p&gt;那我们来分析&lt;code&gt;Integer i = 5;&lt;/code&gt;的过程；&lt;br&gt;在jdk1.5以前，这样的代码是错误的，必须要通过&lt;code&gt;Integer i = new Integer(5);&lt;/code&gt;这样的语句实现；&lt;br&gt;而在jdk1.5以后，Java提供了自动装箱的功能，只需&lt;code&gt;Integer i = 5;&lt;/code&gt;这样的语句就能实现基本数据类型传给其包装类，JVM为我们执行了&lt;code&gt;Integer i = Integer.valueOf(5);&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;相对应的，把基本数据从对应包装类中取出的过程就是拆箱，如&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Integer i = 5；&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int j = i; // 这样的过程就是自动拆箱&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;源码方面，装箱过程是通过调用包装器的&lt;code&gt;valueOf&lt;/code&gt;方法实现的，而拆箱过程是通过调用包装器的&lt;code&gt;xxxValue&lt;/code&gt;方法实现的。（xxx代表对应的基本数据类型）&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="https://damon4u.github.io/categories/java/"/>
    
    
      <category term="java" scheme="https://damon4u.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>云音乐抓取</title>
    <link href="https://damon4u.github.io//blog/2018/09/%E4%BA%91%E9%9F%B3%E4%B9%90%E6%8A%93%E5%8F%96.html"/>
    <id>https://damon4u.github.io//blog/2018/09/云音乐抓取.html</id>
    <published>2018-09-21T08:41:50.000Z</published>
    <updated>2018-09-27T13:12:14.992Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-初衷"><a href="#1-初衷" class="headerlink" title="1. 初衷"></a>1. 初衷</h3><p>作为云音乐的死忠用户，在大量版权丢失的情况下，依然坚守阵地，除了对UI的喜欢，还有就是歌曲下面精彩的评论信息了。<br>翻过很多热评后，就想把这些数据抓取下来。有了数据，就可以做数据分析。</p><a id="more"></a><h3 id="2-探索抓取方案"><a href="#2-探索抓取方案" class="headerlink" title="2.探索抓取方案"></a>2.探索抓取方案</h3><p>我感兴趣的数据包括歌曲信息、用户信息和评论信息。<br>在web端搜索一首歌曲，例如女友喜欢的《umbrella》：<a href="http://music.163.com/song?id=21563094" target="_blank" rel="external">http://music.163.com/song?id=21563094</a><br>打开开发者选项，抓一下这个接口的返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">    &lt;head&gt;</div><div class="line">        &lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">        &lt;meta name=&quot;baidu-site-verification&quot; content=&quot;cNhJHKEzsD&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;qc:admins&quot; content=&quot;27354635321361636375&quot; /&gt;</div><div class="line">        &lt;link rel=&quot;canonical&quot; href=&quot;https://music.163.com/song?id=21563094&quot;&gt;</div><div class="line">        &lt;meta name=&quot;applicable-device&quot; content=&quot;pc&quot;&gt;</div><div class="line">        &lt;link rel=&quot;alternate&quot; media=&quot;only screen and (max-width: 640px)&quot; href=&quot;https://music.163.com/m/song?id=21563094&quot;&gt;</div><div class="line">        &lt;meta name=&quot;mobile-agent&quot; content=&quot;format=html5;url=https://music.163.com/m/song?id=21563094&quot;&gt;</div><div class="line">        &lt;title&gt;Umbrella - Rihanna/Jay-Z - 单曲 - 网易云音乐&lt;/title&gt;</div><div class="line">        &lt;meta name=&quot;keywords&quot; content=&quot;Umbrella，Good Girl Gone Bad: Reloaded，Rihanna，Jay-Z&quot; /&gt;</div><div class="line">        &lt;meta name=&quot;description&quot; content=&quot;歌手：Rihanna，Jay-Z。所属专辑：Good Girl Gone Bad: Reloaded。&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;og:title&quot; content=&quot;Umbrella - Rihanna/Jay-Z - 单曲 - 网易云音乐&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;og:type&quot; content=&quot;music.song&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;og:image&quot; content=&quot;http://p1.music.126.net/cSVFVXAwbx-UITEYuW2OCQ==/18923694625892133.jpg&quot; /&gt;</div><div class="line">        &lt;meta property=&quot;og:url&quot; content=&quot;https://music.163.com/song?id=21563094&quot; /&gt;</div><div class="line">        &lt;script type=&quot;application/ld+json&quot;&gt;</div><div class="line">&#123;</div><div class="line">&quot;@context&quot;: &quot;https://ziyuan.baidu.com/contexts/cambrian.jsonld&quot;,</div><div class="line">&quot;@id&quot;: &quot;http://music.163.com/song?id=21563094&quot;,</div><div class="line">&quot;appid&quot;: &quot;1582028769404989&quot;,</div><div class="line">&quot;title&quot;: &quot;Umbrella&quot;,</div><div class="line">&quot;images&quot;: [&quot;http://p1.music.126.net/cSVFVXAwbx-UITEYuW2OCQ==/18923694625892133.jpg&quot;],</div><div class="line">&quot;description&quot;: &quot;歌手：Rihanna，Jay-Z。所属专辑：Good Girl Gone Bad: Reloaded。&quot;,</div><div class="line">&quot;pubDate&quot;: &quot;2008-06-01T00:00:00&quot;</div><div class="line">&#125;</div><div class="line">&lt;!-- ... --&gt;</div></pre></td></tr></table></figure></p><p>这个静态页面包含了我们需要的歌曲信息：歌曲名称，歌手名称，简单描述，封面等。</p><p>过滤一下<code>comment</code>关键字，可以抓到评论接口：<br><a href="http://music.163.com/weapi/v1/resource/comments/R_SO_4_21563094?csrf_token=" target="_blank" rel="external">http://music.163.com/weapi/v1/resource/comments/R_SO_4_21563094?csrf_token=</a><br>观察下这个请求url，发现是<br><a href="http://music.163.com/weapi/v1/resource/comments/R_SO_4_{songId}?csrf_token=" target="_blank" rel="external">http://music.163.com/weapi/v1/resource/comments/R_SO_4_{songId}?csrf_token=</a><br>的规则。<br>但是直接发POST请求拿不到数据，说明这个接口做了权限校验。<br>继续分析这个接口的请求参数，发现Form Data中带了两个参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">params: Tt0vzJun80fPMcJdTIQZjECkfD19yB+85n1n/yHPlpMyRMftbmFja0AccgQjzjJwVBCs/2P8Rv3G2twaIXyxcHHTPinf+r+W3My26Ig+7u4+MFHlt2da1t1mEqXDQFDLRMgQGBrHJ3SQwyL82t+FTpjoVRGVlIKUqT5+k/w9oFoPpCyLzICLhbdK+dHANH6g</div><div class="line">encSecKey: 465fd8f7c29de467d6396e88b8b77d42971cb85134f8da7622925823019ab6774dc4b1cf6da9d39c063cb492e01349ae5801946700bc981b83cd5cddf66229ce794b63b8be99b7e47a88f415f412c6a5bf561a84b4cefb63b9571e05209e024b1e2dea08cbf9d299d11770682fc1f17117c612e0d113a26175f88b2a661bfc32</div></pre></td></tr></table></figure></p><p>我们也加上两个表单参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -X POST \</div><div class="line">  &apos;http://music.163.com/weapi/v1/resource/comments/R_SO_4_21563094/?csrf_token=&apos; \</div><div class="line">  -H &apos;Content-Type: application/x-www-form-urlencoded&apos; \</div><div class="line">  -d &apos;params=idbuC%2BeyC4tyaC8O0b17iPmu76ES3ExK4xUyvEcqLUc4ky04AGkMkKd8Agp1Z46Vh3TMCZUc4aqHdMaQ7MyYj2jzr2v3irkRTalDwLf5Hu4%2B3FrujioedL5Crw8a2G9rcV%2BjdUm7JkZbZ6ubRTl4QlRT2OjNj7DjcBj%2B5nKgH6Z2rGQzoL8XO5HAVED4uRBB&amp;encSecKey=a889c30bc037e06c3cb96d2f694bdec265cda483db3b551d72c9c30d2eb5ee7fac6848cb295fcde522ba0b0ed709ca5f28638353016bad5b4224a76517f2776a8d1bea8e2a9318625b41c73e2aece423e0846bcd54093032287185b1f618fe39163f8df49939abac3f5ae8ebcea87cda6e921b9ba41e0ed33f492b1624a48a92&apos;</div></pre></td></tr></table></figure></p><p>返回结果结构如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"isMusician"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">"userId"</span>: <span class="number">-1</span>,</div><div class="line">    <span class="attr">"topComments"</span>: [],</div><div class="line">    <span class="attr">"moreHot"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"hotComments"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"user"</span>: &#123;</div><div class="line">                <span class="attr">"locationInfo"</span>: <span class="literal">null</span>,</div><div class="line">                <span class="attr">"vipRights"</span>: &#123;</div><div class="line">                    <span class="attr">"musicPackage"</span>: &#123;</div><div class="line">                        <span class="attr">"vipCode"</span>: <span class="number">200</span>,</div><div class="line">                        <span class="attr">"rights"</span>: <span class="literal">true</span></div><div class="line">                    &#125;</div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"userId"</span>: <span class="number">51494587</span>,</div><div class="line">                <span class="attr">"nickname"</span>: <span class="string">"FireBurning_JASON"</span>,</div><div class="line">                <span class="attr">"expertTags"</span>: <span class="literal">null</span>,</div><div class="line">                <span class="attr">"userType"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"authStatus"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"remarkName"</span>: <span class="literal">null</span>,</div><div class="line">                <span class="attr">"avatarUrl"</span>: <span class="string">"http://p1.music.126.net/8c28fFk1Yqml-CCulWzioA==/7806532557388357.jpg"</span>,</div><div class="line">                <span class="attr">"experts"</span>: <span class="literal">null</span>,</div><div class="line">                <span class="attr">"vipType"</span>: <span class="number">10</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"beReplied"</span>: [],</div><div class="line">            <span class="attr">"pendantData"</span>: <span class="literal">null</span>,</div><div class="line">            <span class="attr">"expressionUrl"</span>: <span class="literal">null</span>,</div><div class="line">            <span class="attr">"time"</span>: <span class="number">1424242903947</span>,</div><div class="line">            <span class="attr">"liked"</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">"likedCount"</span>: <span class="number">14377</span>,</div><div class="line">            <span class="attr">"commentId"</span>: <span class="number">11007152</span>,</div><div class="line">            <span class="attr">"content"</span>: <span class="string">"应该说这首歌才是rir的巅峰吧，然后就一直在巅峰"</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="attr">"total"</span>: <span class="number">6935</span>,</div><div class="line">    <span class="attr">"more"</span>: <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>这个接口就包含我感兴趣的热门评论信息和用户信息。<br>对于简单抓取，这两个接口已经满足我的需求。如果想抓取全部评论，包含分页数据，那么需要分析云音乐的加密算法，其实在混淆后的JS中都有，有专门的文章分析，这里不做过多解释。</p><h3 id="3-代理IP池"><a href="#3-代理IP池" class="headerlink" title="3. 代理IP池"></a>3. 代理IP池</h3><p>有了接口，就可以写代码发送http请求遍历songId进行数据抓取了。<br>但是云音乐做了防刷处理，抓取几万条数据后，开始接口报错，被封了IP。<br>于是想要维护一个代理IP池，每次抓取时从池子中拿一个代理IP进行接口调用，防止IP封禁。</p><h4 id="3-1-代理IP"><a href="#3-1-代理IP" class="headerlink" title="3.1 代理IP"></a>3.1 代理IP</h4><p>来源：可以从淘宝上面买，可以从免费网站抓取。<br>分类：根据匿名程度，可以分为高匿，普通和透明。高匿的代理ip可以屏蔽掉真实IP，目标服务器完全不能感觉到代理IP的存在；普通代理ip能隐藏真实IP，但是目标服务器能感受到代理IP的存在；透明代理IP不能隐藏真实IP。</p><h4 id="3-2-免费代理IP池"><a href="#3-2-免费代理IP池" class="headerlink" title="3.2 免费代理IP池"></a>3.2 免费代理IP池</h4><p>搜索一下代理IP，能找到大量网站提供一些免费代理IP，质量参差不齐，站越大，用的人越多，质量越差。<br>于是搭建免费代理IP池包含两个步骤：<br>（1）从免费代理IP网站抓取代理IP列表<br>（2）验证代理IP可用性<br>不同的代理IP网站抓取和解析的过程也不尽相同，但是不难。<br>验证过程就是使用抓取来的代理IP访问常用网站或者目标网站，如果可用则保留，不可用则丢弃。</p><h3 id="4-实现"><a href="#4-实现" class="headerlink" title="4. 实现"></a>4. 实现</h3><h4 id="4-1-配置文件读取"><a href="#4-1-配置文件读取" class="headerlink" title="4.1 配置文件读取"></a>4.1 配置文件读取</h4><p>项目中使用三个自定义配置参数：请求代理IP列表超时时间，代理IP验证超时时间和真正请求歌曲信息接口超时时间。<br><code>application.yml</code>中配置如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">app:</span></div><div class="line"><span class="attr">  http:</span></div><div class="line"><span class="attr">    proxyLoadTimeout:</span> <span class="number">10</span></div><div class="line"><span class="attr">    proxyValidateTimeout:</span> <span class="number">8</span></div><div class="line"><span class="attr">    songLoadTimeout:</span> <span class="number">15</span></div></pre></td></tr></table></figure></p><p>这里使用<code>ConfigurationProperties</code>注解读取<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Description:</span></div><div class="line"><span class="comment"> * http配置参数</span></div><div class="line"><span class="comment"> * 修改此类需要maven重新编译，yml里面才能有提示</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> damon4u</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@ConfigurationProperties</span>(<span class="string">"app.http"</span>)</div><div class="line"><span class="meta">@Data</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyLoadTimeout;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyValidateTimeout;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> songLoadTimeout;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>为了能够在yml配置文件中提示自定义参数，需要引入<code>spring-boot-configuration-processor</code>:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p><p>注意每次修改<code>HttpConfig</code>都需要重新maven编译，yml里面才能有提示。</p><h4 id="4-2-使用普通http请求获取动态IP"><a href="#4-2-使用普通http请求获取动态IP" class="headerlink" title="4.2 使用普通http请求获取动态IP"></a>4.2 使用普通http请求获取动态IP</h4><p>网络请求层使用OKHttp + Retrofit2框架。<br>Retrofit2本身是对OKHttp网络请求工具的封装实现，可以方便进行各类HTTP方法请求，对请求参数和返回值进行类型转换。<br>首先引入maven依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- retrofit start --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>retrofit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>converter-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>converter-scalars<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- retrofit end --&gt;</span></div></pre></td></tr></table></figure></p><p><code>retrofit</code>是核心包，<code>converter-jackson</code>和<code>converter-scalars</code>是两个返回值类型转换器，分别对json和普通类型（如string）的返回值进行转换。</p><p>获取动态IP的接口为：<code>https://raw.githubusercontent.com/stamparm/aux/master/fetch-some-list.txt</code><br>返回结果为：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"proto"</span>: <span class="string">"http"</span>,</div><div class="line">    <span class="attr">"ip"</span>: <span class="string">"176.62.180.209"</span>,</div><div class="line">    <span class="attr">"country"</span>: <span class="string">"Russian Federation"</span>,</div><div class="line">    <span class="attr">"anonymity"</span>: <span class="string">"high"</span>,</div><div class="line">    <span class="attr">"type"</span>: <span class="string">"elite"</span>,</div><div class="line">    <span class="attr">"port"</span>: <span class="number">63909</span></div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p><p>对于代理IP，统一封装成一个 <code>Proxy</code>实体类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Data</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 主键id</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ip地址或者域名</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String ip;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 端口号</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 协议http、https、socks4等</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String proto;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span><span class="params">(String ip, <span class="keyword">int</span> port, String proto)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ip = ip;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">this</span>.proto = proto.toLowerCase();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> proto + <span class="string">"://"</span> + ip + <span class="string">":"</span> + port;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>首先我们封装一个请求client接口，专门负责发起<code>https://raw.githubusercontent.com/</code>域名下的请求，当然，这里我们只有一个普通的GET请求。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitProxyClient</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取代理IP列表</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@GET</span>(<span class="string">"/stamparm/aux/master/fetch-some-list.txt"</span>)</div><div class="line">    Call&lt;List&lt;Proxy&gt;&gt; loadProxy();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>之后，需要想Spring容器注入bean：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@Data</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * 网络配置参数</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpConfig httpConfig;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpClientFactory</span><span class="params">(HttpConfig httpConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.httpConfig = httpConfig;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">okHttpClient</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">                .addInterceptor(<span class="keyword">new</span> HttpHeaderInterceptor())</div><div class="line">                .connectTimeout(httpConfig.getProxyLoadTimeout(), TimeUnit.SECONDS)</div><div class="line">                .readTimeout(httpConfig.getProxyLoadTimeout(), TimeUnit.SECONDS).build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> GitProxyClient <span class="title">gitProxyClient</span><span class="params">()</span> </span>&#123;</div><div class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">        <span class="comment">//设置输入时忽略在JSON字符串中存在但Java对象实际没有的属性</span></div><div class="line">        mapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                .addConverterFactory(JacksonConverterFactory.create(mapper))</div><div class="line">                .baseUrl(<span class="string">"https://raw.githubusercontent.com/"</span>)</div><div class="line">                .client(okHttpClient())</div><div class="line">                .build().create(GitProxyClient.class);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><code>HttpClientFactory</code>先注册一个<code>OkHttpClient</code>bean，设置了超时时间和拦截器，这个请求并不需要设置代理IP。<br>其中<code>HttpHeaderInterceptor</code>很简单，只是添加一些公共头信息，包括一个随机UA：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpHeaderInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        Request request = chain.request();</div><div class="line">        Request.Builder builder = request.newBuilder();</div><div class="line">        builder.addHeader(<span class="string">"User-Agent"</span>, UAPool.getUA()); <span class="comment">// 写死一个UA池子，每次随机拿一个，这里就不贴了</span></div><div class="line">        builder.addHeader(<span class="string">"Connection"</span>, <span class="string">"keep-alive"</span>);</div><div class="line">        <span class="keyword">return</span> chain.proceed(builder.build());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>之后注册一个<code>GitProxyClient</code>bean，定制了Jackson反序列化时使用的<code>ObjectMapper</code>，设置了该client的基础域名。<br>接下来就可以使用gitProxyClient发起请求获取动态IP列表了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyLoader</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> GitProxyClient gitProxyClient;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadFromGit</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// 请求</span></div><div class="line">        Response&lt;List&lt;Proxy&gt;&gt; response = gitProxyClient.loadProxy().execute();</div><div class="line">        List&lt;Proxy&gt; proxyList = response.body();</div><div class="line">        <span class="comment">// 过滤</span></div><div class="line">        filterProxy(proxyList);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="4-3-过滤抓取来的代理IP"><a href="#4-3-过滤抓取来的代理IP" class="headerlink" title="4.3 过滤抓取来的代理IP"></a>4.3 过滤抓取来的代理IP</h4><p>从网上抓取来的代理IP一般质量都不高，所以需要进行过滤。<br>常用的方法就是尝试使用代理IP去访问一个常用网站，如百度等，如果在短时间内正常返回则认为可用。<br>开始我也采用了这种方式，访问百度，但是发现可能会出现一种情况，就是百度可以访问，但是访问云音乐接口却出现错误。<br>既然如此，不如一步到位，过滤时就访问歌曲信息接口，如果能正常获取歌曲信息，那么认为代理可用。</p><p>先给出获取歌曲信息的Client：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MusicClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取歌曲信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> songId 歌曲id</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 页面html</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@GET</span>(<span class="string">"song"</span>)</div><div class="line">    <span class="meta">@Headers</span>(<span class="string">"Referer: http://music.163.com/"</span>)</div><div class="line">    <span class="function">Call&lt;String&gt; <span class="title">songInfo</span><span class="params">(@Query(<span class="string">"id"</span>)</span> <span class="keyword">long</span> songId)</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取评论信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> songId    歌曲id</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> params    加密params</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> encSecKey 加密encSecKey</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 评论接口返回体</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@POST</span>(<span class="string">"weapi/v1/resource/comments/R_SO_4_&#123;songId&#125;/?csrf_token=d2c9e86c94efabcc4b5a1a6d757d417e"</span>)</div><div class="line">    <span class="meta">@FormUrlEncoded</span></div><div class="line">    <span class="meta">@Headers</span>(<span class="string">"Referer: http://music.163.com/"</span>)</div><div class="line">    <span class="function">Call&lt;CommentResponseBody&gt; <span class="title">comment</span><span class="params">(@Path(<span class="string">"songId"</span>)</span> Long songId,</span></div><div class="line"><span class="function">                                      @<span class="title">Field</span><span class="params">(<span class="string">"params"</span>)</span> String params,</span></div><div class="line"><span class="function">                                      @<span class="title">Field</span><span class="params">(<span class="string">"encSecKey"</span>)</span> String encSecKey)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>接下来需要一个定制OkHttp，添加代理IP，这里创建一个工厂：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpProxyClientFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MusicClient <span class="title">musicClient</span><span class="params">(Proxy proxy, <span class="keyword">int</span> timeoutInSecond)</span> </span>&#123;</div><div class="line">        OkHttpClient.Builder builder = <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">                .connectTimeout(timeoutInSecond, TimeUnit.SECONDS)</div><div class="line">                .readTimeout(timeoutInSecond, TimeUnit.SECONDS)</div><div class="line">                .addInterceptor(<span class="keyword">new</span> HttpHeaderInterceptor());</div><div class="line">        addProxy(proxy, builder);</div><div class="line">        OkHttpClient okHttpClient = builder.build();</div><div class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">        <span class="comment">//设置输入时忽略在JSON字符串中存在但Java对象实际没有的属性</span></div><div class="line">        mapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);</div><div class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                .addConverterFactory(ScalarsConverterFactory.create())</div><div class="line">                .addConverterFactory(JacksonConverterFactory.create(mapper))</div><div class="line">                .baseUrl(<span class="string">"http://music.163.com/"</span>)</div><div class="line">                .client(okHttpClient)</div><div class="line">                .build();</div><div class="line">        <span class="keyword">return</span> retrofit.create(MusicClient.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 设置代理</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addProxy</span><span class="params">(Proxy proxy, OkHttpClient.Builder builder)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (proxy != <span class="keyword">null</span>) &#123;</div><div class="line">            String schemeName = proxy.getProto();</div><div class="line">            java.net.Proxy.Type type = java.net.Proxy.Type.HTTP;</div><div class="line">            <span class="keyword">if</span> (schemeName.startsWith(<span class="string">"socks"</span>)) &#123;</div><div class="line">                type = java.net.Proxy.Type.SOCKS;</div><div class="line">            &#125;</div><div class="line">            builder.proxy(<span class="keyword">new</span> java.net.Proxy(type, <span class="keyword">new</span> InetSocketAddress(proxy.getIp(), proxy.getPort())));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>由于每次请求的代理IP都不同，不能直接注入到bean，而是使用工厂方法，每次请求都重新构造一个<code>OkHttpClient</code>，然后生成<code>MusicClient</code>。<br>注意在添加converterFactory时，先添加<code>ScalarsConverterFactory</code>，再<code>JacksonConverterFactory</code>，原因在doc中：</p><blockquote><p>Because Jackson is so flexible in the types it supports, this converter assumes that it can handle all types. If you are mixing JSON serialization with something else (such as protocol buffers), you must add this instance last to allow the other converters a chance to see their types.</p></blockquote><p>接下来就可以使用代理IP请求歌曲信息了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Pattern NAME_PATTERN = Pattern.compile(<span class="string">"&lt;title&gt;(.*) - 网易云音乐&lt;/title&gt;"</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Pattern DESCRIPTION_PATTERN = Pattern.compile(<span class="string">"&lt;meta name=\"description\" content=\"(.*)\" /&gt;"</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Pattern IMAGE_PATTERN = Pattern.compile(<span class="string">"&lt;meta property=\"og:image\" content=\"(.*)\" /&gt;"</span>);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取歌曲信息</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> songId 歌曲id</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> 如果找到，返回：歌曲名称 - 歌手名称；否则返回null</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> Song <span class="title">getSongInfo</span><span class="params">(<span class="keyword">long</span> songId, Proxy proxy, <span class="keyword">int</span> timeoutInSecond)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Response&lt;String&gt; response = HttpProxyClientFactory.musicClient(proxy, timeoutInSecond)</div><div class="line">            .songInfo(songId).execute();</div><div class="line">    Preconditions.checkNotNull(response);</div><div class="line">    String songInfo = response.body();</div><div class="line">    Preconditions.checkArgument(StringUtils.isNotBlank(songInfo));</div><div class="line">    Matcher nameMatcher = NAME_PATTERN.matcher(songInfo);</div><div class="line">    Matcher descriptionMatcher = DESCRIPTION_PATTERN.matcher(songInfo);</div><div class="line">    Matcher imageMatcher = IMAGE_PATTERN.matcher(songInfo);</div><div class="line">    String name = <span class="string">""</span>;</div><div class="line">    String description = <span class="string">""</span>;</div><div class="line">    String image = <span class="string">""</span>;</div><div class="line">    <span class="keyword">if</span> (nameMatcher.find()) &#123;</div><div class="line">        name = nameMatcher.group(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (descriptionMatcher.find()) &#123;</div><div class="line">        description = descriptionMatcher.group(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (imageMatcher.find()) &#123;</div><div class="line">        image = imageMatcher.group(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(name)) &#123;</div><div class="line">        Song song = <span class="keyword">new</span> Song();</div><div class="line">        song.setSongId(songId);</div><div class="line">        song.setName(name);</div><div class="line">        song.setDescription(description);</div><div class="line">        song.setImage(image);</div><div class="line">        song.setCreateTime(<span class="keyword">new</span> Date());</div><div class="line">        logger.info(<span class="string">"song=&#123;&#125;"</span>, song);</div><div class="line">        <span class="keyword">return</span> song;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>剩下的过滤工作也就简单了，对于爬去来的代理IP列表，使用多个线程去过滤一下就好了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">filterProxy</span><span class="params">(List&lt;Proxy&gt; proxyList)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(proxyList)) &#123;</div><div class="line">        <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(proxyList.size());</div><div class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">5</span>);</div><div class="line">        proxyList.forEach(proxy -&gt; executorService.execute(<span class="keyword">new</span> FilterJob(proxy, latch)));</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            latch.await();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            LOGGER.error(e.getMessage());</div><div class="line">        &#125;</div><div class="line">        executorService.shutdownNow();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterJob</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Proxy proxy;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> CountDownLatch latch;</div><div class="line"></div><div class="line">    FilterJob(Proxy proxy, CountDownLatch latch) &#123;</div><div class="line">        <span class="keyword">this</span>.proxy = proxy;</div><div class="line">        <span class="keyword">this</span>.latch = latch;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 先只要http类型的</span></div><div class="line">            <span class="keyword">if</span> (proxy.getProto().startsWith(<span class="string">"http"</span>)</div><div class="line">                    &amp;&amp; commentLoader.getSongInfo(<span class="number">209996</span>, proxy, httpConfig.getProxyValidateTimeout()) != <span class="keyword">null</span>) &#123;</div><div class="line">                LOGGER.info(<span class="string">"================&gt; &#123;&#125;"</span>, proxy);</div><div class="line">                proxyDao.save(<span class="keyword">new</span> Proxy(proxy.getIp(), proxy.getPort(), proxy.getProto()));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(e.getMessage());</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            latch.countDown();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="4-4-定时抓取"><a href="#4-4-定时抓取" class="headerlink" title="4.4 定时抓取"></a>4.4 定时抓取</h4><p>上面我们实现了一次代理IP抓取，而抓取来的IP也会失效，所以我们需要定时抓取，更新代理IP池。<br>定时任务可以使用Spring的Schedule注解实现，也可以使用quartz，这里使用quartz。<br>引入依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p><p><code>application.yml</code>添加配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  quartz:</span></div><div class="line"><span class="attr">    properties:</span></div><div class="line"><span class="attr">      org:</span></div><div class="line"><span class="attr">        quartz:</span></div><div class="line"><span class="attr">          scheduler:</span></div><div class="line"><span class="attr">            instanceName:</span> <span class="string">proxyScheduler</span></div><div class="line"><span class="attr">          threadPool:</span></div><div class="line"><span class="attr">            class:</span> <span class="string">org.quartz.simpl.SimpleThreadPool</span></div><div class="line"><span class="attr">            threadCount:</span> <span class="number">10</span></div><div class="line"><span class="attr">            threadPriority:</span> <span class="number">5</span></div><div class="line"><span class="attr">    job-store-type:</span> <span class="string">MEMORY</span></div></pre></td></tr></table></figure></p><p>这里使用简单的内存存储job，也可以使用数据库，配置项会麻烦些。<br>然后创建一个定时任务job，继承<code>QuartzJobBean</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyLoadJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ProxyLoadJob.class);</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> ProxyLoader proxyLoader;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext jobExecutionContext)</span> </span>&#123;</div><div class="line">        LOGGER.info(<span class="string">"ProxyLoadJob start."</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            proxyLoader.loadProxy();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(e.getMessage());</div><div class="line">        &#125;</div><div class="line">        LOGGER.info(<span class="string">"ProxyLoadJob end."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>有了任务，还要将它调度起来，我想20分钟跑一次：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobScheduler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JOB_NAME_PROXY_LOAD = <span class="string">"proxyLoadJob"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_NAME_PROXY = <span class="string">"proxyLoadGroup"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">proxyJob</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> JobBuilder.newJob(ProxyLoadJob.class)</div><div class="line">                .withIdentity(JOB_NAME_PROXY_LOAD, GROUP_NAME_PROXY)</div><div class="line">                .storeDurably()</div><div class="line">                .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">proxyJobTrigger</span><span class="params">()</span> </span>&#123;</div><div class="line">        CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(<span class="string">"0 0/20 * * * ?"</span>);</div><div class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">                .withSchedule(scheduleBuilder)</div><div class="line">                .withIdentity(JOB_NAME_PROXY_LOAD, GROUP_NAME_PROXY)</div><div class="line">                .forJob(proxyJob())</div><div class="line">                .build();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>这里我们先注册一个<code>JobDetail</code>，需要一个名字和分组，然后设置为durably，即没有trigger指向时，也保留。<br>接下来注册一个trigger去触发上面的job，设置cron表达式，绑定job即可。</p><h4 id="4-5-定时删除失效IP"><a href="#4-5-定时删除失效IP" class="headerlink" title="4.5 定时删除失效IP"></a>4.5 定时删除失效IP</h4><p>上面我们实现了定时抓取新代理IP的功能，接下来还需要定时从库中删除失效的代理IP，不能光等到使用时再删除。<br>方法是从库中读取所有代理IP（如果代理IP量很大，可以分页处理），然后启动多个任务去校验代理IP有效性，将无效的删除：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateFromDb</span><span class="params">()</span> </span>&#123;</div><div class="line">      List&lt;Proxy&gt; allProxy = proxyDao.getAllProxy();</div><div class="line">      <span class="keyword">if</span> (CollectionUtils.isNotEmpty(allProxy)) &#123;</div><div class="line">          <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(allProxy.size());</div><div class="line">          ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">5</span>);</div><div class="line">          allProxy.forEach(proxy -&gt; executorService.execute(<span class="keyword">new</span> ValidateJob(proxy, latch)));</div><div class="line">          <span class="keyword">for</span> (Proxy proxy : allProxy) &#123;</div><div class="line">              executorService.execute(<span class="keyword">new</span> ValidateJob(proxy, latch));</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              latch.await();</div><div class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">              LOGGER.error(e.getMessage());</div><div class="line">          &#125;</div><div class="line">          executorService.shutdownNow();</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ValidateJob</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">private</span> Proxy proxy;</div><div class="line"></div><div class="line">      <span class="keyword">private</span> CountDownLatch latch;</div><div class="line"></div><div class="line">      ValidateJob(Proxy proxy, CountDownLatch latch) &#123;</div><div class="line">          <span class="keyword">this</span>.proxy = proxy;</div><div class="line">          <span class="keyword">this</span>.latch = latch;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              <span class="keyword">if</span> (commentLoader.getSongInfo(<span class="number">209996</span>, proxy, httpConfig.getProxyValidateTimeout()) == <span class="keyword">null</span>) &#123;</div><div class="line">                  proxyDao.delete(proxy.getId());</div><div class="line">                  LOGGER.error(<span class="string">"disable proxy=&#123;&#125;"</span>, proxy);</div><div class="line">              &#125;</div><div class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">              LOGGER.error(e.getMessage());</div><div class="line">          &#125; <span class="keyword">finally</span> &#123;</div><div class="line">              latch.countDown();</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p><p>同样需要一个定时任务，15分钟执行一次即可，代码与上面抓取代理任务类似。</p><h4 id="4-6-使用代理IP获取歌曲信息"><a href="#4-6-使用代理IP获取歌曲信息" class="headerlink" title="4.6 使用代理IP获取歌曲信息"></a>4.6 使用代理IP获取歌曲信息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentLoader</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(CommentLoader.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Pattern NAME_PATTERN = Pattern.compile(<span class="string">"&lt;title&gt;(.*) - 网易云音乐&lt;/title&gt;"</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Pattern DESCRIPTION_PATTERN = Pattern.compile(<span class="string">"&lt;meta name=\"description\" content=\"(.*)\" /&gt;"</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Pattern IMAGE_PATTERN = Pattern.compile(<span class="string">"&lt;meta property=\"og:image\" content=\"(.*)\" /&gt;"</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> SongDao songDao;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> UserDao userDao;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> CommentDao commentDao;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> ProxyDao proxyDao;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> HttpConfig httpConfig;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取歌曲和评论信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> start 歌曲id起始</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> end 歌曲id结束</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadSongs</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> songId = start; songId &lt;= end; songId++) &#123;</div><div class="line">            Proxy proxy = getRandomProxy();</div><div class="line">            Song songInfo = getSongInfo(songId, proxy, httpConfig.getSongLoadTimeout());</div><div class="line">            <span class="keyword">if</span> (songInfo == <span class="keyword">null</span>) &#123; <span class="comment">// 重试一次</span></div><div class="line">                proxyDao.delete(proxy.getId());</div><div class="line">                proxy = getRandomProxy();</div><div class="line">                songInfo = getSongInfo(songId, proxy, httpConfig.getSongLoadTimeout());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (songInfo == <span class="keyword">null</span>) &#123; <span class="comment">// 重试一次</span></div><div class="line">                proxyDao.delete(proxy.getId());</div><div class="line">                proxy = getRandomProxy();</div><div class="line">                songInfo = getSongInfo(songId, proxy, httpConfig.getSongLoadTimeout());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (songInfo == <span class="keyword">null</span>) &#123;</div><div class="line">                proxyDao.delete(proxy.getId());</div><div class="line">                logger.error(<span class="string">"songInfo is null. songId=&#123;&#125;"</span>, songId);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (songInfo != <span class="keyword">null</span>) &#123;</div><div class="line">                loadCommentInfo(songInfo, proxy);</div><div class="line">            &#125;</div><div class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">50</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取歌曲信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> songId 歌曲id</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 如果找到，返回：歌曲名称 - 歌手名称；否则返回null</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Song <span class="title">getSongInfo</span><span class="params">(<span class="keyword">long</span> songId, Proxy proxy, <span class="keyword">int</span> timeoutInSecond)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Response&lt;String&gt; response = HttpProxyClientFactory.musicClient(proxy, timeoutInSecond)</div><div class="line">                .songInfo(songId).execute();</div><div class="line">        Preconditions.checkNotNull(response);</div><div class="line">        String songInfo = response.body();</div><div class="line">        Preconditions.checkArgument(StringUtils.isNotBlank(songInfo));</div><div class="line">        Matcher nameMatcher = NAME_PATTERN.matcher(songInfo);</div><div class="line">        Matcher descriptionMatcher = DESCRIPTION_PATTERN.matcher(songInfo);</div><div class="line">        Matcher imageMatcher = IMAGE_PATTERN.matcher(songInfo);</div><div class="line">        String name = <span class="string">""</span>;</div><div class="line">        String description = <span class="string">""</span>;</div><div class="line">        String image = <span class="string">""</span>;</div><div class="line">        <span class="keyword">if</span> (nameMatcher.find()) &#123;</div><div class="line">            name = nameMatcher.group(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (descriptionMatcher.find()) &#123;</div><div class="line">            description = descriptionMatcher.group(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (imageMatcher.find()) &#123;</div><div class="line">            image = imageMatcher.group(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(name)) &#123;</div><div class="line">            Song song = <span class="keyword">new</span> Song();</div><div class="line">            song.setSongId(songId);</div><div class="line">            song.setName(name);</div><div class="line">            song.setDescription(description);</div><div class="line">            song.setImage(image);</div><div class="line">            song.setCreateTime(<span class="keyword">new</span> Date());</div><div class="line">            logger.info(<span class="string">"song=&#123;&#125;"</span>, song);</div><div class="line">            <span class="keyword">return</span> song;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取歌曲评论</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> song  歌曲信息</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> proxy</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadCommentInfo</span><span class="params">(Song song, Proxy proxy)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Long songId = song.getSongId();</div><div class="line">        String params = <span class="string">"flQdEgSsTmFkRagRN2ceHMwk6lYVIMro5auxLK/JywlqdjeNvEtiWDhReFI+QymePGPLvPnIuVi3dfsDuqEJW204VdwvX+gr3uiRBeSFuOm1VUSJ1HqOc+nJCh0j6WGUbWuJC5GaHTEE4gcpWXX36P4Eu4djoQBzoqdsMbCwoolb2/WrYw/N2hehuwBHO4Oz"</span>;</div><div class="line">        String encSecKey = <span class="string">"0263b1cd3b0a9b621a819b73e588e1cc5709349b21164dc45ab760e79858bb712986ea064dbfc41669e527b767f02da7511ac862cbc54ea7d164fc65e0359962273616e68e694453fb6820fa36dd9915b2b0f60dadb0a6022b2187b9ee011b35d82a1c0ed8ba0dceb877299eca944e80b1e74139f0191adf71ca536af7d7ec25"</span>;</div><div class="line">        Response&lt;CommentResponseBody&gt; response = HttpProxyClientFactory.musicClient(proxy, httpConfig.getSongLoadTimeout()).comment(songId, params, encSecKey).execute();</div><div class="line">        <span class="keyword">long</span> commentCount = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">            CommentResponseBody commentResponseBody = response.body();</div><div class="line">            <span class="keyword">if</span> (commentResponseBody != <span class="keyword">null</span>) &#123;</div><div class="line">                commentCount = commentResponseBody.getTotal();</div><div class="line">                List&lt;CommentResponse&gt; hotComments = commentResponseBody.getHotComments();</div><div class="line">                <span class="keyword">if</span> (CollectionUtils.isNotEmpty(hotComments)) &#123;</div><div class="line">                    <span class="keyword">for</span> (CommentResponse commentResponse : hotComments) &#123;</div><div class="line">                        Long userId = <span class="number">0L</span>;</div><div class="line">                        User user = commentResponse.getUser();</div><div class="line">                        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</div><div class="line">                            userId = user.getUserId();</div><div class="line">                            userDao.save(user);</div><div class="line">                        &#125;</div><div class="line">                        Long beRepliedUserId = <span class="number">0L</span>;</div><div class="line">                        String beRepliedContent = <span class="string">""</span>;</div><div class="line">                        List&lt;CommentReplied&gt; beRepliedList = commentResponse.getBeReplied();</div><div class="line">                        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(beRepliedList)) &#123;</div><div class="line">                            CommentReplied commentReplied = beRepliedList.get(<span class="number">0</span>);</div><div class="line">                            User repliedUser = commentReplied.getUser();</div><div class="line">                            <span class="keyword">if</span> (repliedUser != <span class="keyword">null</span>) &#123;</div><div class="line">                                beRepliedUserId = repliedUser.getUserId();</div><div class="line">                                userDao.save(repliedUser);</div><div class="line">                            &#125;</div><div class="line">                            beRepliedContent = commentReplied.getContent();</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (commentCount &gt; <span class="number">1000</span>) &#123;</div><div class="line">                            <span class="comment">// 总评论数少于1000的歌曲就扔掉了</span></div><div class="line">                            Comment comment = <span class="keyword">new</span> Comment();</div><div class="line">                            comment.setCommentId(commentResponse.getCommentId());</div><div class="line">                            comment.setSongId(songId);</div><div class="line">                            comment.setLikedCount(commentResponse.getLikedCount());</div><div class="line">                            comment.setContent(commentResponse.getContent());</div><div class="line">                            comment.setUserId(userId);</div><div class="line">                            comment.setBeRepliedUserId(beRepliedUserId);</div><div class="line">                            comment.setBeRepliedContent(beRepliedContent);</div><div class="line">                            comment.setCommentTime(<span class="keyword">new</span> Date(commentResponse.getTime()));</div><div class="line">                            comment.setCreateTime(<span class="keyword">new</span> Date());</div><div class="line">                            commentDao.save(comment);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        song.setCommentCount(commentCount);</div><div class="line">        songDao.save(song);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 查询一个随机代理</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> Proxy <span class="title">getRandomProxy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = proxyDao.count();</div><div class="line">        <span class="keyword">return</span> proxyDao.getByIndex(ThreadLocalRandom.current().nextInt(count));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-初衷&quot;&gt;&lt;a href=&quot;#1-初衷&quot; class=&quot;headerlink&quot; title=&quot;1. 初衷&quot;&gt;&lt;/a&gt;1. 初衷&lt;/h3&gt;&lt;p&gt;作为云音乐的死忠用户，在大量版权丢失的情况下，依然坚守阵地，除了对UI的喜欢，还有就是歌曲下面精彩的评论信息了。&lt;br&gt;翻过很多热评后，就想把这些数据抓取下来。有了数据，就可以做数据分析。&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="https://damon4u.github.io/categories/java/"/>
    
      <category term="spring" scheme="https://damon4u.github.io/categories/java/spring/"/>
    
    
      <category term="spring" scheme="https://damon4u.github.io/tags/spring/"/>
    
      <category term="java" scheme="https://damon4u.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>BigDecimal精度</title>
    <link href="https://damon4u.github.io//blog/2018/09/BigDecimal%E7%B2%BE%E5%BA%A6.html"/>
    <id>https://damon4u.github.io//blog/2018/09/BigDecimal精度.html</id>
    <published>2018-09-12T08:41:50.000Z</published>
    <updated>2018-09-13T14:15:58.447Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-构造函数的坑"><a href="#1-构造函数的坑" class="headerlink" title="1. 构造函数的坑"></a>1. 构造函数的坑</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BigDecimalTest</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">      <span class="keyword">double</span> number = <span class="number">6302079.05</span>;</div><div class="line">      BigDecimal bigDecimalFromDouble = <span class="keyword">new</span> BigDecimal(number);</div><div class="line">      LOGGER.info(<span class="string">"bigDecimalFromDouble=&#123;&#125;"</span>, bigDecimalFromDouble);</div><div class="line">      BigDecimal bigDecimalFromString = <span class="keyword">new</span> BigDecimal(String.valueOf(number)) ;</div><div class="line">      LOGGER.info(<span class="string">"bigDecimalFromString=&#123;&#125;"</span>, bigDecimalFromString);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bigDecimalFromDouble=6302079.049999999813735485076904296875</div><div class="line">bigDecimalFromString=6302079.05</div></pre></td></tr></table></figure></p><p>可以看到，直接使用double作为参数构造BigDecimal时，会丢失精度。<br>所以推荐的是先将double转化为字符串，然后赋值给构造函数。</p><a id="more"></a><h3 id="2-数值计算丢失精度"><a href="#2-数值计算丢失精度" class="headerlink" title="2. 数值计算丢失精度"></a>2. 数值计算丢失精度</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDecimalCompute</span><span class="params">()</span> </span>&#123;</div><div class="line">    BigDecimal bigDecimalFromString = <span class="keyword">new</span> BigDecimal(<span class="string">"6302079.05"</span>) ;</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalFromString=&#123;&#125;"</span>, bigDecimalFromString);</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalFromString floatValue=&#123;&#125;"</span>, bigDecimalFromString.floatValue());</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalFromString floatValue*100=&#123;&#125;"</span>, (<span class="keyword">int</span>) (bigDecimalFromString.floatValue() * <span class="number">100</span>));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalFromString doubleValue=&#123;&#125;"</span>, bigDecimalFromString.doubleValue());</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalFromString doubleValue*100=&#123;&#125;"</span>, (<span class="keyword">int</span>) (bigDecimalFromString.doubleValue() * <span class="number">100</span>));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalFromString multiply(100)=&#123;&#125;"</span>, bigDecimalFromString.multiply(<span class="keyword">new</span> BigDecimal(<span class="string">"100"</span>)).intValue());</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">bigDecimalFromString=6302079.05</div><div class="line">bigDecimalFromString floatValue=6302079.0</div><div class="line">bigDecimalFromString floatValue*100=630207872</div><div class="line">bigDecimalFromString doubleValue=6302079.05</div><div class="line">bigDecimalFromString doubleValue*100=630207905</div><div class="line">bigDecimalFromString multiply(100)=630207905</div></pre></td></tr></table></figure></p><p>尝试调用<code>floatValue()</code>方法获取浮点值时，内部其实会将double转化为float，导致精度丢失。<br>所以要求使用BigDecimal提供的计算方法做四则运算，最后将结果返回指定数值类型。</p><h3 id="3-四舍五入"><a href="#3-四舍五入" class="headerlink" title="3. 四舍五入"></a>3. 四舍五入</h3><h4 id="3-1-ROUND-UP"><a href="#3-1-ROUND-UP" class="headerlink" title="3.1 ROUND_UP"></a>3.1 ROUND_UP</h4><blockquote><p>Rounding mode to round away from zero. Always increments the digit prior to a nonzero discarded fraction.</p></blockquote><p>不关心正负的无脑向上取整，远离0。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBigDecimalRound</span><span class="params">()</span> </span>&#123;</div><div class="line">    BigDecimal bigDecimalPositive = <span class="keyword">new</span> BigDecimal(<span class="string">"6302079.05"</span>) ;</div><div class="line">    BigDecimal bigDecimalNegative = <span class="keyword">new</span> BigDecimal(<span class="string">"-6302079.05"</span>) ;</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive=&#123;&#125;"</span>, bigDecimalPositive);</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative=&#123;&#125;"</span>, bigDecimalNegative);</div><div class="line"></div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive ROUND_UP=&#123;&#125;"</span>, bigDecimalPositive.setScale(<span class="number">1</span>, BigDecimal.ROUND_UP));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative ROUND_UP=&#123;&#125;"</span>, bigDecimalNegative.setScale(<span class="number">1</span>, BigDecimal.ROUND_UP));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bigDecimalPositive ROUND_UP=6302079.1</div><div class="line">bigDecimalNegative ROUND_UP=-6302079.1</div></pre></td></tr></table></figure></p><h4 id="3-2-ROUND-DOWN"><a href="#3-2-ROUND-DOWN" class="headerlink" title="3.2 ROUND_DOWN"></a>3.2 ROUND_DOWN</h4><blockquote><p>Rounding mode to round towards zero. Never increments the digit prior to a discarded fraction (i.e., truncates).</p></blockquote><p>不关心正负的无脑向下取整，靠近0。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBigDecimalRound</span><span class="params">()</span> </span>&#123;</div><div class="line">    BigDecimal bigDecimalPositive = <span class="keyword">new</span> BigDecimal(<span class="string">"6302079.05"</span>) ;</div><div class="line">    BigDecimal bigDecimalNegative = <span class="keyword">new</span> BigDecimal(<span class="string">"-6302079.05"</span>) ;</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive=&#123;&#125;"</span>, bigDecimalPositive);</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative=&#123;&#125;"</span>, bigDecimalNegative);</div><div class="line"></div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive ROUND_DOWN=&#123;&#125;"</span>, bigDecimalPositive.setScale(<span class="number">1</span>, BigDecimal.ROUND_DOWN));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative ROUND_DOWN=&#123;&#125;"</span>, bigDecimalNegative.setScale(<span class="number">1</span>, BigDecimal.ROUND_DOWN));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bigDecimalPositive ROUND_DOWN=6302079.0</div><div class="line">bigDecimalNegative ROUND_DOWN=-6302079.0</div></pre></td></tr></table></figure></p><h4 id="3-3-ROUND-CEILING"><a href="#3-3-ROUND-CEILING" class="headerlink" title="3.3 ROUND_CEILING"></a>3.3 ROUND_CEILING</h4><blockquote><p>Rounding mode to round towards positive infinity. If the BigDecimal is positive, behaves as for ROUND_UP; if negative, behaves as for ROUND_DOWN.</p></blockquote><p>向正无穷取整，如果是正值，那么表现跟ROUND_UP一样，如果是负值，那么表现跟ROUND_DOWN一样。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBigDecimalRound</span><span class="params">()</span> </span>&#123;</div><div class="line">    BigDecimal bigDecimalPositive = <span class="keyword">new</span> BigDecimal(<span class="string">"6302079.05"</span>) ;</div><div class="line">    BigDecimal bigDecimalNegative = <span class="keyword">new</span> BigDecimal(<span class="string">"-6302079.05"</span>) ;</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive=&#123;&#125;"</span>, bigDecimalPositive);</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative=&#123;&#125;"</span>, bigDecimalNegative);</div><div class="line"></div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive ROUND_CEILING=&#123;&#125;"</span>, bigDecimalPositive.setScale(<span class="number">1</span>, BigDecimal.ROUND_CEILING));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative ROUND_CEILING=&#123;&#125;"</span>, bigDecimalNegative.setScale(<span class="number">1</span>, BigDecimal.ROUND_CEILING));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bigDecimalPositive ROUND_CEILING=6302079.1</div><div class="line">bigDecimalNegative ROUND_CEILING=-6302079.0</div></pre></td></tr></table></figure></p><h4 id="3-4-ROUND-FLOOR"><a href="#3-4-ROUND-FLOOR" class="headerlink" title="3.4 ROUND_FLOOR"></a>3.4 ROUND_FLOOR</h4><blockquote><p>Rounding mode to round towards negative infinity. If the BigDecimal is positive, behave as for ROUND_DOWN; if negative, behave as for ROUND_UP.</p></blockquote><p>向负无穷取整，如果是正值，那么表现跟ROUND_DOWN一样，如果是负值，那么表现跟ROUND_UP一样。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBigDecimalRound</span><span class="params">()</span> </span>&#123;</div><div class="line">    BigDecimal bigDecimalPositive = <span class="keyword">new</span> BigDecimal(<span class="string">"6302079.05"</span>) ;</div><div class="line">    BigDecimal bigDecimalNegative = <span class="keyword">new</span> BigDecimal(<span class="string">"-6302079.05"</span>) ;</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive=&#123;&#125;"</span>, bigDecimalPositive);</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative=&#123;&#125;"</span>, bigDecimalNegative);</div><div class="line"></div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive ROUND_FLOOR=&#123;&#125;"</span>, bigDecimalPositive.setScale(<span class="number">1</span>, BigDecimal.ROUND_FLOOR));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative ROUND_FLOOR=&#123;&#125;"</span>, bigDecimalNegative.setScale(<span class="number">1</span>, BigDecimal.ROUND_FLOOR));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bigDecimalPositive ROUND_FLOOR=6302079.0</div><div class="line">bigDecimalNegative ROUND_FLOOR=-6302079.1</div></pre></td></tr></table></figure></p><h4 id="3-5-ROUND-HALF-UP"><a href="#3-5-ROUND-HALF-UP" class="headerlink" title="3.5 ROUND_HALF_UP"></a>3.5 ROUND_HALF_UP</h4><blockquote><p>Rounding mode to round towards “nearest neighbor” unless both neighbors are equidistant, in which case round up. Behaves as for ROUND_UP if the discarded fraction is ≥ 0.5; otherwise, behaves as for ROUND_DOWN.</p></blockquote><p>不关心正负的无脑四舍五入，如果是5，那么进位。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBigDecimalRound</span><span class="params">()</span> </span>&#123;</div><div class="line">    BigDecimal bigDecimalPositive = <span class="keyword">new</span> BigDecimal(<span class="string">"6302079.05"</span>) ;</div><div class="line">    BigDecimal bigDecimalNegative = <span class="keyword">new</span> BigDecimal(<span class="string">"-6302079.05"</span>) ;</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive=&#123;&#125;"</span>, bigDecimalPositive);</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative=&#123;&#125;"</span>, bigDecimalNegative);</div><div class="line"></div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive ROUND_HALF_UP=&#123;&#125;"</span>, bigDecimalPositive.setScale(<span class="number">1</span>, BigDecimal.ROUND_HALF_UP));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative ROUND_HALF_UP=&#123;&#125;"</span>, bigDecimalNegative.setScale(<span class="number">1</span>, BigDecimal.ROUND_HALF_UP));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bigDecimalPositive ROUND_HALF_UP=6302079.1</div><div class="line">bigDecimalNegative ROUND_HALF_UP=-6302079.1</div></pre></td></tr></table></figure></p><h4 id="3-6-ROUND-HALF-DOWN"><a href="#3-6-ROUND-HALF-DOWN" class="headerlink" title="3.6 ROUND_HALF_DOWN"></a>3.6 ROUND_HALF_DOWN</h4><blockquote><p>Rounding mode to round towards “nearest neighbor” unless both neighbors are equidistant, in which case round down. Behaves as for ROUND_UP if the discarded fraction is &gt; 0.5; otherwise, behaves as for ROUND_DOWN.</p></blockquote><p>不关心正负的无脑四舍五入，如果是5，那么舍掉。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBigDecimalRound</span><span class="params">()</span> </span>&#123;</div><div class="line">    BigDecimal bigDecimalPositive = <span class="keyword">new</span> BigDecimal(<span class="string">"6302079.05"</span>) ;</div><div class="line">    BigDecimal bigDecimalNegative = <span class="keyword">new</span> BigDecimal(<span class="string">"-6302079.05"</span>) ;</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive=&#123;&#125;"</span>, bigDecimalPositive);</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative=&#123;&#125;"</span>, bigDecimalNegative);</div><div class="line"></div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive ROUND_HALF_DOWN=&#123;&#125;"</span>, bigDecimalPositive.setScale(<span class="number">1</span>, BigDecimal.ROUND_HALF_DOWN));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative ROUND_HALF_DOWN=&#123;&#125;"</span>, bigDecimalNegative.setScale(<span class="number">1</span>, BigDecimal.ROUND_HALF_DOWN));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bigDecimalPositive ROUND_HALF_DOWN=6302079.0</div><div class="line">bigDecimalNegative ROUND_HALF_DOWN=-6302079.0</div></pre></td></tr></table></figure></p><h4 id="3-7-ROUND-HALF-EVEN"><a href="#3-7-ROUND-HALF-EVEN" class="headerlink" title="3.7 ROUND_HALF_EVEN"></a>3.7 ROUND_HALF_EVEN</h4><blockquote><p>Rounding mode to round towards the “nearest neighbor” unless both neighbors are equidistant, in which case, round towards the even neighbor. Behaves as for ROUND_HALF_UP if the digit to the left of the discarded fraction is odd; behaves as for ROUND_HALF_DOWN if it’s even.</p></blockquote><p>不关心正负的无脑四舍五入，如果是5，那么看左边数字奇偶性，如果左边数字是奇数，那么进位，如果是偶数，那么舍掉。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBigDecimalRound</span><span class="params">()</span> </span>&#123;</div><div class="line">    BigDecimal bigDecimalPositive = <span class="keyword">new</span> BigDecimal(<span class="string">"6302079.05"</span>) ;</div><div class="line">    BigDecimal bigDecimalNegative = <span class="keyword">new</span> BigDecimal(<span class="string">"-6302079.05"</span>) ;</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive=&#123;&#125;"</span>, bigDecimalPositive);</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative=&#123;&#125;"</span>, bigDecimalNegative);</div><div class="line"></div><div class="line">    <span class="comment">// 最后一位的前一位是偶数，那么ROUND_HALF_EVEN等同与ROUND_HALF_DOWN</span></div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive ROUND_HALF_DOWN=&#123;&#125;"</span>, bigDecimalPositive.setScale(<span class="number">1</span>, BigDecimal.ROUND_HALF_EVEN));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative ROUND_HALF_DOWN=&#123;&#125;"</span>, bigDecimalNegative.setScale(<span class="number">1</span>, BigDecimal.ROUND_HALF_EVEN));</div><div class="line"></div><div class="line">    <span class="comment">// 将最后一位的前一位变成奇数，那么ROUND_HALF_EVEN等同与ROUND_HALF_UP</span></div><div class="line">    bigDecimalPositive = <span class="keyword">new</span> BigDecimal(<span class="string">"6302079.15"</span>);</div><div class="line">    bigDecimalNegative = <span class="keyword">new</span> BigDecimal(<span class="string">"-6302079.15"</span>);</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalPositive ROUND_HALF_DOWN=&#123;&#125;"</span>, bigDecimalPositive.setScale(<span class="number">1</span>, BigDecimal.ROUND_HALF_EVEN));</div><div class="line">    LOGGER.info(<span class="string">"bigDecimalNegative ROUND_HALF_DOWN=&#123;&#125;"</span>, bigDecimalNegative.setScale(<span class="number">1</span>, BigDecimal.ROUND_HALF_EVEN));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">bigDecimalPositive ROUND_HALF_DOWN=6302079.0</div><div class="line">bigDecimalNegative ROUND_HALF_DOWN=-6302079.0</div><div class="line">bigDecimalPositive ROUND_HALF_DOWN=6302079.2</div><div class="line">bigDecimalNegative ROUND_HALF_DOWN=-6302079.2</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-构造函数的坑&quot;&gt;&lt;a href=&quot;#1-构造函数的坑&quot; class=&quot;headerlink&quot; title=&quot;1. 构造函数的坑&quot;&gt;&lt;/a&gt;1. 构造函数的坑&lt;/h3&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BigDecimalTest&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String[] args)&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;double&lt;/span&gt; number = &lt;span class=&quot;number&quot;&gt;6302079.05&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      BigDecimal bigDecimalFromDouble = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BigDecimal(number);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      LOGGER.info(&lt;span class=&quot;string&quot;&gt;&quot;bigDecimalFromDouble=&amp;#123;&amp;#125;&quot;&lt;/span&gt;, bigDecimalFromDouble);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      BigDecimal bigDecimalFromString = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BigDecimal(String.valueOf(number)) ;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      LOGGER.info(&lt;span class=&quot;string&quot;&gt;&quot;bigDecimalFromString=&amp;#123;&amp;#125;&quot;&lt;/span&gt;, bigDecimalFromString);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出结果：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;bigDecimalFromDouble=6302079.049999999813735485076904296875&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bigDecimalFromString=6302079.05&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可以看到，直接使用double作为参数构造BigDecimal时，会丢失精度。&lt;br&gt;所以推荐的是先将double转化为字符串，然后赋值给构造函数。&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="https://damon4u.github.io/categories/java/"/>
    
    
      <category term="java" scheme="https://damon4u.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>git撤销修改</title>
    <link href="https://damon4u.github.io//blog/2018/09/git%E6%92%A4%E9%94%80%E4%BF%AE%E6%94%B9.html"/>
    <id>https://damon4u.github.io//blog/2018/09/git撤销修改.html</id>
    <published>2018-09-11T08:41:50.000Z</published>
    <updated>2018-09-11T14:41:24.068Z</updated>
    
    <content type="html"><![CDATA[<p>基本的命令含义参考:<a href="https://github.com/geeeeeeeeek/git-recipes/wiki/5.2-%E4%BB%A3%E7%A0%81%E5%9B%9E%E6%BB%9A%EF%BC%9AReset%E3%80%81Checkout%E3%80%81Revert%E7%9A%84%E9%80%89%E6%8B%A9" target="_blank" rel="external">代码回滚：Reset、Checkout、Revert的选择</a></p><p>初始化一个空的测试目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> ~/git/ git init</div><div class="line">Initialized empty Git repository in /Users/git/.git/</div><div class="line"> ~/git/ [master] ls</div><div class="line"> ~/git/ [master]</div></pre></td></tr></table></figure></p><a id="more"></a><h3 id="1-撤销新增文件"><a href="#1-撤销新增文件" class="headerlink" title="1.撤销新增文件"></a>1.撤销新增文件</h3><h4 id="1-1-还没有add"><a href="#1-1-还没有add" class="headerlink" title="1.1 还没有add"></a>1.1 还没有add</h4><p>如果是新增的文件，还没有add提交到缓冲区，只是工作区做了修改，此时该文件是不受git管理的，所以直接修改或者删除该文件就好.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] touch A.java</div><div class="line"> ~/git/ [master] ls</div><div class="line">A.java</div><div class="line"> ~/git/ [master] git status</div><div class="line">On branch master</div><div class="line"></div><div class="line">Initial commit</div><div class="line"></div><div class="line">Untracked files:</div><div class="line">  (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)</div><div class="line"></div><div class="line">A.java</div><div class="line"></div><div class="line">nothing added to commit but untracked files present (use &quot;git add&quot; to track)</div></pre></td></tr></table></figure></p><p>假如我们写了一个新的代码类A.java，然后还没有add提交，现在你后悔了，发现这个类没什么卵用，打算删除掉，那么，直接干掉就好，git也不会在意，反正它根本就不知道A.java的存在（Untracked）。</p><h4 id="1-2-add了，但是还没有commit"><a href="#1-2-add了，但是还没有commit" class="headerlink" title="1.2 add了，但是还没有commit"></a>1.2 add了，但是还没有commit</h4><p>假如你觉得A.java写的还有点意义，把它加入到缓存区，准备交由git管理：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] git add A.java</div><div class="line"> ~/git/ [master] git status</div><div class="line">On branch master</div><div class="line"></div><div class="line">Initial commit</div><div class="line"></div><div class="line">Changes to be committed:</div><div class="line">  (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</div><div class="line"></div><div class="line">new file:   A.java</div></pre></td></tr></table></figure></p><p>刚add完，发现有个错误，或者又反悔了，不想add了，想从缓存区中拿出来，返回到没有add时的状态，那么，可以根据提示，使用下面的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] git rm --cached A.java</div><div class="line">rm &apos;A.java&apos;</div><div class="line"> ~/git/ [master] git status</div><div class="line">On branch master</div><div class="line"></div><div class="line">Initial commit</div><div class="line"></div><div class="line">Untracked files:</div><div class="line">  (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)</div><div class="line"></div><div class="line">A.java</div><div class="line"></div><div class="line">nothing added to commit but untracked files present (use &quot;git add&quot; to track)</div></pre></td></tr></table></figure></p><p>看，回到了没有add时的状态了。<br>如果你觉得A.java根本毫无存在价值，从缓存区拿出来之后就直接扔掉了，不需要恢复到add前的状态，而是直接删除，那么可以使用下面的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] git rm -f A.java</div><div class="line">rm &apos;A.java&apos;</div><div class="line"> ~/git/ [master] ls</div><div class="line"> ~/git/ [master] git status</div><div class="line">On branch master</div><div class="line"></div><div class="line">Initial commit</div><div class="line"></div><div class="line">nothing to commit (create/copy files and use &quot;git add&quot; to track)</div></pre></td></tr></table></figure></p><p>看，A.java已经从这个世界消失了。<br>有人不服，说，我直接删除A.java不就好了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] rm A.java</div><div class="line"> ~/git/ [master] git status</div><div class="line">On branch master</div><div class="line"></div><div class="line">Initial commit</div><div class="line"></div><div class="line">Changes to be committed:</div><div class="line">  (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</div><div class="line"></div><div class="line">new file:   A.java</div><div class="line"></div><div class="line">Changes not staged for commit:</div><div class="line">  (use &quot;git add/rm &lt;file&gt;...&quot; to update what will be committed)</div><div class="line">  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</div><div class="line"></div><div class="line">deleted:    A.java</div><div class="line"></div><div class="line"> ~/git/ [master] ls</div></pre></td></tr></table></figure></p><p>可以看到，A.java确实也不见了。<br>但是仍然会看到有一个修改没有提交，在缓存区里发呆。<br>不仅如此，工作区多了一个为提交的修改，是delete: A.java。</p><blockquote><p>由此看出，直接删除文件，相当于是一种新增的修改操作，而不是对之前git操作的撤销。</p></blockquote><p>注意看提示，使用<code>git add/rm &lt;file&gt;</code>命令将修改更新缓存区或者使用<code>git checkout -- &lt;file&gt;</code>将修改撤销。<br>我们先试一下第一种：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] git add A.java</div><div class="line"> ~/git/ [master] git status</div><div class="line">On branch master</div><div class="line"></div><div class="line">Initial commit</div><div class="line"></div><div class="line">nothing to commit (create/copy files and use &quot;git add&quot; to track)</div><div class="line"> ~/git/ [master] ls</div></pre></td></tr></table></figure></p><p>提交修改之后，缓冲区也清净了。<br>再试试第二种：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] git checkout -- A.java</div><div class="line"> ~/git/ [master] git status</div><div class="line">On branch master</div><div class="line"></div><div class="line">Initial commit</div><div class="line"></div><div class="line">Changes to be committed:</div><div class="line">  (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</div><div class="line"></div><div class="line">new file:   A.java</div><div class="line"></div><div class="line"> ~/git/ [master] ls</div><div class="line">A.java</div></pre></td></tr></table></figure></p><p>看到，缓存区保持原样，A.java又回到了现实世界，撤销了上一次的文件删除修改。</p><h4 id="1-3-commit了"><a href="#1-3-commit了" class="headerlink" title="1.3 commit了"></a>1.3 commit了</h4><p>如果自信满满的commit了，然后后悔了，想干掉。分两种情况：<br>第一种情况是，像例子里面这样，第一次提交，之前没有commit过，那如果想撤销本次提交，我还没想到方法。<br>只能去删除A.java，然后再来一次提交，第一次提交的黑历史无法抹去。<br>或者使用revert命令，通过一个新的提交，撤销某一次提交：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] git revert HEAD</div><div class="line">[master 32a2e57] Revert &quot;A&quot;</div><div class="line"> 1 file changed, 0 insertions(+), 0 deletions(-)</div><div class="line"> delete mode 100644 A.java</div><div class="line"> ~/git/ [master] ls</div></pre></td></tr></table></figure></p><p>revert命令是撤销某一次提交，HEAD指的是最新的一次提交。<br>期间，会让你确认一下提交备注：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Revert &quot;A&quot;</div><div class="line"></div><div class="line">This reverts commit 969bb74c6125dc9fe4d1ef2327d4fda41a81fa6f.</div><div class="line"></div><div class="line"># Please enter the commit message for your changes. Lines starting</div><div class="line"># with &apos;#&apos; will be ignored, and an empty message aborts the commit.</div><div class="line"># On branch master</div><div class="line"># Changes to be committed:</div><div class="line"># deleted:    A.java</div><div class="line">#</div></pre></td></tr></table></figure></p><p>我们看到，上一次提交添加的A.java已经消失了，只是在git提交日志里面，能看到两条记录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">* 32a2e57 (HEAD -&gt; master) Revert &quot;A&quot;</div><div class="line">* 5b6ce5c A</div></pre></td></tr></table></figure></p><p>第二种情况是，非第一次提交，那么可以使用reset命令撤销提交，在下文中给出。</p><h3 id="2-撤销修改"><a href="#2-撤销修改" class="headerlink" title="2.撤销修改"></a>2.撤销修改</h3><p>我们重新把A.java请回来，初始内容为<code>hello</code>，然后做一次提交：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] vim A.java</div><div class="line"> ~/git/ [master] cat A.java</div><div class="line">hello</div><div class="line"> ~/git/ [master] git add .</div><div class="line"> ~/git/ [master+] git cm &apos;A init&apos;</div><div class="line">[master 5b9ab26] A init</div><div class="line"> 1 file changed, 0 insertions(+), 0 deletions(-)</div><div class="line"> create mode 100644 A.java</div><div class="line"> ~/git/ [master] ls</div><div class="line">A.java</div></pre></td></tr></table></figure></p><h4 id="2-1-还没有add"><a href="#2-1-还没有add" class="headerlink" title="2.1 还没有add"></a>2.1 还没有add</h4><p>老大说A.java有bug，需要修改，于是我们开始做每天最常见的游戏fix，将内容修改为<code>world</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] vim A.java</div><div class="line"> ~/git/ [master*] cat A.java</div><div class="line">world</div><div class="line"> ~/git/ [master*] git status</div><div class="line">On branch master</div><div class="line">Changes not staged for commit:</div><div class="line">  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</div><div class="line">  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</div><div class="line"></div><div class="line">modified:   A.java</div><div class="line"></div><div class="line">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</div></pre></td></tr></table></figure></p><p>修改完，可以看到提示，如果你觉得没问题，就add，这很正常~<br>但是，有一天脑袋不清醒，写了一大堆看不懂的代码，而且把原来的逻辑改的乱七八糟，现在唯一想做的就是把这些该死的代码删掉，恢复到上一次add或者commit的状态。<br>当然，你可以选择手动的删除，或者，使用提示中的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master*] git checkout -- A.java</div><div class="line"> ~/git/ [master] cat A.java</div><div class="line">hello</div></pre></td></tr></table></figure></p><p>意思就是,把A.java在工作区的修改全部撤销,这里有两种情况:<br>一种是A.java自修改后还没有被放到暂存区,现在,撤销修改就回到和版本库一模一样的状态（上一次commit）;<br>一种是A.java已经add到暂存区后,又作了修改,现在,撤销修改就回到添加到暂存区后的状态（上一次add）。</p><h4 id="2-2-已经add了，但是没有commit"><a href="#2-2-已经add了，但是没有commit" class="headerlink" title="2.2 已经add了，但是没有commit"></a>2.2 已经add了，但是没有commit</h4><p>信心满满的add了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master*] git add A.java</div><div class="line"> ~/git/ [master+] git status</div><div class="line">On branch master</div><div class="line">Changes to be committed:</div><div class="line">  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)</div><div class="line"></div><div class="line">modified:   A.java</div></pre></td></tr></table></figure></p><p>如果发现有问题，想把A.java从缓存区拿出来，可以使用提示命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master+] git reset HEAD A.java</div><div class="line">Unstaged changes after reset:</div><div class="line">MA.java</div><div class="line"> ~/git/ [master*] git status</div><div class="line">On branch master</div><div class="line">Changes not staged for commit:</div><div class="line">  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</div><div class="line">  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</div><div class="line"></div><div class="line">modified:   A.java</div><div class="line"></div><div class="line">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</div></pre></td></tr></table></figure></p><p>现在，A.java回到了add前的状态。</p><p>注意，这里是对指定文件的撤回，参数<code>--hard</code>是没用的（后面讲），因为该操作不会影响工作区，肯定会回到add前的状态，保留工作区修改。<br>如果想撤销工作区的修改，可以进一步使用上面的<code>git checkout --&lt;file&gt;</code>命令。</p><h4 id="3-3-已经commit了"><a href="#3-3-已经commit了" class="headerlink" title="3.3 已经commit了"></a>3.3 已经commit了</h4><p>如果已经commit了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master+] git commit -m &apos;fix A.java&apos;</div><div class="line">[master 17acd80] fix A.java</div><div class="line"> 1 file changed, 1 insertion(+), 1 deletion(-)</div><div class="line"> ~/git/ [master] git status</div><div class="line">On branch master</div><div class="line">nothing to commit, working directory clean</div></pre></td></tr></table></figure></p><p>现在，如果想撤回这次提交，干掉黑历史，回到之前的某个提交版本，可以使用下面的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] git reset HEAD^</div><div class="line">Unstaged changes after reset:</div><div class="line">MA.java</div><div class="line"> ~/git/ [master*] git status</div><div class="line">On branch master</div><div class="line">Changes not staged for commit:</div><div class="line">  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</div><div class="line">  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</div><div class="line"></div><div class="line">modified:   A.java</div><div class="line"></div><div class="line">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</div></pre></td></tr></table></figure></p><p>看，代码回到了上一次提交，add前的状态。并且git log中，提交黑历史也不见了。</p><p><code>git reset</code>命令常用的参数包括三种：</p><ul><li>–soft – 缓存区和工作目录都不会被改变</li><li>–mixed – 默认选项。缓存区和你指定的提交同步，但工作目录不受影响</li><li>–hard – 缓存区和工作目录都同步到你指定的提交</li></ul><p>把这些标记想成定义<code>git reset</code>操作的作用域就容易理解多了。<br><img src="https://camo.githubusercontent.com/6f605243c7eedce24cd32e53348d7f5b2db20bff/68747470733a2f2f7777772e61746c61737369616e2e636f6d2f6769742f696d616765732f7475746f7269616c732f616476616e6365642f726573657474696e672d636865636b696e672d6f75742d616e642d726576657274696e672f30332e737667" alt="git reset"></p><p>这些标记往往和HEAD作为参数一起使用。比如，<code>git reset --mixed HEAD</code> 将你当前的改动从缓存区中移除，但是这些改动还留在工作目录中。另一方面，如果你想完全舍弃你没有提交的改动，你可以使用<code>git reset --hard HEAD</code>。这是git reset最常用的两种用法。</p><p><strong>关于回退版本：</strong><br>查看提交历史，以便确定要回退到哪个版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git log</div></pre></td></tr></table></figure></p><p>查看命令历史,以便确定要回到未来的哪个版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reflog</div></pre></td></tr></table></figure></p><p>版本更换<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset  [--hard] commit_id</div></pre></td></tr></table></figure></p><p>由于HEAD指向的版本就是当前版本，所以上一个版本就是HEAD^,上上个版本就是HEAD^^,当然往上100个版本写100个^比较容易数不过来,所以写成HEAD~100。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;基本的命令含义参考:&lt;a href=&quot;https://github.com/geeeeeeeeek/git-recipes/wiki/5.2-%E4%BB%A3%E7%A0%81%E5%9B%9E%E6%BB%9A%EF%BC%9AReset%E3%80%81Checkout%E3%80%81Revert%E7%9A%84%E9%80%89%E6%8B%A9&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;代码回滚：Reset、Checkout、Revert的选择&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;初始化一个空的测试目录：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt; ~/git/ git init&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Initialized empty Git repository in /Users/git/.git/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; ~/git/ [master] ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; ~/git/ [master]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="git" scheme="https://damon4u.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://damon4u.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>git从某一次提交上创建分支</title>
    <link href="https://damon4u.github.io//blog/2018/09/git%E4%BB%8E%E6%9F%90%E4%B8%80%E6%AC%A1%E6%8F%90%E4%BA%A4%E4%B8%8A%E5%88%9B%E5%BB%BA%E5%88%86%E6%94%AF.html"/>
    <id>https://damon4u.github.io//blog/2018/09/git从某一次提交上创建分支.html</id>
    <published>2018-09-11T08:41:50.000Z</published>
    <updated>2018-09-11T14:34:38.831Z</updated>
    
    <content type="html"><![CDATA[<p>从某一次提交上创建分支使用如下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git branch &lt;branch name&gt; &lt;start point&gt;</div></pre></td></tr></table></figure></p><p>平时我们是在当前分支的最新代码上迁出新分支，那么可以忽略后面的<code>&lt;start point&gt;</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git branch new_branch</div></pre></td></tr></table></figure><p>假如我们想在某一次提交的基础上迁出新分支，那么就需要使用<code>&lt;start point&gt;</code>了，写上该提交的SHA值。<br><a id="more"></a></p><p>举例：<br>我们已经有了三次提交，提交历史如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~/git/ [master] git l</div><div class="line">* 666898f (HEAD -&gt; master) c; - damon4u, 2 seconds ago</div><div class="line">* e713719 b - damon4u, 20 seconds ago</div><div class="line">* 36acecc a - damon4u, 30 seconds ago</div></pre></td></tr></table></figure></p><p>假如我们想从b上面迁出新分支，可以这么做：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] git branch new_branch e713719</div></pre></td></tr></table></figure></p><p>用b提交的SHA做参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> ~/git/ [master] git branch</div><div class="line">* master</div><div class="line">  new_branch</div><div class="line"> ~/git/ [master] git checkout new_branch</div><div class="line">Switched to branch &apos;new_branch&apos;</div><div class="line"> ~/git/ [new_branch] git l</div><div class="line">* 666898f (master) c; - damon4u, 3 minutes ago</div><div class="line">* e713719 (HEAD -&gt; new_branch) b - damon4u, 4 minutes ago</div><div class="line">* 36acecc a - damon4u, 4 minutes ago</div></pre></td></tr></table></figure></p><p>发现，HEAD的指向b提交的。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;从某一次提交上创建分支使用如下命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;git branch &amp;lt;branch name&amp;gt; &amp;lt;start point&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;平时我们是在当前分支的最新代码上迁出新分支，那么可以忽略后面的&lt;code&gt;&amp;lt;start point&amp;gt;&lt;/code&gt;。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;git branch new_branch&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;假如我们想在某一次提交的基础上迁出新分支，那么就需要使用&lt;code&gt;&amp;lt;start point&amp;gt;&lt;/code&gt;了，写上该提交的SHA值。&lt;br&gt;
    
    </summary>
    
      <category term="git" scheme="https://damon4u.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://damon4u.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>git远程仓库管理</title>
    <link href="https://damon4u.github.io//blog/2018/09/git%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86.html"/>
    <id>https://damon4u.github.io//blog/2018/09/git远程仓库管理.html</id>
    <published>2018-09-11T08:41:50.000Z</published>
    <updated>2018-09-11T14:39:45.501Z</updated>
    
    <content type="html"><![CDATA[<p>查看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git remote -v</div></pre></td></tr></table></figure></p><p>添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git remote add origin git@github.com:michaelliao/learngit.git</div></pre></td></tr></table></figure></p><p>修改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git remote set-url origin git@github.com:michaelliao/learngit.git</div></pre></td></tr></table></figure></p><p>或者：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git remote rm origin</div><div class="line">git remote add origin git@...git</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;查看：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div 
      
    
    </summary>
    
      <category term="git" scheme="https://damon4u.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://damon4u.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>git分支操作</title>
    <link href="https://damon4u.github.io//blog/2018/09/git%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C.html"/>
    <id>https://damon4u.github.io//blog/2018/09/git分支操作.html</id>
    <published>2018-09-11T08:41:50.000Z</published>
    <updated>2018-09-11T14:34:38.832Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-checkout远程分支到本地"><a href="#1-checkout远程分支到本地" class="headerlink" title="1.checkout远程分支到本地"></a>1.checkout远程分支到本地</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout -b &lt;local_branch_name&gt; origin/&lt;remote_branch_name&gt;</div></pre></td></tr></table></figure><h3 id="2-提交到远程分支"><a href="#2-提交到远程分支" class="headerlink" title="2.提交到远程分支"></a>2.提交到远程分支</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git push origin &lt;remote_branch_name&gt;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;1-checkout远程分支到本地&quot;&gt;&lt;a href=&quot;#1-checkout远程分支到本地&quot; class=&quot;headerlink&quot; title=&quot;1.checkout远程分支到本地&quot;&gt;&lt;/a&gt;1.checkout远程分支到本地&lt;/h3&gt;&lt;figure class
      
    
    </summary>
    
      <category term="git" scheme="https://damon4u.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://damon4u.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>git删除操作</title>
    <link href="https://damon4u.github.io//blog/2018/09/git%E5%88%A0%E9%99%A4%E6%93%8D%E4%BD%9C.html"/>
    <id>https://damon4u.github.io//blog/2018/09/git删除操作.html</id>
    <published>2018-09-11T08:41:50.000Z</published>
    <updated>2018-09-11T14:34:38.832Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-同时从本地与版本库中删除"><a href="#1-同时从本地与版本库中删除" class="headerlink" title="1.同时从本地与版本库中删除"></a>1.同时从本地与版本库中删除</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git rm [-r] [-n] &lt;file&gt;</div></pre></td></tr></table></figure><p><code>-r</code>参数递归移除目录。<br><code>-n</code>加上这个参数，执行命令时，是不会删除任何文件，而是展示此命令要删除的文件列表预览，所以一般用这个参数先看看要删除哪些文件，防止误删，确认之后，就去掉此参数，真正的删除文件。</p><h3 id="2-仅从版本库中删除"><a href="#2-仅从版本库中删除" class="headerlink" title="2.仅从版本库中删除"></a>2.仅从版本库中删除</h3><p>我们想把文件从 Git 仓库中删除(亦即从暂存区域移除),但仍然希 望保留在当前工作目录中。换句话说,仅是从跟踪清单中删除。<br>比如一些大型日志文件或者一堆.a 编译文件,不小心纳入仓库后,要移除跟踪但不删除文件,以便稍后在 .gitignore 文件中补上,用 –cached 选项即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git rm [-r] [-n] --cached &lt;file&gt;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;1-同时从本地与版本库中删除&quot;&gt;&lt;a href=&quot;#1-同时从本地与版本库中删除&quot; class=&quot;headerlink&quot; title=&quot;1.同时从本地与版本库中删除&quot;&gt;&lt;/a&gt;1.同时从本地与版本库中删除&lt;/h3&gt;&lt;figure class=&quot;highlight 
      
    
    </summary>
    
      <category term="git" scheme="https://damon4u.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://damon4u.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>git回滚</title>
    <link href="https://damon4u.github.io//blog/2018/09/git%E5%9B%9E%E6%BB%9A.html"/>
    <id>https://damon4u.github.io//blog/2018/09/git回滚.html</id>
    <published>2018-09-11T08:41:50.000Z</published>
    <updated>2018-09-11T14:37:51.069Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-git-revert"><a href="#1-git-revert" class="headerlink" title="1.git revert"></a>1.git revert</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git revert &lt;commit&gt;</div></pre></td></tr></table></figure><p>命令的含义是:</p><blockquote><p>Given one or more existing commits, revert the changes that the related patches introduce, and record some new commits that record them. This requires your working tree to be clean (no modifications from the HEAD commit).</p><p>Note: git revert is used to record some new commits to reverse the effect of some earlier commits (often only a faulty one).<br>If you want to throw away all uncommitted changes in your working directory, you should see <code>git-reset</code>, particularly the <code>--hard</code> option.<br>If you want to extract specific files as they were in another commit, you should see <code>git-checkout</code>, specifically the <code>git checkout &lt;commit&gt; -- &lt;filename&gt;</code> syntax.<br>Take care with these alternatives as both will discard uncommitted changes in your working directory.</p></blockquote><a id="more"></a><p>这里解释的很清楚，<strong>revert命令会撤销某一次提交引入的修改，并且会产生一次新的提交。</strong><br>下面的Note部分对reset、checkout做了区分：<br>如果你想把工作区没有提交的修改扔掉，那么使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset --hard</div></pre></td></tr></table></figure></p><p>如果你想检出某一次提交版本的文件，那么使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout &lt;commit&gt; -- &lt;filename&gt;</div></pre></td></tr></table></figure></p><p>对于revert命令，需要注意一点，如果使用下面的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git revert HEAD~1</div></pre></td></tr></table></figure></p><p>那么只会撤销上上次这一次提交的修改，而不会撤销上次提交的修改。它并不是回退到HEAD~1前的版本。<br>举个例子：<br>假如现在有三次提交：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">* c5ce0d0 (HEAD -&gt; master) c - damon4u, 9 seconds ago</div><div class="line">* 131ffaa b - damon4u, 25 seconds ago</div><div class="line">* d8f0aa0 a - damon4u, 33 seconds ago</div></pre></td></tr></table></figure></p><p>然后执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git revert HEAD^</div></pre></td></tr></table></figure></p><p>撤销上上次的修改，执行后会让我们写备注信息，从这里我们可以看到，这次revert会撤销131ffaa这次修改，这次撤销会删除b。<br>注意，只删除了b，没有说删除c，也就是说，上次的修改是不会收到影响的，不会回到a那次提交。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Revert &quot;b&quot;</div><div class="line"></div><div class="line">This reverts commit 131ffaa420d3e27dddc10caa3a089fb8679c034a.</div><div class="line"></div><div class="line"># Please enter the commit message for your changes. Lines starting</div><div class="line"># with &apos;#&apos; will be ignored, and an empty message aborts the commit.</div><div class="line"># On branch master</div><div class="line"># Changes to be committed:</div><div class="line">#       deleted:    b</div><div class="line">#</div></pre></td></tr></table></figure></p><p>再看一下日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">* 16481c1 (HEAD -&gt; master) Revert &quot;b&quot; - damon4u, 3 minutes ago</div><div class="line">* c5ce0d0 c - damon4u, 4 minutes ago</div><div class="line">* 131ffaa b - damon4u, 4 minutes ago</div><div class="line">* d8f0aa0 a - damon4u, 5 minutes ago</div></pre></td></tr></table></figure></p><p>多了一条回滚的提交。</p><p>线上推荐使用revert来撤销最近一次提交，回滚到上一个版本，因为不会影响历史记录，只是新增一次提交，比较安全。<br>但是如果要回滚到指定commit，那么可以使用reset命令或者checkout命令，下面介绍。</p><h3 id="2-git-reset"><a href="#2-git-reset" class="headerlink" title="2.git reset"></a>2.git reset</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset [&lt;commit&gt;]</div></pre></td></tr></table></figure><blockquote><p>This form resets the current branch head to <code>&lt;commit&gt;</code> and possibly updates the index (resetting it to the tree of <code>&lt;commit&gt;</code>) and the working tree depending on <code>&lt;mode&gt;</code>. If <code>&lt;mode&gt;</code> is omitted, defaults to “<code>--mixed</code>“. The <code>&lt;mode&gt;</code> must be one of the following:</p></blockquote><p>这里解释的也比较明白，使用reset命令可以将当前分支的HEAD指向某一次提交，并更新当前的工作区到那次提交，mode模式跟之前撤销工作区修改时一样，默认是–mixed，即恢复到add后，没提交前。</p><p>还用上次的例子：<br>我们先把b请回来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git revert HEAD</div></pre></td></tr></table></figure></p><p>这个命令是撤销上一次提交，还记得，上次提交把b删了，那么撤销它，就能把b找回来。</p><p>假如我们发现b和c都没有用，想回到只有a的时候，那么先在日志中找到只有a的那次提交SHA值<code>d8f0aa0</code>，然后执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset d8f0aa0</div></pre></td></tr></table></figure></p><p>这样，就只有a了，并且历史也被我们篡改，看不到b和c的提交历史啦。<br>所以说，这样做还是很危险的。适合本地操作。<br>如果想找回b和c怎么办呢？<br>先找到包含bhec的SHA<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reflog</div></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">d8f0aa0 HEAD@&#123;0&#125;: reset: moving to d8f0aa0</div><div class="line">0bc9d5a HEAD@&#123;1&#125;: revert: Revert &quot;Revert &quot;a&quot;&quot;</div><div class="line">97adb10 HEAD@&#123;2&#125;: revert: Revert &quot;a&quot;</div><div class="line">c972a81 HEAD@&#123;3&#125;: revert: Revert &quot;Revert &quot;b&quot;&quot;</div><div class="line">16481c1 HEAD@&#123;4&#125;: revert: Revert &quot;b&quot;</div><div class="line">c5ce0d0 HEAD@&#123;5&#125;: commit: c</div><div class="line">131ffaa HEAD@&#123;6&#125;: commit: b</div><div class="line">d8f0aa0 HEAD@&#123;7&#125;: commit (initial): a</div></pre></td></tr></table></figure><p>也就是<code>c5ce0d0</code>，<br>然后执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset c5ce0d0</div></pre></td></tr></table></figure></p><p>就找回了b和c。</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-git-revert&quot;&gt;&lt;a href=&quot;#1-git-revert&quot; class=&quot;headerlink&quot; title=&quot;1.git revert&quot;&gt;&lt;/a&gt;1.git revert&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;git revert &amp;lt;commit&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;命令的含义是:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Given one or more existing commits, revert the changes that the related patches introduce, and record some new commits that record them. This requires your working tree to be clean (no modifications from the HEAD commit).&lt;/p&gt;
&lt;p&gt;Note: git revert is used to record some new commits to reverse the effect of some earlier commits (often only a faulty one).&lt;br&gt;If you want to throw away all uncommitted changes in your working directory, you should see &lt;code&gt;git-reset&lt;/code&gt;, particularly the &lt;code&gt;--hard&lt;/code&gt; option.&lt;br&gt;If you want to extract specific files as they were in another commit, you should see &lt;code&gt;git-checkout&lt;/code&gt;, specifically the &lt;code&gt;git checkout &amp;lt;commit&amp;gt; -- &amp;lt;filename&amp;gt;&lt;/code&gt; syntax.&lt;br&gt;Take care with these alternatives as both will discard uncommitted changes in your working directory.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="git" scheme="https://damon4u.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://damon4u.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>git配置信息管理</title>
    <link href="https://damon4u.github.io//blog/2018/09/git%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%AE%A1%E7%90%86.html"/>
    <id>https://damon4u.github.io//blog/2018/09/git配置信息管理.html</id>
    <published>2018-09-11T08:41:50.000Z</published>
    <updated>2018-09-11T14:41:01.020Z</updated>
    
    <content type="html"><![CDATA[<p>查看git全局设置信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config -l</div></pre></td></tr></table></figure></p><p>设置配置信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --global user.name=&quot;Your Name&quot;</div></pre></td></tr></table></figure></p><p>这里的<code>--global</code>参数表示示你这台机器上所有的Git仓库都会使用用这个配置,当然也可以对某个仓库指定不同的用用户名和Email地址。</p><p>配置别名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">git config --global alias.st status</div><div class="line">git config --global alias.co checkout</div><div class="line">git config --global alias.ci commit</div><div class="line">git config --global alias.br branch</div><div class="line">git config --global alias.unstage &apos;reset HEAD&apos;</div><div class="line">git config --global alias.last &apos;log -1&apos;</div><div class="line">git config --global alias.lg &quot;log --color --graph --pretty=format:&apos;%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&apos; --abbrev-commit&quot;</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;查看git全局设置信息：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;
      
    
    </summary>
    
      <category term="git" scheme="https://damon4u.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://damon4u.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>cpu过高</title>
    <link href="https://damon4u.github.io//blog/2018/09/cpu%E8%BF%87%E9%AB%98.html"/>
    <id>https://damon4u.github.io//blog/2018/09/cpu过高.html</id>
    <published>2018-09-06T08:41:50.000Z</published>
    <updated>2018-09-10T15:59:02.148Z</updated>
    
    <content type="html"><![CDATA[<p>一个应用占用CPU很高，除了确实是计算密集型应用之外，通常原因都是出现了死循环。</p><p>总体流程：<br>首先显示java进程的线程列表，查找运行时间长的线程:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps -mp pid -o THREAD,tid,time</div></pre></td></tr></table></figure></p><p>或者使用top命令的线程模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">top -p pid</div></pre></td></tr></table></figure></p><p>然后按’H’，进入线程模式，第一列PID为tid（线程id）</p><p>其次将需要的线程ID转换为16进制格式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">printf &quot;%x\n&quot; tid</div></pre></td></tr></table></figure></p><p>最后打印线程的堆栈信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jstack pid |grep tid -A 30</div></pre></td></tr></table></figure></p><a id="more"></a><p>举个例子说明下：</p><h3 id="1-查找进程号"><a href="#1-查找进程号" class="headerlink" title="1. 查找进程号"></a>1. 查找进程号</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ jps -v | grep -v Jps</div><div class="line">43109 Bootstrap ...</div></pre></td></tr></table></figure><p>使用<code>jps</code>命令显示当前的java进程，加上<code>-v</code>参数可以显示进程的详情信息，更好的判断是否是关心的进程。</p><h3 id="2-查找耗时的线程号"><a href="#2-查找耗时的线程号" class="headerlink" title="2. 查找耗时的线程号"></a>2. 查找耗时的线程号</h3><p>一个进程下包含很多线程，我们关心的是那些线程运行了很长时间还没有结束，导致资源一直被占用。<br>第一种方法是使用<code>ps</code>命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ps -mp 43109 -o THREAD,tid,time | sort -r -k9 | head -10</div><div class="line">USER     %CPU PRI SCNT WCHAN  USER SYSTEM   TID     TIME</div><div class="line">appops   14.7   -    - -         -      -     - 03:05:55</div><div class="line">appops    8.0  19    - -         -      - 43422 01:41:26  ------------这个线程执行了01:41:26</div><div class="line">appops    0.2  19    - -         -      - 43411 00:03:44</div><div class="line">appops    0.2  19    - -         -      - 43415 00:03:30</div><div class="line">appops    0.2  19    - -         -      - 43414 00:03:22</div><div class="line">appops    0.2  19    - -         -      - 43424 00:03:20</div><div class="line">appops    0.2  19    - -         -      - 43408 00:03:10</div><div class="line">appops    0.2  19    - -         -      - 43418 00:03:07</div><div class="line">appops    0.2  19    - -         -      - 43407 00:03:06</div></pre></td></tr></table></figure></p><p>其中<code>ps</code>命令查询进程的执行信息，<code>-o</code>命令指定输出信息列，包含线程tid和线程执行时间。然后使用<code>sort</code>命令按时间倒叙排序，取前10行。</p><p>第二种方法是使用<code>top</code>命令：<br>首先输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ top -p 43109</div><div class="line">top - 11:44:11 up 519 days, 23:37,  1 user,  load average: 0.27, 0.28, 0.31</div><div class="line">Tasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie</div><div class="line">%Cpu(s):  1.4 us,  0.9 sy,  0.0 ni, 97.6 id,  0.0 wa,  0.0 hi,  0.1 si,  0.0 st</div><div class="line">KiB Mem:  12330736 total, 11692416 used,   638320 free,    79176 buffers</div><div class="line">KiB Swap:        0 total,        0 used,        0 free,  6568140 cached</div><div class="line"></div><div class="line">  PID USER      PR  NI  VIRT  RES  SHR S  %CPU %MEM    TIME+  COMMAND</div><div class="line">43109 appops    20   0 5225m 3.7g  11m S  16.0 31.4 187:28.17 java</div></pre></td></tr></table></figure></p><p>进入单个进程信息后，输入<code>H</code>，进入线程模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">top - 11:47:16 up 519 days, 23:40,  1 user,  load average: 0.08, 0.20, 0.28</div><div class="line">Threads: 124 total,   0 running, 124 sleeping,   0 stopped,   0 zombie</div><div class="line">%Cpu(s):  1.7 us,  1.0 sy,  0.0 ni, 97.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</div><div class="line">KiB Mem:  12330736 total, 11694844 used,   635892 free,    79176 buffers</div><div class="line">KiB Swap:        0 total,        0 used,        0 free,  6568872 cached</div><div class="line"></div><div class="line">  PID USER      PR  NI  VIRT  RES  SHR S  %CPU %MEM    TIME+  COMMAND</div><div class="line">43422 appops    20   0 5225m 3.7g  11m S  12.3 31.4 103:00.04 java</div><div class="line">43418 appops    20   0 5225m 3.7g  11m S   0.3 31.4   3:07.64 java</div><div class="line">43424 appops    20   0 5225m 3.7g  11m S   0.3 31.4   3:20.64 java</div><div class="line">43442 appops    20   0 5225m 3.7g  11m S   0.3 31.4   0:48.77 java</div><div class="line">43109 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:00.00 java</div><div class="line">43110 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:01.38 java</div><div class="line">43111 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:01.73 java</div><div class="line">43112 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:01.85 java</div><div class="line">43113 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:01.82 java</div><div class="line">43114 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:01.83 java</div><div class="line">43115 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:01.75 java</div><div class="line">43116 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:01.75 java</div><div class="line">43117 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:01.77 java</div><div class="line">43118 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:01.77 java</div><div class="line">43119 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:14.83 java</div><div class="line">43120 appops    20   0 5225m 3.7g  11m S   0.0 31.4   0:00.53 java</div></pre></td></tr></table></figure></p><p>接着输入<code>T</code>，表示按时间倒叙排序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">top - 11:47:54 up 519 days, 23:41,  1 user,  load average: 0.17, 0.20, 0.28</div><div class="line">Threads: 124 total,   0 running, 124 sleeping,   0 stopped,   0 zombie</div><div class="line">%Cpu(s):  1.6 us,  0.7 sy,  0.0 ni, 97.6 id,  0.1 wa,  0.0 hi,  0.0 si,  0.0 st</div><div class="line">KiB Mem:  12330736 total, 11696052 used,   634684 free,    79176 buffers</div><div class="line">KiB Swap:        0 total,        0 used,        0 free,  6569020 cached</div><div class="line"></div><div class="line">  PID USER      PR  NI  VIRT  RES  SHR S  %CPU %MEM    TIME+  COMMAND</div><div class="line">43422 appops    20   0 5225m 3.7g  11m S  13.0 31.4 103:04.72 java</div><div class="line">43411 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:45.74 java</div><div class="line">43415 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:31.93 java</div><div class="line">43414 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:26.41 java</div><div class="line">43424 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:20.64 java</div><div class="line">43408 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:12.97 java</div><div class="line">43418 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:07.73 java</div><div class="line">43407 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:06.85 java</div><div class="line">43412 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:01.83 java</div><div class="line">43419 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:01.40 java</div><div class="line">43438 appops    20   0 5225m 3.7g  11m S   0.0 31.4   3:00.63 java</div><div class="line">43437 appops    20   0 5225m 3.7g  11m S   0.0 31.4   2:59.67 java</div><div class="line">43439 appops    20   0 5225m 3.7g  11m S   0.0 31.4   2:59.61 java</div><div class="line">43413 appops    20   0 5225m 3.7g  11m S   0.0 31.4   2:55.66 java</div><div class="line">43421 appops    20   0 5225m 3.7g  11m S   0.0 31.4   2:51.55 java</div></pre></td></tr></table></figure></p><blockquote><p>注：<br>M %MEM<br>N PID<br>P %CPU<br>T TIME+</p></blockquote><p>同样能找到耗时较多的线程号：43422。</p><h3 id="3-将线程ID转换为16进制格式"><a href="#3-将线程ID转换为16进制格式" class="headerlink" title="3. 将线程ID转换为16进制格式"></a>3. 将线程ID转换为16进制格式</h3><p>由于<code>jstack</code>命令输出的线程id是使用16进制格式，所以我们要将tid转化为16进制进行搜索。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ printf &quot;%x\n&quot; 43422</div><div class="line">a99e</div></pre></td></tr></table></figure></p><h3 id="4-在进程堆栈日志中查找"><a href="#4-在进程堆栈日志中查找" class="headerlink" title="4. 在进程堆栈日志中查找"></a>4. 在进程堆栈日志中查找</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ jstack 43109 |grep a99e -A 30</div><div class="line">&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean#0_Worker-17&quot; prio=10 tid=0x00007fe889c95800 nid=0xa99e runnable [0x00007fe8878f6000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line">at java.net.SocketInputStream.socketRead0(Native Method)</div><div class="line">at java.net.SocketInputStream.read(SocketInputStream.java:152)</div><div class="line">at java.net.SocketInputStream.read(SocketInputStream.java:122)</div><div class="line">at java.net.SocketInputStream.read(SocketInputStream.java:108)</div><div class="line">at redis.clients.util.RedisInputStream.ensureFill(RedisInputStream.java:195)</div><div class="line">at redis.clients.util.RedisInputStream.readByte(RedisInputStream.java:40)</div><div class="line">at redis.clients.jedis.Protocol.process(Protocol.java:128)</div><div class="line">at redis.clients.jedis.Protocol.read(Protocol.java:192)</div><div class="line">at redis.clients.jedis.Connection.readProtocolWithCheckingBroken(Connection.java:282)</div><div class="line">at redis.clients.jedis.Connection.getBinaryBulkReply(Connection.java:201)</div><div class="line">at redis.clients.jedis.BinaryJedis.get(BinaryJedis.java:127)</div><div class="line">...</div></pre></td></tr></table></figure><p>这样能看到具体线程执行情况，以及长时间执行的原因。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;一个应用占用CPU很高，除了确实是计算密集型应用之外，通常原因都是出现了死循环。&lt;/p&gt;
&lt;p&gt;总体流程：&lt;br&gt;首先显示java进程的线程列表，查找运行时间长的线程:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;ps -mp pid -o THREAD,tid,time&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;或者使用top命令的线程模式：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;top -p pid&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后按’H’，进入线程模式，第一列PID为tid（线程id）&lt;/p&gt;
&lt;p&gt;其次将需要的线程ID转换为16进制格式：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;printf &amp;quot;%x\n&amp;quot; tid&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;最后打印线程的堆栈信息：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;jstack pid |grep tid -A 30&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="https://damon4u.github.io/categories/java/"/>
    
    
      <category term="java" scheme="https://damon4u.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>curl命令</title>
    <link href="https://damon4u.github.io//blog/2018/08/curl.html"/>
    <id>https://damon4u.github.io//blog/2018/08/curl.html</id>
    <published>2018-08-29T08:41:50.000Z</published>
    <updated>2018-08-30T09:34:56.823Z</updated>
    
    <content type="html"><![CDATA[<p>curl命令可以方便的调试接口，发送网络请求。</p><a id="more"></a><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h3><p><code>curl</code> - transfer a URL</p><blockquote><p>curl  is  a  tool  to  transfer  data from or to a server, using one of the supported protocols (DICT, FILE, FTP, FTPS,GOPHER, HTTP, HTTPS, IMAP, IMAPS, LDAP, LDAPS, POP3, POP3S, RTMP, RTSP, SCP, SFTP, SMB, SMBS, SMTP, SMTPS,  TELNET  and TFTP).</p><p>curl offers a busload of useful tricks like proxy support, user authentication, FTP upload, HTTP post, SSL connections, cookies, file transfer resume, Metalink, and more.</p></blockquote><p>格式如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl [options] [URL...]</div></pre></td></tr></table></figure></p><p>以下将使用<code>http://requestb.in/1g31nxf1?inspect</code>作为测试URL，在request.bin网站上可以看到每次请求的全部内容，方便测试。</p><h3 id="2-GET"><a href="#2-GET" class="headerlink" title="2.GET"></a>2.GET</h3><p>如果不加任何参数，那么将会使用GET方法发送http请求。<br>例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> ~/ curl "http://requestb.in/1g31nxf1"</div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><p>这样就是一个最简单的GET请求，不包含任何参数和头信息。</p><p>下面加一些请求参数：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> ~/ curl "http://requestb.in/1g31nxf1?username=dj&amp;pwd=123"</div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><h3 id="3-POST"><a href="#3-POST" class="headerlink" title="3.POST"></a>3.POST</h3><p>curl中是使用<code>-d</code>或者<code>--data</code>命令来添加数据的。<br>进而发送一个POST请求。<br>默认的Content-Type是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Content-Type: application/x-www-form-urlencoded</div></pre></td></tr></table></figure></p><p>这里的urlencoded的意思就是需要把请求参数中的特殊符号转化为%XX那种ascii码。如value值中包含有空格，则需要先将空格转换成%20。</p><p>在新版本的CURL中，提供了新的选项 –data-urlencode，通过该选项提供的参数会自动转义特殊字符。</p><p>举例：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> ~/ curl -d "&#123;\"username\":\"alice\",\"pwd\":123&#125;" "http://requestb.in/1g31nxf1"</div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><p>这样，body中就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;username&quot;:&quot;alice&quot;,&quot;pwd&quot;:123&#125;</div></pre></td></tr></table></figure></p><p>我们来换一种：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -d "username=bob" -d "pwd=123" "http://requestb.in/1g31nxf1"</div></pre></td></tr></table></figure></p><p>这样，body中就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">username=bob&amp;pwd=123</div></pre></td></tr></table></figure></p><p>等同于<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> ~/ curl -d "username=bob&amp;pwd=123" "http://requestb.in/1g31nxf1"</div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><p>我们还可以先把body数据写入<code>文件</code>中，然后使用-d发出去，如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> ~/ cat post.data</div><div class="line">&#123;"data":"json"&#125;</div><div class="line"> ~/ curl -d @post.data "http://requestb.in/1g31nxf1"</div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><p>我们拿到的body是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;data&quot;:&quot;json&quot;&#125;</div></pre></td></tr></table></figure></p><p>换一个内容：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> ~/ cat post.data</div><div class="line">username=cat&amp;pwd=123</div><div class="line"> ~/ curl -d @post.data "http://requestb.in/1g31nxf1"</div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><p>拿到的body是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">username=cat&amp;pwd=123</div></pre></td></tr></table></figure></p><p>也就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pwd: 123</div><div class="line">username: cat</div></pre></td></tr></table></figure></p><h3 id="4-添加头信息"><a href="#4-添加头信息" class="headerlink" title="4.添加头信息"></a>4.添加头信息</h3><p>使用<code>-H</code>或者<code>--header</code>来添加头信息，注意使用<code>:</code>连接key和value。<br>例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> ~/ curl -d @post.data "http://requestb.in/1g31nxf1" -H "Content-Type:application/json" -H "Accept:gzip"</div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><h3 id="5-HEAD"><a href="#5-HEAD" class="headerlink" title="5.HEAD"></a>5.HEAD</h3><p>使用<code>-I</code>会发送HEAD请求，只会获取头信息。<br>例如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> ~/ curl -I "http://requestb.in/1g31nxf1"</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Connection: keep-alive</div><div class="line">Server: gunicorn/19.3.0</div><div class="line">Date: Thu, 03 Mar 2016 11:20:59 GMT</div><div class="line">Content-Type: text/html; charset=utf-8</div><div class="line">Content-Length: 2</div><div class="line">Sponsored-By: https://www.runscope.com</div><div class="line">Via: 1.1 vegur</div></pre></td></tr></table></figure></p><p>可以在request.bin上看到发送了HEAD请求。</p><p>如果是在发送GET或者POST请求是看返回的头信息，可以使用<code>-i</code>参数。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> ~/ curl -i -d "username=bob&amp;pwd=123" "http://requestb.in/1g31nxf1" -H "Content-Type:application/json" -H "Accept:gzip"</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Connection: keep-alive</div><div class="line">Server: gunicorn/19.3.0</div><div class="line">Date: Thu, 03 Mar 2016 11:20:25 GMT</div><div class="line">Content-Type: text/html; charset=utf-8</div><div class="line">Content-Length: 2</div><div class="line">Sponsored-By: https://www.runscope.com</div><div class="line">Via: 1.1 vegur</div><div class="line"></div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><p>可以看到，会发送POST请求，同时看到了返回的头信息。</p><h3 id="6-PUT"><a href="#6-PUT" class="headerlink" title="6.PUT"></a>6.PUT</h3><p>使用<code>-T</code>会发送PUT请求上传文件。<br>例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> ~/ curl -T post.data "http://requestb.in/1g31nxf1"</div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><p>可以在request.bin上看到发送了PUT请求，body是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">username=cat&amp;pwd=123</div></pre></td></tr></table></figure></p><h3 id="7-Cookie"><a href="#7-Cookie" class="headerlink" title="7.Cookie"></a>7.Cookie</h3><p>使用<code>-b</code>参数设置cookie信息。<br>例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> ~/ curl -b "key=213;role=0" "http://requestb.in/1g31nxf1"</div><div class="line"><span class="meta">ok%</span></div></pre></td></tr></table></figure></p><p>注意，使用<code>=</code>连接key和value，然后使用<code>;</code>分隔多个cookie。</p><h3 id="8-输出相应参数"><a href="#8-输出相应参数" class="headerlink" title="8.输出相应参数"></a>8.输出相应参数</h3><p>使用<code>-w</code>可以输出相应变量的参数。<br>例如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> ~/ curl -w "\ntime_connect: %&#123;time_connect&#125;\ntime_starttransfer: %&#123;time_starttransfer&#125;\ntime_total: %&#123;time_total&#125;\n" "http://requestb.in/1g31nxf1"</div><div class="line">ok</div><div class="line">time_connect: 0.324</div><div class="line">time_starttransfer: 0.670</div><div class="line">time_total: 0.670</div></pre></td></tr></table></figure></p><h3 id="9-使用代理"><a href="#9-使用代理" class="headerlink" title="9.使用代理"></a>9.使用代理</h3><p>假如代理服务器ip是125.86.166.89，端口是23564，类型是https，那么使用代理发送GET请求：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -x "https://125.86.166.89:23564" "http://www.baidu.com"</div></pre></td></tr></table></figure></p><p>默认是使用http协议。<br>有时候代理需要加认证，需要携带头信息：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -x "60.184.111.104:766" -H "Proxy-Authorization:Basic ZGFtb240dTEyM0AxNjMuY29tOlJGdk56SHZ2VVY2N2F1" "http://www.baidu.com"</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;curl命令可以方便的调试接口，发送网络请求。&lt;/p&gt;
    
    </summary>
    
      <category term="shell" scheme="https://damon4u.github.io/categories/shell/"/>
    
    
      <category term="shell" scheme="https://damon4u.github.io/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>Java泛型</title>
    <link href="https://damon4u.github.io//blog/2018/08/%E6%B3%9B%E5%9E%8B.html"/>
    <id>https://damon4u.github.io//blog/2018/08/泛型.html</id>
    <published>2018-08-24T08:41:50.000Z</published>
    <updated>2018-08-29T13:00:53.340Z</updated>
    
    <content type="html"><![CDATA[<p>Java范型有点类似与C++中的模板类或者模板方法，对类型进行抽象。</p><a id="more"></a><h3 id="1-泛型是什么"><a href="#1-泛型是什么" class="headerlink" title="1. 泛型是什么"></a>1. 泛型是什么</h3><p>举一个JDK中的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ArrayList&lt;String&gt; strList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">ArrayList&lt;Integer&gt; intList = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">ArrayList&lt;Double&gt; doubleList = <span class="keyword">new</span> ArrayList&lt;Double&gt;();</div></pre></td></tr></table></figure></p><p>这里创建了三个List，分别存储String、Integer和Double。<br>在调用List的<code>add</code>和<code>get</code>方法时，会对类型进行检查。<br>这里ArrayList将内存存储的类型参数化，各种类型的变量都可以组装成对应的List，而不必针对每个类型分别实现一个构建ArrayList的类。</p><h3 id="2-没有泛型会怎样"><a href="#2-没有泛型会怎样" class="headerlink" title="2. 没有泛型会怎样"></a>2. 没有泛型会怎样</h3><p>我们实现两个能够设置点坐标的类，分别设置Integer类型的点坐标和Float类型的点坐标：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//设置Integer类型的点坐标</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntegerPoint</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Integer x ;       <span class="comment">// 表示X坐标</span></div><div class="line">    <span class="keyword">private</span> Integer y ;       <span class="comment">// 表示Y坐标</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setX</span><span class="params">(Integer x)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.x = x ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setY</span><span class="params">(Integer y)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.y = y ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getX</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.x ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getY</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.y ;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//设置Float类型的点坐标</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FloatPoint</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Float x ;       <span class="comment">// 表示X坐标</span></div><div class="line">    <span class="keyword">private</span> Float y ;       <span class="comment">// 表示Y坐标</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setX</span><span class="params">(Float x)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.x = x ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setY</span><span class="params">(Float y)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.y = y ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Float <span class="title">getX</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.x ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Float <span class="title">getY</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.y ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>那现在有个问题：大家有没有发现，他们除了变量类型不一样，一个是Integer一个是Float以外，其它并没有什么区别！那我们能不能合并成一个呢？<br>答案是可以的，因为Integer和Float都是派生自Object的，我们用下面这段代码代替：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectPoint</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Object x ;</div><div class="line">    <span class="keyword">private</span> Object y ;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setX</span><span class="params">(Object x)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.x = x ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setY</span><span class="params">(Object y)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.y = y ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getX</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.x ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getY</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.y ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>即全部都用Object来代替所有的子类；<br>在使用的时候是这样的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ObjectPoint integerPoint = <span class="keyword">new</span> ObjectPoint();</div><div class="line">integerPoint.setX(<span class="keyword">new</span> Integer(<span class="number">100</span>));</div><div class="line">Integer integerX=(Integer)integerPoint.getX();</div><div class="line"></div><div class="line">ObjectPoint floatPoint = <span class="keyword">new</span> ObjectPoint();</div><div class="line">floatPoint.setX(<span class="keyword">new</span> Float(<span class="number">100.12f</span>));</div><div class="line">Float floatX = (Float)floatPoint.getX();</div></pre></td></tr></table></figure></p><p>特别注意取值时需要强制类型转换。<br>但问题来了：注意，注意，我们这里使用了强制转换，我们这里setX（）和getX（）写得很近，所以我们明确的知道我们传进去的是Float类型，那如果我们记错了呢？<br>比如我们改成下面这样，编译时会报错吗：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ObjectPoint floatPoint = <span class="keyword">new</span> ObjectPoint();</div><div class="line">floatPoint.setX(<span class="keyword">new</span> Float(<span class="number">100.12f</span>));</div><div class="line">String floatX = (String)floatPoint.getX();</div></pre></td></tr></table></figure></p><p>不会！！！我们问题的关键在于这句：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String floatX = (String)floatPoint.getX();</div></pre></td></tr></table></figure></p><p>强制转换时，编译不会出错。因为编译器也不知道你传进去的是什么，而floatPoint.getX()返回的类型是Object，所以编译时，将Object强转成String是成立的。必然不会报错。<br>而在运行时，则不然，在运行时，floatPoint实例中明明传进去的是Float类型的变量，非要把它强转成String类型，肯定会报类型转换错误的！<br>那有没有一种办法在编译阶段，即能合并成同一个，又能在编译时检查出来传进去类型不对呢？当然，这就是泛型。</p><h3 id="3-泛型类"><a href="#3-泛型类" class="headerlink" title="3. 泛型类"></a>3. 泛型类</h3><p>我们先看看泛型的类是怎么定义的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//定义</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>&lt;<span class="title">T</span>&gt;</span>&#123;<span class="comment">// 此处可以随便写标识符号</span></div><div class="line">    <span class="comment">//定义变量</span></div><div class="line">    <span class="keyword">private</span> T x ;      </div><div class="line">    <span class="keyword">private</span> T y ;      </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setX</span><span class="params">(T x)</span></span>&#123;<span class="comment">//作为参数</span></div><div class="line">        <span class="keyword">this</span>.x = x ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setY</span><span class="params">(T y)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.y = y ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getX</span><span class="params">()</span></span>&#123;<span class="comment">//作为返回值</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.x ;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getY</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.y ;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//IntegerPoint使用</span></div><div class="line">Point&lt;Integer&gt; p = <span class="keyword">new</span> Point&lt;Integer&gt;() ;</div><div class="line">p.setX(<span class="keyword">new</span> Integer(<span class="number">100</span>)) ;</div><div class="line">System.out.println(p.getX());  </div><div class="line"></div><div class="line"><span class="comment">//FloatPoint使用</span></div><div class="line">Point&lt;Float&gt; p = <span class="keyword">new</span> Point&lt;Float&gt;() ;</div><div class="line">p.setX(<span class="keyword">new</span> Float(<span class="number">100.12f</span>)) ;</div><div class="line">System.out.println(p.getX());</div></pre></td></tr></table></figure></p><p>上在我们只定义了一个泛型变量T，那如果我们需要传进去多个泛型要怎么办呢？<br>只需要在类似下面这样就可以了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MorePoint</span>&lt;<span class="title">T</span>,<span class="title">U</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T x;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> T y;       </div><div class="line"></div><div class="line">    <span class="keyword">private</span> U name;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setX</span><span class="params">(T x)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.x = x;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getX</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.x;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(U name)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> U <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//使用</span></div><div class="line">MorePoint&lt;Integer,String&gt; morePoint = <span class="keyword">new</span> MorePoint&lt;Integer, String&gt;();</div><div class="line">morePoint.setName(<span class="string">"harvic"</span>);</div><div class="line">System.out.println(<span class="string">"morPont.getName:"</span> + morePoint.getName());</div></pre></td></tr></table></figure></p><h3 id="4-泛型接口"><a href="#4-泛型接口" class="headerlink" title="4. 泛型接口"></a>4. 泛型接口</h3><p>在接口上定义泛型与在类中定义泛型是一样的，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;        <span class="comment">// 在接口上定义泛型  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span> </span>; <span class="comment">// 定义抽象方法，抽象方法的返回值就是泛型类型  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T x)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="4-1-使用方法一：非泛型类"><a href="#4-1-使用方法一：非泛型类" class="headerlink" title="4.1 使用方法一：非泛型类"></a>4.1 使用方法一：非泛型类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InfoImpl</span> <span class="keyword">implements</span> <span class="title">Info</span>&lt;<span class="title">String</span>&gt;</span>&#123;<span class="comment">// 定义泛型接口的子类</span></div><div class="line">    <span class="keyword">private</span> String var ;<span class="comment">// 定义属性</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InfoImpl</span><span class="params">(String var)</span></span>&#123;<span class="comment">// 通过构造方法设置属性内容</span></div><div class="line">        <span class="keyword">this</span>.setVar(var) ;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(String var)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.var = var ;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getVar</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.var ;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo24</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">main</span><span class="params">(String arsg[])</span></span>&#123;</div><div class="line">        InfoImpl i = <span class="keyword">new</span> InfoImpl(<span class="string">"harvic"</span>);</div><div class="line">        System.out.println(i.getVar()) ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>要清楚的一点是InfoImpl不是一个泛型类！因为他类名后没有<t>！<br>然后在在这里我们将Info<string>中的泛型变量T定义填充为了String类型。所以在重写时setVar()和getVar()时，IDE会也我们直接生成String类型的重写函数。</string></t></p><h4 id="4-2-使用方法二：泛型类"><a href="#4-2-使用方法二：泛型类" class="headerlink" title="4.2 使用方法二：泛型类"></a>4.2 使用方法二：泛型类</h4><p>在方法一中，我们在类中直接把Info<t>接口给填充好了，但我们的类，是可以构造成泛型类的，那我们利用泛型类来构造填充泛型接口会是怎样呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;<span class="comment">// 在接口上定义泛型</span></div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span> </span>;<span class="comment">// 定义抽象方法，抽象方法的返回值就是泛型类型</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T var)</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InfoImpl</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;<span class="comment">// 定义泛型接口的子类</span></div><div class="line"><span class="keyword">private</span> T var ;<span class="comment">// 定义属性</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">InfoImpl</span><span class="params">(T var)</span></span>&#123;<span class="comment">// 通过构造方法设置属性内容</span></div><div class="line"><span class="keyword">this</span>.setVar(var) ;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T var)</span></span>&#123;</div><div class="line"><span class="keyword">this</span>.var = var ;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>.var ;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo24</span></span>&#123;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String arsg[])</span></span>&#123;</div><div class="line">InfoImpl&lt;String&gt; i = <span class="keyword">new</span> InfoImpl&lt;String&gt;(<span class="string">"harvic"</span>);</div><div class="line">System.out.println(i.getVar()) ;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></t></p><h3 id="5-泛型函数"><a href="#5-泛型函数" class="headerlink" title="5. 泛型函数"></a>5. 泛型函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticFans</span> </span>&#123;</div><div class="line"><span class="comment">//静态函数</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">StaticMethod</span><span class="params">(T a)</span></span>&#123;</div><div class="line">        Log.d(<span class="string">"harvic"</span>,<span class="string">"StaticMethod: "</span>+a.toString());</div><div class="line">    &#125;</div><div class="line"><span class="comment">//普通函数</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">OtherMethod</span><span class="params">(T a)</span></span>&#123;</div><div class="line">        Log.d(<span class="string">"harvic"</span>,<span class="string">"OtherMethod: "</span>+a.toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>上面分别是静态泛型函数和常规泛型函数的定义方法，与以往方法的唯一不同点就是在返回值前加上<t>来表示泛型变量。其它没什么区别。<br>使用方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//静态方法</span></div><div class="line">StaticFans.StaticMethod(<span class="string">"adfdsa"</span>);<span class="comment">//使用方法一</span></div><div class="line">StaticFans.&lt;String&gt;StaticMethod(<span class="string">"adfdsa"</span>);<span class="comment">//使用方法二</span></div><div class="line"></div><div class="line"><span class="comment">//常规方法</span></div><div class="line">StaticFans staticFans = <span class="keyword">new</span> StaticFans();</div><div class="line">staticFans.OtherMethod(<span class="keyword">new</span> Integer(<span class="number">123</span>));<span class="comment">//使用方法一</span></div><div class="line">staticFans.&lt;Integer&gt;OtherMethod(<span class="keyword">new</span> Integer(<span class="number">123</span>));<span class="comment">//使用方法二</span></div></pre></td></tr></table></figure></t></p><h3 id="6-使用Class传递泛型类Class对象"><a href="#6-使用Class传递泛型类Class对象" class="headerlink" title="6. 使用Class传递泛型类Class对象"></a>6. 使用Class<t>传递泛型类Class对象</t></h3><p>有时，我们会遇到一个情况，比如，我们在使用JSON解析字符串的时候，代码一般是这样的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;SuccessModel&gt; <span class="title">parseArray</span><span class="params">(String response)</span></span>&#123;</div><div class="line">    List&lt;SuccessModel&gt; modelList = JSON.parseArray(response, SuccessModel.class);</div><div class="line">    <span class="keyword">return</span> modelList;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>这段代码的意义就是根据SuccessModel解析出List<successmodel>的数组。<br>那现在，我们把下面这句组装成一个泛型函数要怎么来做呢?<br>首先，我们应该把SuccessModel单独抽出来做为泛型变量，但parseArray()中用到的SuccessModel.class要怎么弄呢？<br>先来看代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">parseArray</span><span class="params">(String response, Class&lt;T&gt; object)</span></span>&#123;</div><div class="line">    List&lt;T&gt; modelList = JSON.parseArray(response, object);</div><div class="line">    <span class="keyword">return</span> modelList;</div><div class="line">&#125;</div></pre></td></tr></table></figure></successmodel></p><p>注意到，我们用的Class<t> object来传递类的class对象，即我们上面提到的SuccessModel.class。<br>这是因为Class<t>也是一泛型，它是传来用来装载类的class对象的，它的定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Instances of the class &#123;<span class="doctag">@code</span> Class&#125; represent classes and</span></div><div class="line"><span class="comment"> * interfaces in a running Java application.  An enum is a kind of</span></div><div class="line"><span class="comment"> * class and an annotation is a kind of interface.  Every array also</span></div><div class="line"><span class="comment"> * belongs to a class that is reflected as a &#123;<span class="doctag">@code</span> Class&#125; object</span></div><div class="line"><span class="comment"> * that is shared by all arrays with the same element type and number</span></div><div class="line"><span class="comment"> * of dimensions.  The primitive Java types (&#123;<span class="doctag">@code</span> boolean&#125;,</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> byte&#125;, &#123;<span class="doctag">@code</span> char&#125;, &#123;<span class="doctag">@code</span> short&#125;,</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> int&#125;, &#123;<span class="doctag">@code</span> long&#125;, &#123;<span class="doctag">@code</span> float&#125;, and</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> double&#125;), and the keyword &#123;<span class="doctag">@code</span> void&#125; are also</span></div><div class="line"><span class="comment"> * represented as &#123;<span class="doctag">@code</span> Class&#125; objects.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Class</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></t></t></p><h3 id="7-类型绑定"><a href="#7-类型绑定" class="headerlink" title="7. 类型绑定"></a>7. 类型绑定</h3><p>有时候，我们在泛型类或者泛型函数中希望泛型参数能够是某个接口的实现，这样我们可以调用接口方法。</p><h4 id="7-1-extends"><a href="#7-1-extends" class="headerlink" title="7.1 extends"></a>7.1 extends</h4><p>有时候，你会希望泛型类型只能是某一部分类型，比如操作数据的时候，你会希望是Number或其子类类型。这个想法其实就是给泛型参数添加一个界限。其定义形式为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;T extends BoundingType&gt;</div></pre></td></tr></table></figure></p><p>此定义表示T应该是BoundingType的子类型（subtype）。T和BoundingType可以是类，也可以是接口。另外注意的是，此处的”extends“表示的子类型，不等同于继承。<br>一定要非常注意的是，这里的extends不是类继承里的那个extends！两个根本没有任何关联。在这里extends后的BoundingType可以是类，也可以是接口，意思是说，T是在BoundingType基础上创建的，具有BoundingType的功能。目测是Java的开发人员不想再引入一个关键字，所以用已有的extends来代替而已。<br>我们假设，我们有很多种类的水果，需要写一个函数，打印出填充进去水果的名字：<br>为此，我们先建一个基类来设置和提取名字：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fruit</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>然后写个泛型函数来提取名字：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Fruit&gt; <span class="function">String <span class="title">getFruitName</span><span class="params">(T t)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> t.getName();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>从这段代码也可以看出，类型绑定有两个作用：</p><ol><li>对填充的泛型加以限定</li><li>使用泛型变量T时，可以使用BoundingType内部的函数。</li></ol><p>有关绑定限定的用法，其实我们可以同时绑定多个绑定,用&amp;连接，比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Fruit &amp; Serializable&gt; <span class="function">String <span class="title">getFruitName</span><span class="params">(T t)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> t.getName();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="7-2-通配符"><a href="#7-2-通配符" class="headerlink" title="7.2 通配符"></a>7.2 通配符</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Point&lt;?&gt; point;</div><div class="line"></div><div class="line">point = <span class="keyword">new</span> Point&lt;Integer&gt;(<span class="number">3</span>,<span class="number">3</span>);</div><div class="line">point = <span class="keyword">new</span> Point&lt;Float&gt;(<span class="number">4.3f</span>,<span class="number">4.3f</span>);</div><div class="line">point = <span class="keyword">new</span> Point&lt;Double&gt;(<span class="number">4.3</span>d,<span class="number">4.90</span>d);</div><div class="line">point = <span class="keyword">new</span> Point&lt;Long&gt;(<span class="number">12l</span>,<span class="number">23l</span>);</div></pre></td></tr></table></figure><p>无边界通配符<code>?</code>则只能用于填充泛型变量T，表示通配任何类型！！！！再重复一遍：？只能用于填充泛型变量T。它是用来填充T的！！！！只是填充方式的一种！！！<br>构造泛型实例时，如果省略了填充类型，则默认填充为无边界通配符！如下写法是对等的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Point point3 = <span class="keyword">new</span> Point(<span class="keyword">new</span> Integer(<span class="number">23</span>),<span class="keyword">new</span> Integer(<span class="number">23</span>));</div><div class="line">Point&lt;?&gt; point3 = <span class="keyword">new</span> Point(<span class="keyword">new</span> Integer(<span class="number">23</span>),<span class="keyword">new</span> Integer(<span class="number">23</span>));</div></pre></td></tr></table></figure></p><h5 id="7-2-1-通配符？的extends绑定"><a href="#7-2-1-通配符？的extends绑定" class="headerlink" title="7.2.1 通配符？的extends绑定"></a>7.2.1 通配符？的extends绑定</h5><p>从上面我们可以知道通配符？可以代表任意类型，但跟泛型一样，如果不加以限定，在后期的使用中编译器可能不会报错。所以我们同样，要对？加以限定。<br>同样，通配符<code>?</code>可以用extends绑定范围。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Point&lt;? extends Number&gt; point;</div></pre></td></tr></table></figure></p><p>此时，当将T填充为String和Object时，赋值给point就会报错！<br>这里虽然是指派生自Number的任意类型，但new Point<number>();也是可以成功赋值的，这说明包括边界自身。<br>再重复一遍：无边界通配符只是泛型T的填充方式，给他加上限定，只是限定了赋值给它（比如这里的point）的实例类型。<br>如果想从根本上解决乱填充Point的问题，需要从Point泛型类定义时加上<t extends="" number="">:</t></number></p><p>注意：利用&lt;? extends Number&gt;定义的变量，只可取其中的值，不可修改。<br>正因为point的类型为 Point&lt;? extends Number&gt; point，那也就是说，填充Point的泛型变量T的为&lt;? extends Number&gt;，这是一个什么类型？未知类型！！！怎么可能能用一个未知类型来设置内部值！这完全是不合理的。也就是说，它可能是Integer，也可能是Float，那么就不能往里面写数据。<br>但取值时，正由于泛型变量T被填充为&lt;? extends Number&gt;，所以编译器能确定的是T肯定是Number的子类，编译器就会用Number来填充T。</p><h5 id="7-2-2-通配符？的super绑定"><a href="#7-2-2-通配符？的super绑定" class="headerlink" title="7.2.2 通配符？的super绑定"></a>7.2.2 通配符？的super绑定</h5><p>如果说 &lt;? extends XXX&gt;指填充为派生于XXX的任意子类的话，那么&lt;? super XXX&gt;则表示填充为任意XXX的父类！<br>我们先写三个类，Employee,Manager,CEO,分别代表工人，管理者，CEO<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CEO</span> <span class="keyword">extends</span> <span class="title">Manager</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span> <span class="keyword">extends</span> <span class="title">Employee</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>然后，如果我这样生成一个变量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">List&lt;? <span class="keyword">super</span> Manager&gt; list;</div></pre></td></tr></table></figure></p><p>它表示的意思是将泛型T填充为&lt;? super Manager&gt;，即任意Manager的父类；也就是说任意将List<t>中的泛型变量T填充为Manager父类的List变量，都可以赋值给list。<br>new ArrayList<employee>()，new ArrayList<manager>()都是正确的，而new ArrayList<ceo>()却报错，当然是因为CEO类已经不再是Manager的父类了。所以会报编译错误。</ceo></manager></employee></t></p><p>注意：super通配符实例内容：能存不能取。<br>由于list是List&lt;? super Manager&gt;类型，那么list中可以填充Manager和Manager的子类，它们一定是&lt;? super Manager&gt;的子类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">list.add(<span class="keyword">new</span> Employee()); <span class="comment">//编译错误</span></div></pre></td></tr></table></figure></p><p>但是想添加Employee是不可以的，因为Employee不一定是&lt;? super Manager&gt;的子类。比如用Manager填充了T。<br>而从list中取出来的数据是Object类型的，需要强制类型转换。<br>总结 ? extends 和 the ? super 通配符的特征，我们可以得出以下结论：</p><ul><li>如果你想从一个数据类型里获取数据，使用 ? extends 通配符（能取不能存）</li><li>如果你想把对象写入一个数据结构里，使用 ? super 通配符（能存不能取）</li><li>如果你既想存，又想取，那就别用通配符。</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Java范型有点类似与C++中的模板类或者模板方法，对类型进行抽象。&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="https://damon4u.github.io/categories/java/"/>
    
    
      <category term="java" scheme="https://damon4u.github.io/tags/java/"/>
    
  </entry>
  
</feed>
